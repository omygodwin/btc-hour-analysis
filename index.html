<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC Hourly Analysis Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600&family=Roboto+Mono:wght@400;500;600&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a24;
      --bg-solid: #0d0d12;
      --border-subtle: rgba(255, 255, 255, 0.08);
      --border-medium: rgba(255, 255, 255, 0.15);
      --border-hour: rgba(247, 147, 26, 0.5);
      --text-primary: #e8e8e8;
      --text-secondary: #a0a0a0;
      --text-muted: #666;
      --accent-btc: #f7931a;
      --accent-btc-dim: rgba(247, 147, 26, 0.2);
      --accent-blue: #6495ed;
      --accent-green: #4ade80;
      --accent-red: #f87171;
      --accent-purple: #a78bfa;
      --accent-orange: #fb923c;
      --font-size: 10px;
      --font-family: 'JetBrains Mono', monospace;
    }
    
    /* Tooltip styles */
/* HIDE SPECIFIC TOOLBAR FILTER BUTTONS ON MOBILE */
@media (max-width:768px){
  .mobile-hide{display:none !important;}
}

    
    /* Improved Info Tooltip (supports hover on desktop, click-to-toggle on mobile) */
    .info-tooltip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      font-size: 11px;
      border-radius: 50%;
      background: rgba(100,149,237,0.12);
      color: var(--accent-blue);
      cursor: pointer;
      margin-left: 6px;
      flex-shrink: 0;
      border: 1px solid rgba(100,149,237,0.15);
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
    }
    .info-tooltip svg { width:12px;height:12px;display:block; }
    /* Popup content (hidden by default). On hover for pointer devices, show via :hover.
       On mobile, JS toggles the 'visible' class. */
    .info-popup {
      display: none;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(20,20,30,0.98) 0%, rgba(15,15,20,0.98) 100%);
      border: 1px solid var(--border-medium);
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 12px;
      white-space: pre-line;
      z-index: 1200;
      min-width: 180px;
      max-width: 260px;
      color: var(--text-primary);
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
      pointer-events: auto;
    }
    .info-tooltip:hover .info-popup { display: block; }
    .info-popup.visible { display: block; }
    .info-popup .popup-title { font-weight:700; margin-bottom:6px; color:var(--accent-btc); font-size:13px;}
    .info-popup .popup-body { color:var(--text-secondary); font-size:12px; line-height:1.2; }
    /* make sure popup flips above if near top edge */
    .info-popup.top { bottom: auto; top: calc(100% + 8px); transform: translateX(-50%); }

    /* Info Button styles - Redesigned: small, modern, top-right positioned */
    .info-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 16px;
      height: 16px;
      padding: 12px;
      margin: -12px;
      font-size: 10px;
      opacity: 0.5;
      cursor: pointer;
      border-radius: 50%;
      background: rgba(100, 149, 237, 0.1);
      color: #6495ed;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      border: none;
      line-height: 1;
      flex-shrink: 0;
    }
    .info-btn:hover {
      opacity: 0.8;
      background: rgba(100, 149, 237, 0.2);
    }
    .info-btn:active {
      opacity: 1;
      transform: scale(0.95);
    }
    /* Mobile: even smaller visual size */
    @media (max-width: 768px) {
      .info-btn {
        width: 14px;
        height: 14px;
        font-size: 9px;
        padding: 13px;
        margin: -13px;
        top: 2px;
        right: 2px;
      }
    }

    /* Info Panel styles */
    .info-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(180deg, rgba(20,20,30,0.98) 0%, rgba(15,15,20,0.98) 100%);
      border: 1px solid var(--border-medium);
      border-radius: 12px;
      padding: 20px;
      min-width: 300px;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 10000;
      box-shadow: 0 12px 48px rgba(0,0,0,0.8);
      color: var(--text-primary);
      font-family: var(--font-family);
    }
    .info-header {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-purple);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-medium);
    }
    .info-body {
      font-size: 12px;
    }
    .info-section {
      margin-top: 12px;
      font-size: 11px;
      color: var(--accent-btc);
    }
    .info-section:first-child {
      margin-top: 0;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      color: var(--text-secondary);
      font-size: 11px;
    }
    .info-row span {
      color: var(--text-primary);
      font-weight: 500;
    }
    .info-row .up {
      color: var(--accent-green);
    }
    .info-row .down {
      color: var(--accent-red);
    }
    .info-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .info-close:hover {
      background: rgba(255,255,255,0.2);
    }
    /* Mobile optimizations */
    @media (max-width: 768px) {
      .info-panel {
        max-width: 90vw;
        max-height: 70vh;
        padding: 16px;
        -webkit-overflow-scrolling: touch;
      }
      .info-header {
        font-size: 13px;
      }
      .info-section {
        font-size: 10px;
      }
      .info-row {
        font-size: 10px;
      }
    }

    body {
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-primary) 100%);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    
    html { height: 100vh; overflow: hidden; }
    
    .upload-screen { height: 100vh; display: flex; align-items: center; justify-content: center; overflow: auto; }
    
    .upload-card {
      text-align: center; padding: 48px;
      background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px; max-width: 450px;
    }
    
    .btc-logo {
      font-size: 4.5rem;
      background: linear-gradient(135deg, #f7931a, #ffc73b);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; margin-bottom: 16px;
    }
    
    .upload-card h1 { color: var(--accent-btc); font-size: 1.8rem; margin-bottom: 8px; font-family: 'JetBrains Mono', monospace; }
    .upload-card > p { color: #888; font-size: 0.9rem; margin-bottom: 32px; }
    
    .upload-btn {
      display: inline-flex; align-items: center; gap: 12px; padding: 16px 32px;
      background: linear-gradient(135deg, #f7931a, #e8820e); border: none; border-radius: 12px;
      color: #fff; font-size: 1.1rem; font-weight: 600; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(247,147,26,0.35); }
    
    .format-info { margin-top: 36px; padding-top: 28px; border-top: 1px solid rgba(255,255,255,0.08); text-align: left; }
    .format-info h3 { color: #aaa; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
    .format-info code { display: block; padding: 12px 16px; background: rgba(0,0,0,0.4); border-radius: 8px; font-size: 0.85rem; color: var(--accent-blue); font-family: 'JetBrains Mono', monospace; }
    
    .error-msg { color: var(--accent-red); margin-top: 20px; font-size: 0.9rem; padding: 12px; background: rgba(248, 113, 113, 0.1); border-radius: 8px; }
    
    .spinner { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--accent-btc); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .app { display: none; height: 100vh; flex-direction: column; overflow: hidden; min-height: 0; }
    .app.visible { display: flex; }
    
    .tab-nav { display: flex; background: var(--bg-secondary); border-bottom: 1px solid var(--border-medium); flex-shrink: 0; }
    .tab-btn { padding: 10px 24px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-size: 0.8rem; font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.2s; }
    .tab-btn:hover { color: var(--text-secondary); background: rgba(255,255,255,0.03); }
    .tab-btn.active { color: var(--accent-btc); border-bottom-color: var(--accent-btc); background: rgba(247,147,26,0.08); }
    
    .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; min-height: 0; }
    .tab-content.active { display: flex; }
    
    .header { display: flex; justify-content: space-between; align-items: center; padding: 6px 16px; background: linear-gradient(180deg, rgba(247,147,26,0.12) 0%, var(--bg-primary) 100%); border-bottom: 1px solid rgba(247,147,26,0.25); flex-shrink: 0; }
    .header h1 { font-family: 'JetBrains Mono', monospace; font-size: 1rem; color: var(--accent-btc); display: flex; align-items: center; gap: 6px; }
    .btc-sym { font-size: 1.2rem; background: linear-gradient(135deg, #f7931a, #ffc73b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .sub { display: block; font-size: 0.55rem; color: var(--text-muted); margin-top: 1px; }

    /* Live Indicator */
    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      background: rgba(74, 222, 128, 0.1);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 12px;
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--accent-green);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      margin-left: 12px;
    }
    .live-indicator:hover {
      background: rgba(74, 222, 128, 0.2);
      border-color: rgba(74, 222, 128, 0.5);
      transform: scale(1.05);
    }
    .live-indicator:active {
      transform: scale(0.95);
    }
    .live-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @media (max-width: 768px) {
      .live-indicator {
        font-size: 0.55rem;
        padding: 2px 6px;
        gap: 4px;
        margin-left: 8px;
      }
      .live-indicator::before {
        width: 6px;
        height: 6px;
      }
    }

    @media (max-width: 480px) {
      .live-indicator {
        font-size: 0.5rem;
        padding: 2px 5px;
        gap: 3px;
        margin-left: 6px;
      }
      .live-indicator::before {
        width: 5px;
        height: 5px;
      }
    }

    .header-stats { display: flex; gap: 8px; }
    .stat { display: flex; flex-direction: column; align-items: center; padding: 4px 10px; background: rgba(255,255,255,0.04); border-radius: 5px; border: 1px solid var(--border-medium); }
    .stat-val { font-family: var(--font-family); font-size: 0.85rem; font-weight: 600; color: var(--accent-btc); }
    .stat-lbl { font-size: 0.45rem; text-transform: uppercase; color: var(--text-muted); }
    
    .toolbar { display: none; } /* Hidden - filters now in floating button */

    /* Hide all desktop filter panels - now accessed via floating button */
    #filters-panel,
    #col-filter-panel,
    #dt-col-selector,
    #col-selector,
    #rsi-settings,
    .filters,
    .col-selector,
    .dt-col-selector,
    .col-filter-panel,
    .rsi-settings {
      display: none;
    }
    
    .tb-btn { display: flex; align-items: center; gap: 3px; padding: 3px 7px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-medium); border-radius: 3px; color: var(--text-secondary); font-size: 0.6rem; font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.15s; }
    .tb-btn:hover { background: rgba(255,255,255,0.08); color: var(--text-primary); }
    .tb-btn.active { background: var(--accent-btc-dim); border-color: rgba(247,147,26,0.4); color: var(--accent-btc); }
    .tb-btn.preset { background: rgba(100,149,237,0.1); border-color: rgba(100,149,237,0.25); color: var(--accent-blue); }
    .tb-btn.new-file { background: rgba(139,92,246,0.12); border-color: rgba(139,92,246,0.3); color: #a78bfa; }
    .tb-btn.filter-btn { background: rgba(74,222,128,0.1); border-color: rgba(74,222,128,0.25); color: var(--accent-green); }
    .tb-btn.filter-btn.has-filters { background: rgba(74,222,128,0.25); border-color: rgba(74,222,128,0.5); }
    
    .tb-spacer { flex: 1; }
    
    .tb-group { display: flex; align-items: center; gap: 3px; padding: 0 5px; border-left: 1px solid var(--border-medium); }
    .tb-group label { font-size: 0.55rem; color: var(--text-muted); }
    .tb-group select, .tb-group input { padding: 2px 4px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-medium); border-radius: 2px; color: var(--text-primary); font-family: var(--font-family); font-size: 0.6rem; }
    .tb-group input[type="number"] { width: 50px; }
    
    .filters { display: none; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; padding: 10px 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; }
    .filters.visible { display: grid; }
    
    .filter-group h3 { font-size: 0.52rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 5px; font-weight: 500; }
    .filter-btns { display: flex; flex-wrap: wrap; gap: 2px; }
    
    .f-btn { padding: 2px 5px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-medium); border-radius: 2px; color: var(--text-muted); font-size: 0.55rem; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s; }
    .f-btn:hover { background: rgba(255,255,255,0.08); }
    .f-btn.active { background: var(--accent-btc-dim); border-color: rgba(247,147,26,0.4); color: var(--accent-btc); }
    .f-btn.quick { background: rgba(100,149,237,0.1); border-color: rgba(100,149,237,0.2); color: var(--accent-blue); }
    .f-btn.none-btn { background: rgba(248,113,113,0.1); border-color: rgba(248,113,113,0.25); color: var(--accent-red); }
    
    .range-row { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; }
    .range-row label { display: flex; align-items: center; gap: 2px; font-size: 0.6rem; color: var(--text-muted); }
    .range-row select { padding: 2px 4px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-medium); border-radius: 2px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; }
    
    .hour-presets { display: flex; gap: 2px; }
    .hour-presets button { padding: 2px 5px; background: rgba(100,149,237,0.1); border: 1px solid rgba(100,149,237,0.2); border-radius: 2px; color: var(--accent-blue); font-size: 0.5rem; cursor: pointer; }
    
    .date-picker-btn { padding: 3px 6px; background: rgba(255,255,255,0.04); border: 1px solid var(--border-medium); border-radius: 2px; color: var(--text-secondary); font-size: 0.6rem; cursor: pointer; }
    
    .date-picker-dropdown { display: none; position: absolute; top: 100%; left: 0; z-index: 100; background: var(--bg-tertiary); border: 1px solid var(--border-medium); border-radius: 5px; padding: 8px; max-height: 250px; overflow-y: auto; min-width: 260px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
    .date-picker-dropdown.visible { display: block; }
    
    .date-picker-actions { display: flex; gap: 3px; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid var(--border-subtle); }
    .date-picker-actions button { padding: 2px 6px; background: rgba(100,149,237,0.1); border: 1px solid rgba(100,149,237,0.2); border-radius: 2px; color: var(--accent-blue); font-size: 0.55rem; cursor: pointer; }
    
    .date-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
    .date-item { padding: 2px 4px; background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 2px; font-size: 0.55rem; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); cursor: pointer; text-align: center; }
    .date-item.selected { background: var(--accent-btc-dim); border-color: rgba(247,147,26,0.4); color: var(--accent-btc); }
    
    /* Column Filter Panel */
    .col-filter-panel { display: none; padding: 10px 16px; background: rgba(74,222,128,0.05); border-bottom: 1px solid rgba(74,222,128,0.2); flex-shrink: 0; }
    .col-filter-panel.visible { display: block; }
    .col-filter-panel h3 { font-size: 0.55rem; text-transform: uppercase; color: var(--accent-green); margin-bottom: 8px; }
    
    .active-filters { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
    .filter-tag { display: flex; align-items: center; gap: 4px; padding: 3px 8px; background: rgba(74,222,128,0.15); border: 1px solid rgba(74,222,128,0.3); border-radius: 3px; font-size: 0.55rem; color: var(--accent-green); }
    .filter-tag .remove-filter { cursor: pointer; color: var(--accent-red); font-weight: bold; }
    
    .add-filter-row { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .add-filter-row select, .add-filter-row input { padding: 3px 6px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-medium); border-radius: 3px; color: var(--text-primary); font-size: 0.6rem; font-family: 'JetBrains Mono', monospace; }
    .add-filter-row input[type="number"] { width: 80px; }
    .add-filter-row button { padding: 3px 10px; background: rgba(74,222,128,0.2); border: 1px solid rgba(74,222,128,0.4); border-radius: 3px; color: var(--accent-green); font-size: 0.6rem; cursor: pointer; }
    
    .col-selector { display: none; padding: 10px 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-subtle); flex-shrink: 0; }
    .col-selector.visible { display: block; }
    .col-selector h3 { font-size: 0.52rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; }
    
    .col-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 2px; margin-bottom: 8px; }
    .col-item { display: flex; align-items: center; gap: 4px; padding: 3px 5px; background: rgba(255,255,255,0.02); border-radius: 2px; cursor: pointer; font-size: 0.6rem; }
    .col-item:hover { background: rgba(255,255,255,0.06); }
    .col-item input { accent-color: var(--accent-btc); cursor: pointer; }
    .col-item .col-label { font-weight: 500; color: var(--text-primary); }
    .col-item .col-desc { font-size: 0.5rem; color: var(--text-muted); margin-left: auto; }
    
    .col-presets { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }
    .col-presets button { padding: 2px 6px; background: rgba(100,149,237,0.1); border: 1px solid rgba(100,149,237,0.18); border-radius: 2px; color: var(--accent-blue); font-size: 0.55rem; cursor: pointer; }
    
    .option-toggle { margin-left: 10px; padding-left: 10px; border-left: 1px solid var(--border-medium); display: flex; align-items: center; gap: 4px; }
    .option-toggle label { font-size: 0.55rem; color: var(--text-muted); }
    .option-toggle select { padding: 2px 4px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-medium); border-radius: 2px; color: var(--text-primary); font-size: 0.55rem; }
    
    /* Day Totals Column Selector */
    .dt-col-selector { display: none; padding: 8px 16px; background: rgba(100,149,237,0.05); border-bottom: 1px solid rgba(100,149,237,0.2); flex-shrink: 0; }
    .dt-col-selector.visible { display: block; }
    .dt-col-selector h3 { font-size: 0.52rem; text-transform: uppercase; color: var(--accent-blue); margin-bottom: 6px; }
    .dt-col-grid { display: flex; flex-wrap: wrap; gap: 4px; }
    .dt-col-item { display: flex; align-items: center; gap: 3px; padding: 2px 6px; background: rgba(255,255,255,0.03); border-radius: 2px; font-size: 0.55rem; cursor: pointer; }
    .dt-col-item:hover { background: rgba(255,255,255,0.06); }
    .dt-col-item input { accent-color: var(--accent-blue); }
    
    /* RSI Settings Panel */
    .rsi-settings { display: none; padding: 8px 16px; background: rgba(167,139,250,0.05); border-bottom: 1px solid rgba(167,139,250,0.2); flex-shrink: 0; }
    .rsi-settings.visible { display: block; }
    .rsi-settings h3 { font-size: 0.52rem; text-transform: uppercase; color: var(--accent-purple); margin-bottom: 6px; }
    .rsi-settings-row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .rsi-settings-row label { font-size: 0.55rem; color: var(--text-muted); display: flex; align-items: center; gap: 3px; }
    .rsi-settings-row input, .rsi-settings-row select { padding: 2px 5px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-medium); border-radius: 2px; color: var(--text-primary); font-size: 0.55rem; }
    .rsi-settings-row input[type="number"] { width: 45px; }
    
    .table-container { flex: 1; overflow: auto; min-height: 0; }
    
    .data-table { width: max-content; border-collapse: separate; border-spacing: 0; font-family: var(--font-family); font-size: var(--font-size); }
    .data-table th, .data-table td { padding: 2px 3px; text-align: center; border: 1px solid var(--border-subtle); white-space: nowrap; }
    
    .hour-border-left { border-left: 2px solid var(--border-hour) !important; }
    
    .hour-row th { position: sticky; top: 0; z-index: 20; background: var(--bg-tertiary); }
    .col-row th { position: sticky; top: 18px; z-index: 20; background: var(--bg-secondary); cursor: pointer; }
    .col-row th:hover { background: rgba(247,147,26,0.15); }
    .col-row th.sorted { background: rgba(247,147,26,0.25); color: var(--accent-btc); }
    
    .hour-header { background: linear-gradient(180deg, rgba(247,147,26,0.18) 0%, rgba(247,147,26,0.08) 100%) !important; color: var(--accent-btc); font-weight: 600; }
    .day-totals-header { background: linear-gradient(180deg, rgba(100,149,237,0.18) 0%, rgba(100,149,237,0.08) 100%) !important; color: var(--accent-blue); font-weight: 600; }
    
    .col-header { color: var(--text-muted); font-weight: 500; font-size: calc(var(--font-size) * 0.8); text-transform: uppercase; }
    
    .sticky-col { position: sticky; background: var(--bg-solid); z-index: 15; }
    .sticky-header { z-index: 25 !important; background: var(--bg-tertiary) !important; }
    .sticky-header-sub { z-index: 25 !important; background: var(--bg-secondary) !important; }
    
    .date-cell { font-weight: 600; color: var(--text-primary); text-align: left; background: var(--bg-solid) !important; }
    .day-cell, .occ-cell { color: var(--text-muted); background: var(--bg-solid) !important; }
    .day-total-cell { color: var(--text-secondary); }
    
    .pct-row td { background: rgba(100,149,237,0.08); font-weight: 500; font-size: calc(var(--font-size) * 0.9); }
    .pct-label { color: var(--accent-blue); font-weight: 600; }
    
    .data-cell { font-variant-numeric: tabular-nums; }
    .data-cell:hover { outline: 1px solid rgba(247,147,26,0.5); z-index: 5; position: relative; }
    
    .data-cell.up { color: #a7f3d0 !important; }
    .data-cell.down { color: #fecaca !important; }
    .data-cell.neutral { color: var(--text-muted) !important; }
    .data-cell.ob { color: #fbbf24 !important; font-weight: 600; }
    .data-cell.os { color: #60a5fa !important; font-weight: 600; }
    
    .legend { display: flex; justify-content: center; gap: 16px; padding: 6px; background: var(--bg-secondary); border-top: 1px solid var(--border-subtle); font-size: 0.55rem; flex-wrap: wrap; flex-shrink: 0; }
    .legend-item { display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
    .legend-grad { width: 35px; height: 6px; border-radius: 1px; }
    .grad-orange { background: linear-gradient(90deg, #0d0d12 0%, rgb(251,146,60) 100%); }
    .grad-rg { background: linear-gradient(90deg, rgb(248,113,113) 0%, #0d0d12 50%, rgb(74,222,128) 100%); }
    .grad-purple { background: linear-gradient(90deg, #0d0d12 0%, rgb(167,139,250) 100%); }
    
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: rgba(247,147,26,0.28); border-radius: 4px; }
    ::-webkit-scrollbar-corner { background: var(--bg-primary); }
    
    #file-input { display: none; }
    
    /* Day View Styles */
    .day-view-header { padding: 12px 16px; background: linear-gradient(180deg, rgba(247,147,26,0.15) 0%, var(--bg-primary) 100%); border-bottom: 1px solid rgba(247,147,26,0.3); flex-shrink: 0; }
    .day-view-title { font-family: 'JetBrains Mono', monospace; font-size: 1.2rem; color: var(--accent-btc); margin-bottom: 8px; }
    .day-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; max-width: 900px; }
    .day-stat-box { padding: 8px 12px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-medium); border-radius: 6px; text-align: center; }
    .day-stat-val { font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 600; color: var(--text-primary); }
    .day-stat-val.positive { color: var(--accent-green); }
    .day-stat-val.negative { color: var(--accent-red); }
    .day-stat-lbl { font-size: 0.55rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

    /* Collapsible Day View Header */
    .day-view-header-wrapper {
      display: flex;
      flex-direction: column;
    }
    .day-view-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .day-view-collapse-btn {
      display: none;
      background: rgba(255,255,255,0.1);
      border: 1px solid var(--border-medium);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      color: var(--text-primary);
      font-size: 1.2rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .day-view-collapse-btn:active {
      background: rgba(255,255,255,0.2);
    }
    .day-view-stats-collapsible {
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    @media (max-width: 768px) {
      .day-view-collapse-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .day-view-stats-collapsible.collapsed {
        max-height: 0;
        margin-top: 0 !important;
      }
      .day-view-collapse-btn.collapsed {
        transform: rotate(180deg);
      }
      /* Also hide toolbar when collapsed on mobile */
      .day-toolbar.collapsed {
        display: none;
      }
    }
    
    .day-toolbar { display: flex; gap: 8px; padding: 8px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); align-items: center; flex-wrap: wrap; flex-shrink: 0; }
    .day-toolbar label { font-size: 0.65rem; color: var(--text-muted); }
    .day-toolbar select { padding: 4px 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-medium); border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; min-width: 140px; }
    
    .day-table-container { flex: 1; overflow: auto; padding: 8px; min-height: 0; }
    .day-compare-container { display: flex; flex: 1; min-height: 0; gap: 4px; }
    .day-table-panel { flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden; }
    .day-table-panel .day-table-container { flex: 1; }
    .compare-mode .day-table-panel { border: 1px solid var(--border-medium); border-radius: 4px; }
    .compare-mode .day-table-panel:first-child { border-color: var(--accent-btc); }
    .compare-mode .day-table-panel:last-child { border-color: var(--accent-purple); }
    .day-table { border-collapse: separate; border-spacing: 0; font-family: 'JetBrains Mono', monospace; font-size: 10px; }
    .day-table th, .day-table td { padding: 3px 4px; border: 1px solid var(--border-medium); text-align: center; }
    .day-table thead { position: sticky; top: 0; z-index: 50; }
    .day-table thead tr:first-child th { position: sticky; top: 0; z-index: 50; background: #1a1a24; color: var(--text-muted); font-weight: 500; font-size: 9px; text-transform: uppercase; box-shadow: 0 1px 0 #1a1a24, 0 2px 0 var(--border-medium); }
    .day-table thead tr:nth-child(2) th { position: sticky; top: 22px; z-index: 49; background: #12121a; color: var(--text-muted); font-weight: 500; font-size: 9px; text-transform: uppercase; box-shadow: 0 1px 0 #12121a, 0 2px 0 var(--border-medium); }
    .day-table tbody { position: relative; z-index: 1; }
    .day-table .hour-cell { 
      background: #0d0d12 !important; 
      color: var(--accent-btc); 
      font-weight: 600; 
      position: sticky; 
      left: 0; 
      z-index: 10;
      box-shadow: 2px 0 4px rgba(0,0,0,0.5);
    }
    .day-table th.hour-cell { z-index: 55; background: #1a1a24 !important; }
    .day-table thead tr:first-child th.hour-cell { z-index: 55; background: #1a1a24 !important; }
    .day-table thead tr:nth-child(2) th.hour-cell { z-index: 54; background: #12121a !important; }
    .day-table .hour-cell.highlighted { background: rgba(247, 147, 26, 0.25) !important; color: #ffc73b; }
    .day-table .hour-row-highlighted td { background: rgba(247, 147, 26, 0.08); }
    .day-table .hour-row-highlighted .hour-cell { background: rgba(247, 147, 26, 0.25) !important; }
    .day-table .group-border { border-left: 2px solid rgba(247, 147, 26, 0.5) !important; }
    .day-table .group-header { background: #1f1f2a !important; color: var(--accent-btc); font-weight: 600; font-size: 8px; }
    .day-table .ohlc-header { background: #1a1e2a !important; color: var(--accent-blue); }
    .day-table .cum-header { background: #1a2420 !important; color: var(--accent-green); }
    .day-table .section-header { background: #1f1c18 !important; color: var(--accent-btc); font-weight: 600; }
    
    .min-cell { min-width: 70px; min-height: 56px; padding: 0 !important; border: 1px solid var(--border-medium) !important; position: relative; }
    .min-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr 1fr 1fr; min-height: 56px; }
    .min-grid-top { display: flex; justify-content: center; align-items: center; padding: 1px; font-size: 9px; border-bottom: 1px solid var(--border-medium); }
    .min-grid-top.left { border-right: 1px solid var(--border-medium); }
    .min-grid-bottom { grid-column: 1 / 3; display: flex; justify-content: center; align-items: center; padding: 1px; font-size: 9px; }
    .min-grid-row4 { display: flex; justify-content: space-between; align-items: center; padding: 0 2px; font-size: 8px; min-height: 14px; }
    .min-grid-row4 .hr-oc { flex: 1; text-align: left; }
    .min-grid-row4 .bar-rsi { flex: 0 0 auto; text-align: right; padding: 0 2px; border-radius: 2px; font-weight: 500; }
    .min-grid-row4.rsi-ob-border { border: 2px solid var(--accent-purple) !important; }
    .min-grid-row4.rsi-os-border { border: 2px solid var(--accent-orange) !important; }
    .min-lvl { font-size: 8px; color: #ffffff; margin-left: 2px; }

    /* After High/Low Grid */
    .after-metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-column: 1/3;
      gap: 1px;
      font-size: 7px;
      padding: 1px;
    }
    .after-high, .after-low {
      padding: 1px 2px;
      text-align: center;
      border-radius: 2px;
      color: #ffffff;
    }
    @media (max-width: 768px) {
      .after-metrics-grid {
        font-size: 6px;
      }
    }

    /* Calendar Styles */
    .calendar-toolbar { display: flex; gap: 12px; padding: 10px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); align-items: center; flex-wrap: wrap; flex-shrink: 0; }
    .calendar-toolbar label { font-size: 0.65rem; color: var(--text-muted); }
    .calendar-toolbar select { padding: 4px 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-medium); border-radius: 4px; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; }
    
    .calendar-container { flex: 1; overflow: auto; padding: 16px; min-height: 0; }
    .calendar-year { margin-bottom: 24px; }
    .calendar-year-title { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; color: var(--accent-btc); margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--border-medium); }
    .calendar-months { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .calendar-month { background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 8px; }
    .calendar-month-title { font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-align: center; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid var(--border-subtle); }
    .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 4px; }
    .calendar-weekday { font-size: 0.5rem; color: var(--text-muted); text-align: center; padding: 2px; }
    .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; }
    .calendar-day { min-width: 58px; min-height: 78px; display: flex; flex-direction: column; padding: 3px; border-radius: 4px; font-size: 0.55rem; cursor: pointer; transition: all 0.15s; position: relative; border: 1px solid var(--border-subtle); }
    .calendar-day:hover { outline: 2px solid var(--accent-btc); z-index: 5; }
    .calendar-day.empty { background: transparent; cursor: default; border: none; min-height: 78px; }
    .calendar-day.empty:hover { outline: none; }
    .calendar-day .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
    .calendar-day .day-num { font-weight: 600; font-size: 0.65rem; }
    .calendar-day .day-close { font-size: 0.5rem; color: var(--text-secondary); }
    .calendar-day .day-urlr { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; margin: 2px 0; }
    .calendar-day .day-ur, .calendar-day .day-lr { font-size: 0.5rem; text-align: center; padding: 1px; border-radius: 2px; }
    .calendar-day .day-ur { background: rgba(74, 222, 128, 0.15); color: #a7f3d0; }
    .calendar-day .day-lr { background: rgba(248, 113, 113, 0.15); color: #fecaca; }
    .calendar-day .day-oc { font-size: 0.55rem; text-align: center; font-weight: 500; margin-top: auto; }
    .calendar-day .day-oc.positive { color: #a7f3d0; }
    .calendar-day .day-oc.negative { color: #fecaca; }
    .calendar-day .day-rng { font-size: 0.45rem; text-align: center; color: var(--text-muted); }
    .calendar-day.weekend .day-num { color: var(--text-muted); }
    .calendar-day.no-color { background: transparent !important; border: 1px dashed var(--border-subtle); }
    
    @media (max-width: 1200px) { .calendar-months { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 900px) { .calendar-months { grid-template-columns: repeat(2, 1fr); } }
    
    /* ==================== MOBILE RESPONSIVE STYLES ==================== */
    
    /* Mobile Detection Class */
    .is-mobile { --font-size: 11px; }

    /* Mobile Tab Navigation */
    @media (max-width: 768px) {
      .tab-nav { flex-wrap: wrap; justify-content: center; gap: 2px; padding: 5px; }
      .tab-btn { padding: 8px 12px; font-size: 0.7rem; flex: 1 1 auto; min-width: 70px; text-align: center; }
      .tab-btn.active { background: var(--accent-btc-dim); }

      /* Mobile Header - Hide subtitle and stats */
      .header { flex-direction: column; padding: 8px 12px; gap: 4px; }
      .header h1 { font-size: 0.9rem; }
      .header .sub { display: none !important; }
      .header-stats { display: none !important; }
      .stat { padding: 3px 8px; min-width: 50px; }
      .stat-val { font-size: 0.75rem; }
      .stat-lbl { font-size: 0.4rem; }
      
      /* Mobile Toolbar */
      .toolbar { gap: 3px; padding: 4px 8px; justify-content: flex-start; overflow-x: auto; flex-wrap: nowrap; }
      .tb-btn { padding: 4px 6px; font-size: 0.55rem; white-space: nowrap; }
      .tb-group { display: none; } /* Hide non-essential groups on mobile */
      .tb-group.mobile-show { display: flex; }
      .tb-spacer { display: none; }
      
      /* Mobile Filters */
      .filters { grid-template-columns: 1fr; padding: 8px; gap: 8px; }
      .filter-group { padding: 6px; }
      .f-btn { padding: 4px 6px; font-size: 0.6rem; }
      
      /* Mobile Day View Header */
      .day-view-header { padding: 8px 12px; }
      .day-view-title { font-size: 0.85rem !important; }
      .day-stats-grid { flex-wrap: wrap; gap: 4px; }
      .day-stat-box { padding: 4px 8px; min-width: 60px; }
      .day-stat-val { font-size: 0.7rem; }
      .day-stat-lbl { font-size: 0.4rem; }
      
      /* Mobile Day Toolbar */
      .day-toolbar { gap: 4px; padding: 6px 8px; flex-wrap: wrap; }
      .day-toolbar select, .day-toolbar input { font-size: 0.65rem; padding: 4px; }
      
      /* Mobile Upload Card */
      .upload-card { padding: 24px 16px; margin: 16px; max-width: calc(100% - 32px); }
      .upload-card h1 { font-size: 1.4rem; }
      .upload-btn { padding: 12px 24px; font-size: 0.95rem; }
      .format-info code { font-size: 0.7rem; word-break: break-all; }
      
      /* Mobile Legend */
      .legend { gap: 8px; padding: 4px; font-size: 0.5rem; }
      .legend-item { flex-direction: column; align-items: center; }
      
      /* Mobile Column Selector */
      .col-selector, .col-filter-panel, .dt-col-selector, .rsi-settings { padding: 6px 8px; }
      .col-grid, .dt-col-grid { gap: 3px; }
      .col-grid label, .dt-col-grid label { font-size: 0.55rem; padding: 3px 5px; }
      
      /* Calendar Mobile */
      .calendar-months { grid-template-columns: 1fr; }
      .calendar-toolbar { flex-wrap: wrap; gap: 6px; padding: 8px; }
      .calendar-day { padding: 2px; min-height: 45px; }
      .calendar-day .day-num { font-size: 0.55rem; }
      .calendar-day .day-val { font-size: 0.65rem; }
    }
    
    /* Extra Small Mobile */
    @media (max-width: 480px) {
      .tab-btn { padding: 6px 8px; font-size: 0.6rem; min-width: 60px; }
      .header h1 { font-size: 0.8rem; }
      .stat { padding: 2px 6px; }
      .tb-btn { padding: 3px 5px; font-size: 0.5rem; }
      .day-view-title { font-size: 0.75rem !important; }
      .day-stat-box { min-width: 50px; padding: 3px 6px; }
    }
    
    /* Mobile Table Scrolling */
    @media (max-width: 768px) {
      .table-container, .day-table-container { 
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
      }
      
      /* Larger touch targets for mobile */
      .data-table td, .data-table th,
      .day-table td, .day-table th { 
        padding: 4px 3px; 
        min-width: 35px;
      }
      
      /* Mobile: Show compact 5-min data */
      .min-cell { min-height: 40px !important; }
      .min-grid { font-size: 8px; }
      .min-lvl { font-size: 6px; }
    }
    
    /* Touch-friendly controls */
    @media (pointer: coarse) {
      .tb-btn, .f-btn, button { min-height: 36px; min-width: 36px; }
      select, input[type="number"] { min-height: 36px; font-size: 14px; }
      .tab-btn { min-height: 40px; }
    }
    
    /* Landscape Mobile */
    @media (max-width: 900px) and (orientation: landscape) {
      .header { padding: 4px 12px; }
      .toolbar { padding: 3px 8px; }
      .day-view-header { padding: 4px 8px; }
      .day-stats-grid { gap: 3px; }
    }
    
    /* Mobile Menu Toggle */
    /* Global Filter Button - Always visible on all screen sizes */
    .mobile-menu-btn {
      display: flex;
      position: fixed;
      bottom: 16px;
      right: 16px;
      z-index: 1000;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent-btc);
      color: white;
      border: none;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(247,147,26,0.4);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .mobile-menu-btn:hover {
      box-shadow: 0 6px 16px rgba(247,147,26,0.5);
    }
    .mobile-menu-btn:active { transform: scale(0.95); }

    /* Mobile Filter Modal */
    .mobile-filter-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      backdrop-filter: blur(4px);
    }
    .mobile-filter-modal.visible {
      display: flex;
      flex-direction: column;
    }
    .mobile-filter-content {
      background: var(--bg-primary);
      margin: auto;
      max-width: 95vw;
      max-height: 90vh;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 12px 48px rgba(0,0,0,0.9);
    }
    /* Desktop: Constrain modal width for better UX */
    @media (min-width: 769px) {
      .mobile-filter-content {
        max-width: 800px;
      }
    }
    .mobile-filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: linear-gradient(180deg, rgba(247,147,26,0.15) 0%, var(--bg-secondary) 100%);
      border-bottom: 1px solid var(--border-medium);
    }
    .mobile-filter-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--accent-btc);
    }
    .mobile-filter-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--text-primary);
      font-size: 24px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .mobile-filter-tabs {
      display: flex;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-medium);
      overflow-x: auto;
      flex-shrink: 0;
    }
    .mobile-tab-btn {
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-muted);
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
      flex: 1;
      min-width: fit-content;
    }
    .mobile-tab-btn.active {
      color: var(--accent-btc);
      border-bottom-color: var(--accent-btc);
      background: rgba(247,147,26,0.08);
    }
    .mobile-filter-body {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px;
    }
    .mobile-tab-panel {
      display: none;
    }
    .mobile-tab-panel.active {
      display: block;
    }
    .mobile-filter-section {
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
    }
    .mobile-filter-section h3 {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 500;
    }
    .mobile-filter-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .mobile-filter-btn {
      padding: 8px 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-medium);
      border-radius: 4px;
      color: var(--text-muted);
      font-size: 0.7rem;
      cursor: pointer;
      min-height: 40px;
      min-width: 44px;
    }
    .mobile-filter-btn.active {
      background: var(--accent-btc-dim);
      border-color: rgba(247,147,26,0.4);
      color: var(--accent-btc);
    }
    .mobile-filter-btn.quick {
      background: rgba(100,149,237,0.1);
      border-color: rgba(100,149,237,0.25);
      color: var(--accent-blue);
    }
    .mobile-filter-btn.none-btn {
      background: rgba(248,113,113,0.1);
      border-color: rgba(248,113,113,0.25);
      color: var(--accent-red);
    }
    .mobile-settings-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 12px;
    }
    .mobile-settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: rgba(255,255,255,0.02);
      border-radius: 6px;
    }
    .mobile-settings-label {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    .mobile-settings-input {
      padding: 6px 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-medium);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 0.75rem;
      min-height: 40px;
    }
    .mobile-action-btn-large {
      padding: 12px 20px;
      background: rgba(100,149,237,0.15);
      border: 1px solid rgba(100,149,237,0.3);
      border-radius: 8px;
      color: var(--accent-blue);
      font-size: 0.85rem;
      cursor: pointer;
      min-height: 44px;
      font-weight: 500;
    }
    .mobile-action-btn-large:active {
      background: rgba(100,149,237,0.25);
    }
    
    /* Mobile Quick Actions Panel */
    .mobile-actions { 
      display: none; 
      position: fixed;
      bottom: 72px;
      right: 16px;
      z-index: 999;
      flex-direction: column;
      gap: 8px;
    }
    .mobile-actions.visible { display: flex; }
    .mobile-action-btn {
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-medium);
      border-radius: 20px;
      color: var(--text-primary);
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .mobile-action-btn:active { background: var(--accent-btc-dim); }
    
    /* Print Styles */
    @media print {
      .tab-nav, .toolbar, .filters, .legend, .mobile-menu-btn, .mobile-actions { display: none !important; }
      body { background: white; color: black; }
      .app { height: auto; overflow: visible; }
      .table-container, .day-table-container { overflow: visible; height: auto; }
    }
  </style>
<style>
/* ===== INFO ICON FIX ===== */
.info, .info-icon, .infoBtn {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;height:18px;
  border-radius:50%;
  background:rgba(120,160,255,.15);
  color:#9fbaff;
  font-weight:700;
  cursor:pointer;
}
.info:hover, .info-icon:hover, .infoBtn:hover {
  background:rgba(120,160,255,.35);
  color:#fff;
}
.info-popup, .infoPanel {
  position:absolute;
  z-index:999;
  background:#0f1422;
  border:1px solid #24314d;
  border-radius:10px;
  padding:10px 12px;
  font-size:12px;
  line-height:1.4;
  box-shadow:0 12px 30px rgba(0,0,0,.45);
}
.info-hidden { display:none !important; }

@media(max-width:768px){
  .info-popup, .infoPanel{
    position:fixed;
    left:50%;
    bottom:90px;
    transform:translateX(-50%);
    max-width:calc(100vw - 24px);
  }
}
</style>
<style>
/* FORCE TAB SIZE FIX */
.bottom-tabs button, .tab-btn {
  padding:6px 8px !important;
  font-size:11px !important;
}
.bottom-tabs { height:44px !important; }

/* HIDE TOP FILTERS ON MOBILE */
@media(max-width:768px){
  .top-filters, .filters, #filters { display:none !important; }
}

/* INFO MODAL */
#GLOBAL_INFO_MODAL{
  position:fixed;inset:0;display:none;
  background:rgba(0,0,0,.6);
  align-items:center;justify-content:center;
  z-index:99999;
}
#GLOBAL_INFO_MODAL .card{
  background:#101522;border-radius:14px;
  padding:14px;width:90%;max-width:320px;
  color:#fff;
}

/* Live Status Indicator */
.live-status-container {
  position: fixed;
  top: 65px;
  right: 20px;
  margin: 0;
  z-index: 1001;
}

.live-status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  background: rgba(74, 222, 128, 0.1);
  border: 1px solid rgba(74, 222, 128, 0.3);
  border-radius: 4px;
  font-size: 11px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

.live-status-indicator:hover {
  background: rgba(74, 222, 128, 0.15);
  border-color: rgba(74, 222, 128, 0.5);
}

.live-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #4ade80;
  animation: pulse 2s ease-in-out infinite;
}

.live-status-indicator.loading .live-dot {
  background: #fbbf24;
  animation: pulse 1s ease-in-out infinite;
}

.live-status-indicator.error .live-dot {
  background: #f87171;
  animation: none;
}

.live-status-indicator.refreshing .live-dot {
  background: #60a5fa;
  animation: pulse 0.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.live-text {
  color: var(--text-primary);
}

@media (max-width: 768px) {
  .live-status-container {
    top: 55px;
    right: 10px;
  }
  .live-status-indicator {
    font-size: 9px;
    padding: 3px 6px;
    gap: 3px;
  }
  .live-dot {
    width: 6px;
    height: 6px;
  }
}

/* Show compact "Live" text on mobile, full details on hover/desktop */
.live-status-indicator .live-text-full {
  display: inline;
}
.live-status-indicator .live-text-short {
  display: none;
}

@media (max-width: 768px) {
  .live-status-indicator .live-text-full {
    display: none !important;
  }
  .live-status-indicator .live-text-short {
    display: inline !important;
  }
}
</style>
<!-- Live Data Fetcher -->
<script src="live-data-fetcher.js"></script>
</head>
<body>

  <input type="file" id="file-input" accept=".csv">

  <div id="upload-screen" class="upload-screen">
    <div class="upload-card">
      <div class="btc-logo"></div>
      <h1>BTC Hourly Analyzer v12</h1>
      <p>Upload your 5-minute Bitcoin OHLCV CSV data</p>
      <p id="auto-load-msg" style="color:var(--text-muted);font-size:0.8rem;margin:8px 0;display:none;">
        <span class="spinner" style="width:12px;height:12px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:6px;"></span>
        Checking for auto-load data...
      </p>
      <button class="upload-btn" onclick="document.getElementById('file-input').click()"> Select CSV File</button>
      <div id="error-msg" class="error-msg" style="display: none;"></div>
      <div class="format-info">
        <h3>Expected Format</h3>
        <code>timestamp,open,high,low,close,volume,source</code>
        <p style="margin-top:8px;font-size:0.7rem;color:var(--text-muted);">On GitHub Pages, data loads automatically from /data/ folder</p>
      </div>
    </div>
  </div>

  <div id="loading-screen" class="upload-screen" style="display: none;">
    <div class="upload-card">
      <div class="spinner"></div>
      <p id="loading-text" style="color:var(--accent-btc);font-family:'JetBrains Mono'">Processing data & calculating RSI...</p>
    </div>
  </div>

  <div id="app" class="app">
    <nav class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('overview')"> Overview</button>
      <button class="tab-btn" onclick="switchTab('pm5session')"> 5PM Session</button>
      <button class="tab-btn" onclick="switchTab('dayview')"> Day View</button>
      <button class="tab-btn" onclick="switchTab('hourview')"> Hour View</button>
      <button class="tab-btn" onclick="switchTab('calendar')"> Calendar</button>
    </nav>
    
    <!-- Overview Tab -->
    <div id="tab-overview" class="tab-content active">
      <header class="header">
        <div>
          <h1><span class="btc-sym"></span> BTC Hourly Analysis</h1>
          <span class="sub">5-Min Data  Level Analysis  Ultimate RSI  Eastern Time</span>
        </div>
        <div class="header-stats">
          <div class="stat"><span class="stat-val" id="stat-days">0</span><span class="stat-lbl">Days</span></div>
          <div class="stat"><span class="stat-val" id="stat-hours">24</span><span class="stat-lbl">Hours</span></div>
          <div class="stat"><span class="stat-val" id="stat-cols">7</span><span class="stat-lbl">Cols</span></div>
        </div>
      </header>

      <!-- Live Status Indicator - Fixed position, visible across all tabs -->
      <div class="live-status-container">
        <div class="live-status-indicator" id="live-status">
          <span class="live-dot"></span>
          <span class="live-text">
            <span class="live-text-short">Live</span>
            <span class="live-text-full">Initializing...</span>
          </span>
        </div>
      </div>

      <div class="toolbar">
        <button class="tb-btn mobile-hide" id="btn-filters" onclick="toggleFilters()"> Filters</button>
        <button class="tb-btn mobile-hide" id="btn-columns" onclick="toggleColumns()"> Columns</button>
        <button class="tb-btn mobile-hide" id="btn-day-cols" onclick="toggleDayColsPanel()"> DayTotals</button>
        <button class="tb-btn mobile-hide" id="btn-pct" onclick="togglePercentiles()"> Pctiles</button>
        <button class="tb-btn filter-btn mobile-hide" id="btn-col-filter" onclick="toggleColFilterPanel()"> ColFilter</button>
        <button class="tb-btn mobile-hide" id="btn-rsi" onclick="toggleRsiSettings()" style="background:rgba(167,139,250,0.1);border-color:rgba(167,139,250,0.3);color:var(--accent-purple)"> RSI</button>
        <button class="tb-btn mobile-hide" id="btn-refresh" onclick="manualRefresh()" title="Refresh live data"> Refresh</button>

        <div class="tb-group">
          <label>Font:</label>
          <select id="font-family" onchange="updateFont()">
            <option value="'JetBrains Mono', monospace">JetBrains</option>
            <option value="'Roboto Mono', monospace">Roboto</option>
            <option value="'Fira Code', monospace">Fira</option>
          </select>
        </div>
        
        <div class="tb-group">
          <label>Size:</label>
          <select id="font-size" onchange="updateFont()">
            <option value="9">9</option>
            <option value="10" selected>10</option>
            <option value="11">11</option>
            <option value="12">12</option>
          </select>
        </div>
        
        <div class="tb-group">
          <label>Level:</label>
          <input type="number" id="level-size" value="250" min="1" onchange="updateLevel()">
        </div>
        
        <div class="tb-spacer"></div>
        <button class="tb-btn preset mobile-hide" onclick="resetAll()">Reset</button>
        <button class="tb-btn preset mobile-hide" onclick="setRTH()">US RTH</button>
        <button class="tb-btn new-file mobile-hide" onclick="loadNewFile()"> New</button>
      </div>

      <!-- Column Filter Panel -->
      <div id="col-filter-panel" class="col-filter-panel">
        <h3>Column Filters (rows must match ALL conditions)</h3>
        <div class="active-filters" id="active-filters"></div>
        <div class="add-filter-row">
          <select id="filter-hour">
            <option value="day">Day Total</option>
          </select>
          <select id="filter-column"></select>
          <select id="filter-op">
            <option value=">="></option>
            <option value="<="></option>
            <option value=">">&gt;</option>
            <option value="<">&lt;</option>
            <option value="=="></option>
            <option value="!="></option>
          </select>
          <input type="number" id="filter-value" placeholder="Value">
          <button onclick="addColumnFilter()">+ Add Filter</button>
          <button onclick="clearAllFilters()" style="background:rgba(248,113,113,0.2);border-color:rgba(248,113,113,0.4);color:var(--accent-red)">Clear All</button>
        </div>
      </div>

      <!-- RSI Settings Panel -->
      <div id="rsi-settings" class="rsi-settings">
        <h3>Ultimate RSI Settings</h3>
        <div class="rsi-settings-row">
          <label>RSI Length: <input type="number" id="rsi-length" value="9" min="2" onchange="recalcRSI()"></label>
          <label>RSI Method: <select id="rsi-method" onchange="recalcRSI()"><option value="RMA" selected>RMA</option><option value="EMA">EMA</option><option value="SMA">SMA</option></select></label>
          <label>Signal Length: <input type="number" id="signal-length" value="5" min="1" onchange="recalcRSI()"></label>
          <label>Signal Method: <select id="signal-method" onchange="recalcRSI()"><option value="EMA" selected>EMA</option><option value="RMA">RMA</option><option value="SMA">SMA</option></select></label>
          <label>OB Level: <input type="number" id="ob-level" value="88" min="50" max="100" onchange="recalcRSI()"></label>
          <label>OS Level: <input type="number" id="os-level" value="12" min="0" max="50" onchange="recalcRSI()"></label>
        </div>
      </div>

      <!-- Day Totals Column Selector -->
      <div id="dt-col-selector" class="dt-col-selector">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <h3 style="margin-bottom:0;">Day Total Columns</h3>
          <button id="btn-show-dt-cols" class="f-btn active" onclick="toggleShowDayCols()" style="font-size:0.55rem;padding:2px 8px;">Show in Table</button>
          <div style="display:flex;align-items:center;gap:8px;">
            <label style="font-size:0.55rem;color:var(--text-muted);margin-left:8px">Established %:</label>
            <input id="est-pct" type="number" value="85" min="1" max="100" style="width:64px;padding:4px;border-radius:4px;background:rgba(255,255,255,0.03);border:1px solid var(--border-medium);color:var(--text-primary);font-size:0.55rem;" onchange="computeEstablishedHours();
      computeRelativeVolume(); renderTable();" />
          </div>
        </div>
        <div class="dt-col-grid" id="dt-col-grid"></div>
        <div style="margin-top:6px;display:flex;gap:4px;">
          <button class="f-btn quick" onclick="showAllDTCols()">All</button>
          <button class="f-btn none-btn" onclick="hideAllDTCols()">None</button>
          <button class="f-btn" onclick="defaultDTCols()">Default</button>
          <div style="margin-left:10px;display:flex;align-items:center;gap:4px;">
            <label style="font-size:0.55rem;color:var(--text-muted)">O-C Hr:</label>
            <select id="oc-close-hour" style="padding:2px 4px;background:rgba(255,255,255,0.05);border:1px solid var(--border-medium);border-radius:2px;color:var(--text-primary);font-size:0.55rem;" onchange="renderTable()"></select>
          </div>
        </div>
      </div>

      <div id="filters-panel" class="filters">
        <div class="filter-group">
          <h3>Years</h3>
          <div class="filter-btns" id="year-filters"></div>
        </div>
        
        <div class="filter-group">
          <h3>Months</h3>
          <div class="filter-btns" id="month-filters">
            <button class="f-btn none-btn" onclick="setNoMonths()">None</button>
            <button class="f-btn active" data-month="1" onclick="toggleMonth(1)">Jan</button>
            <button class="f-btn active" data-month="2" onclick="toggleMonth(2)">Feb</button>
            <button class="f-btn active" data-month="3" onclick="toggleMonth(3)">Mar</button>
            <button class="f-btn active" data-month="4" onclick="toggleMonth(4)">Apr</button>
            <button class="f-btn active" data-month="5" onclick="toggleMonth(5)">May</button>
            <button class="f-btn active" data-month="6" onclick="toggleMonth(6)">Jun</button>
            <button class="f-btn active" data-month="7" onclick="toggleMonth(7)">Jul</button>
            <button class="f-btn active" data-month="8" onclick="toggleMonth(8)">Aug</button>
            <button class="f-btn active" data-month="9" onclick="toggleMonth(9)">Sep</button>
            <button class="f-btn active" data-month="10" onclick="toggleMonth(10)">Oct</button>
            <button class="f-btn active" data-month="11" onclick="toggleMonth(11)">Nov</button>
            <button class="f-btn active" data-month="12" onclick="toggleMonth(12)">Dec</button>
            <button class="f-btn quick" onclick="setQ1()">Q1</button>
            <button class="f-btn quick" onclick="setQ2()">Q2</button>
            <button class="f-btn quick" onclick="setQ3()">Q3</button>
            <button class="f-btn quick" onclick="setQ4()">Q4</button>
          </div>
        </div>
        
        <div class="filter-group">
          <h3>Days</h3>
          <div class="filter-btns">
            <button class="f-btn none-btn" onclick="setNoDays()">None</button>
            <button class="f-btn active" data-day="0" onclick="toggleDay(0)">Sun</button>
            <button class="f-btn active" data-day="1" onclick="toggleDay(1)">Mon</button>
            <button class="f-btn active" data-day="2" onclick="toggleDay(2)">Tue</button>
            <button class="f-btn active" data-day="3" onclick="toggleDay(3)">Wed</button>
            <button class="f-btn active" data-day="4" onclick="toggleDay(4)">Thu</button>
            <button class="f-btn active" data-day="5" onclick="toggleDay(5)">Fri</button>
            <button class="f-btn active" data-day="6" onclick="toggleDay(6)">Sat</button>
            <button class="f-btn quick" onclick="setWeekdays()">Wkdays</button>
            <button class="f-btn quick" onclick="setWeekend()">Wkend</button>
          </div>
        </div>
        
        <div class="filter-group">
          <h3>Day # in Month</h3>
          <div class="filter-btns">
            <button class="f-btn active" data-occ="1" onclick="toggleOcc(1)">1st</button>
            <button class="f-btn active" data-occ="2" onclick="toggleOcc(2)">2nd</button>
            <button class="f-btn active" data-occ="3" onclick="toggleOcc(3)">3rd</button>
            <button class="f-btn active" data-occ="4" onclick="toggleOcc(4)">4th</button>
            <button class="f-btn active" data-occ="5" onclick="toggleOcc(5)">5th</button>
          </div>
        </div>
        
        <div class="filter-group">
          <h3>Hours (Eastern Time)</h3>
          <div class="range-row">
            <label>From: <select id="hour-from" onchange="updateHourRange()"></select></label>
            <label>To: <select id="hour-to" onchange="updateHourRange()"></select></label>
            <div class="hour-presets">
              <button onclick="setHours(0, 23)">All</button>
              <button onclick="setHours(9, 16)">RTH</button>
              <button onclick="setHours(4, 9)">Pre</button>
              <button onclick="setHours(16, 20)">AH</button>
            </div>
          </div>
        </div>
        
        <div class="filter-group">
          <h3>Specific Dates</h3>
          <div class="date-picker-container" style="position:relative;">
            <button class="date-picker-btn" onclick="toggleDatePicker()"> Dates (<span id="date-count">0</span>)</button>
            <div id="date-picker-dropdown" class="date-picker-dropdown">
              <div class="date-picker-actions">
                <button onclick="selectAllDates()">All</button>
                <button onclick="selectNoDates()">Clear</button>
                <button onclick="syncDatesFromFilters()">Sync</button>
              </div>
              <div class="date-list" id="date-list"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="col-selector" class="col-selector">
        <h3>Columns (per Hour)</h3>
        <div class="col-grid" id="col-grid"></div>
        <div class="col-presets">
          <button onclick="setDefaultCols()">Default</button>
          <button onclick="setAllCols()">All</button>
          <button onclick="setNoCols()">None</button>
          <button onclick="setRangeCols()">Range</button>
          <button onclick="setOHLCVCols()">OHLCV</button>
          <button onclick="setRSICols()">RSI</button>
          <div class="option-toggle">
            <label>Gradient:</label>
            <select id="gradient-mode" onchange="renderTable()">
              <option value="row">Per Row</option>
              <option value="column">Per Column</option>
            </select>
          </div>
        </div>
      </div>

      <div class="table-container" id="table-container">
        <table class="data-table" id="data-table">
          <thead id="table-head"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>

      <div class="legend">
        <div class="legend-item"><div class="legend-grad grad-orange"></div><span>Range (Orange)</span></div>
        <div class="legend-item"><div class="legend-grad" style="background:linear-gradient(90deg, rgb(251,146,60) 0%, #0d0d12 100%)"></div><span>Rank (Orange)</span></div>
        <div class="legend-item"><div class="legend-grad grad-rg"></div><span>+/- (RedGreen)</span></div>
        <div class="legend-item"><div class="legend-grad grad-purple"></div><span>RSI (Purple)</span></div>
        <div class="legend-item"><span style="color:#fbbf24">OB</span>/<span style="color:#60a5fa">OS</span> = Overbought/Oversold</div>
      </div>
    </div>
    
    <!-- Day View Tab -->
    <div id="tab-dayview" class="tab-content">
      <div class="day-view-header">
        <div class="day-view-header-top">
          <div style="display: flex; align-items: center;">
            <div class="day-view-title" id="day-view-title">Select a Date</div>
            <span class="live-indicator" onclick="manualRefresh()" title="Click to refresh live data">Live</span>
          </div>
          <button class="day-view-collapse-btn collapsed" id="day-view-collapse-btn" onclick="toggleDayViewStats()"></button>
        </div>
        <div class="day-view-stats-collapsible collapsed" id="day-view-stats-collapsible" style="margin-top:8px;">
          <div class="day-stats-grid" id="day-stats-grid"></div>
        </div>
      </div>

      <div class="day-toolbar" id="day-toolbar-main">
        <label>Select Date:</label>
        <select id="day-view-date" onchange="renderDayView()"></select>
        <div class="tb-group" id="compare-group" style="display:none;">
          <label>Compare:</label>
          <select id="day-view-date2" onchange="renderDayView()"></select>
        </div>
        <div class="tb-group">
          <label>Level:</label>
          <input type="number" id="day-level-size" value="250" min="1" onchange="renderDayView()">
        </div>
        <div class="tb-group">
          <label>Highlight:</label>
          <select id="day-hl-from" onchange="renderDayView()"></select>
          <span style="color:var(--text-muted)">to</span>
          <select id="day-hl-to" onchange="renderDayView()"></select>
        </div>
        <button class="tb-btn active" id="btn-day-ohlc" onclick="toggleDayOHLC()">OHLC</button>
        <button class="tb-btn" id="btn-compare" onclick="toggleCompareMode()"> Compare</button>
        <button class="tb-btn" id="btn-show-after-hl" onclick="toggleShowAfterHL()">AfterH/L</button>
        <button class="tb-btn" onclick="showLegendPopup()"> Legend</button>
        <div class="tb-group">
          <label>rVol </label>
          <input type="number" id="rvol-threshold" value="4" min="0" step="0.1" style="width:60px;" onchange="updateRVolThreshold()">
        </div>
        <div class="tb-group">
          <label>After Bar </label>
          <input type="number" id="after-bar-threshold" value="400" min="0" step="10" style="width:70px;" onchange="updateAfterBarThreshold()">
        </div>
      </div>
      
      <div class="day-compare-container" id="day-compare-container">
        <div class="day-table-panel" id="day-table-panel-1">
          <div class="day-table-container">
            <table class="day-table" id="day-table">
              <thead id="day-table-head"></thead>
              <tbody id="day-table-body"></tbody>
            </table>
          </div>
        </div>
        <div class="day-table-panel" id="day-table-panel-2" style="display:none;">
          <div class="day-table-container">
            <table class="day-table" id="day-table-2">
              <thead id="day-table-head-2"></thead>
              <tbody id="day-table-body-2"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Calendar View Tab -->
    <div id="tab-calendar" class="tab-content">
      <div class="calendar-toolbar">
        <span class="live-indicator" onclick="manualRefresh()" title="Click to refresh live data">Live</span>
        <label>Color By:</label>
        <select id="calendar-color-by" onchange="renderCalendar()">
          <option value="dMxToHr" selected>Max DUR/DLR to Hour</option>
          <option value="dRng">Day Range</option>
          <option value="dUR">Day UR</option>
          <option value="dLR">Day LR</option>
          <option value="dOC">Day O-C</option>
          <option value="dMx">Max(DUR, DLR)</option>
        </select>
        <div class="tb-group" id="cal-hour-group">
          <label>Close Hour:</label>
          <select id="calendar-close-hour" onchange="renderCalendar()"></select>
        </div>
        <div class="tb-group" style="border-left:1px solid var(--border-medium);padding-left:10px;margin-left:10px;">
          <label>Years:</label>
          <div id="calendar-year-btns" style="display:flex;gap:2px;"></div>
        </div>
        <div class="tb-group" style="border-left:1px solid var(--border-medium);padding-left:10px;margin-left:10px;">
          <label>Color Days:</label>
          <button class="f-btn active" data-cal-day="0" onclick="toggleCalDay(0)">Sun</button>
          <button class="f-btn active" data-cal-day="1" onclick="toggleCalDay(1)">Mon</button>
          <button class="f-btn active" data-cal-day="2" onclick="toggleCalDay(2)">Tue</button>
          <button class="f-btn active" data-cal-day="3" onclick="toggleCalDay(3)">Wed</button>
          <button class="f-btn active" data-cal-day="4" onclick="toggleCalDay(4)">Thu</button>
          <button class="f-btn active" data-cal-day="5" onclick="toggleCalDay(5)">Fri</button>
          <button class="f-btn active" data-cal-day="6" onclick="toggleCalDay(6)">Sat</button>
        </div>
        <div class="tb-group">
          <button class="tb-btn preset" onclick="syncCalFromOverview()">Sync from Overview</button>
          <button class="tb-btn" onclick="resetCalDays()">All Days</button>
        </div>
      </div>
      
      <div class="calendar-container" id="calendar-container"></div>
    </div>
    
    <!-- 5PM Session Tab -->
    <div id="tab-pm5session" class="tab-content">
      <header class="header" style="background:linear-gradient(180deg, rgba(139,92,246,0.15) 0%, var(--bg-primary) 100%);border-bottom-color:rgba(139,92,246,0.3);">
        <div style="display: flex; align-items: center;">
          <div>
            <h1 style="color:#a78bfa;"><span class="btc-sym"></span> 5PM Session Analysis</h1>
            <span class="sub">5PM Previous Day  4PM Current Day  Cumulative Ranges  Eastern Time</span>
          </div>
          <span class="live-indicator" onclick="manualRefresh()" title="Click to refresh live data">Live</span>
        </div>
        <div class="header-stats">
          <div class="stat"><span class="stat-val" id="pm5-stat-days">0</span><span class="stat-lbl">Days</span></div>
          <div class="stat"><span class="stat-val" id="pm5-stat-hours">24</span><span class="stat-lbl">Hours</span></div>
        </div>
      </header>

      <div class="toolbar">
        <button class="tb-btn" id="btn-pm5-filters" onclick="togglePm5Filters()"> Filters</button>
        <button class="tb-btn" id="btn-pm5-columns" onclick="togglePm5Columns()"> Columns</button>
        <button class="tb-btn active" id="btn-pm5-cum" onclick="togglePm5Cumulative()"> Cumulative</button>
        <div class="tb-group">
          <label>Level:</label>
          <input type="number" id="pm5-level-size" value="250" min="1" onchange="render5pmSession()">
        </div>
        <div class="tb-group">
          <label>Gradient:</label>
          <select id="pm5-gradient-mode" onchange="render5pmSession()">
            <option value="row">Row</option>
            <option value="col">Column</option>
          </select>
        </div>
        <div class="tb-spacer"></div>
        <button class="tb-btn preset" onclick="syncPm5FromOverview()">Sync from Overview</button>
      </div>

      <div id="pm5-columns-panel" class="col-selector" style="display:none;">
        <h3>5PM Session Columns (per Hour)</h3>
        <div class="col-grid" id="pm5-col-grid"></div>
        <div class="col-presets">
          <button onclick="setPm5DefaultCols()">Default</button>
          <button onclick="setPm5AllCols()">All</button>
          <button onclick="setPm5RangeCols()">Range</button>
          <button onclick="setPm5OHLCVCols()">OHLCV</button>
        </div>
      </div>

      <div id="pm5-filters-panel" class="filters" style="display:none;">
        <div class="filter-group">
          <h3>Years</h3>
          <div class="filter-btns" id="pm5-year-filters"></div>
        </div>
        <div class="filter-group">
          <h3>Days of Week</h3>
          <div class="filter-btns">
            <button class="f-btn none-btn" onclick="setPm5NoDays()">None</button>
            <button class="f-btn active" data-pm5-day="0" onclick="togglePm5Day(0)">Sun</button>
            <button class="f-btn active" data-pm5-day="1" onclick="togglePm5Day(1)">Mon</button>
            <button class="f-btn active" data-pm5-day="2" onclick="togglePm5Day(2)">Tue</button>
            <button class="f-btn active" data-pm5-day="3" onclick="togglePm5Day(3)">Wed</button>
            <button class="f-btn active" data-pm5-day="4" onclick="togglePm5Day(4)">Thu</button>
            <button class="f-btn active" data-pm5-day="5" onclick="togglePm5Day(5)">Fri</button>
            <button class="f-btn active" data-pm5-day="6" onclick="togglePm5Day(6)">Sat</button>
            <button class="f-btn quick" onclick="setPm5Weekdays()">Weekdays</button>
          </div>
        </div>
      </div>

      <div class="table-container">
        <table class="data-table" id="pm5-table">
          <thead id="pm5-table-head"></thead>
          <tbody id="pm5-table-body"></tbody>
        </table>
      </div>
    </div>
    
    <!-- Hour View Tab -->
    <div id="tab-hourview" class="tab-content">
      <div class="day-view-header" style="background:linear-gradient(180deg, rgba(167,139,250,0.15) 0%, var(--bg-primary) 100%);border-bottom-color:rgba(167,139,250,0.3);">
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
          <div class="day-view-title" id="hour-view-title" style="color:var(--accent-purple); margin-bottom: 0;">Select an Hour</div>
          <span class="live-indicator" onclick="manualRefresh()" title="Click to refresh live data">Live</span>
        </div>
        <div class="day-stats-grid" id="hour-stats-grid"></div>
      </div>
      
      <div class="day-toolbar">
        <label>Select Hour:</label>
        <select id="hour-view-hour" onchange="renderHourView()"></select>
        <div class="tb-group">
          <label>Level:</label>
          <input type="number" id="hour-level-size" value="250" min="1" onchange="renderHourView()">
        </div>
        <div class="tb-group" style="border-left:1px solid var(--border-medium);padding-left:10px;">
          <label>Days:</label>
          <button class="f-btn active" data-hv-day="0" onclick="toggleHVDay(0)">Sun</button>
          <button class="f-btn active" data-hv-day="1" onclick="toggleHVDay(1)">Mon</button>
          <button class="f-btn active" data-hv-day="2" onclick="toggleHVDay(2)">Tue</button>
          <button class="f-btn active" data-hv-day="3" onclick="toggleHVDay(3)">Wed</button>
          <button class="f-btn active" data-hv-day="4" onclick="toggleHVDay(4)">Thu</button>
          <button class="f-btn active" data-hv-day="5" onclick="toggleHVDay(5)">Fri</button>
          <button class="f-btn active" data-hv-day="6" onclick="toggleHVDay(6)">Sat</button>
          <button class="f-btn quick" onclick="setHVWeekdays()">Wkdays</button>
        </div>
        <button class="tb-btn preset" onclick="syncHVFromOverview()">Sync Filters</button>
        <button class="tb-btn" id="btn-hv-after-hl" onclick="toggleShowAfterHL()">AfterH/L</button>
        <button class="tb-btn" onclick="showLegendPopup()"> Legend</button>
        <div class="tb-group">
          <label>rVol </label>
          <input type="number" id="hv-rvol-threshold" value="4" min="0" step="0.1" style="width:60px;" onchange="updateRVolThreshold()">
        </div>
        <div class="tb-group">
          <label>After Bar </label>
          <input type="number" id="hv-after-bar-threshold" value="400" min="0" step="10" style="width:70px;" onchange="updateAfterBarThreshold()">
        </div>
      </div>

      <div class="day-table-container">
        <table class="day-table" id="hour-table">
          <thead id="hour-table-head"></thead>
          <tbody id="hour-table-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Filter Modal -->
    <div class="mobile-filter-modal" id="mobile-filter-modal">
      <div class="mobile-filter-content">
        <div class="mobile-filter-header">
          <div class="mobile-filter-title"> Filters & Settings</div>
          <button class="mobile-filter-close" onclick="closeMobileFilterModal()"></button>
        </div>

        <div class="mobile-filter-tabs">
          <button class="mobile-tab-btn active" onclick="switchMobileTab('filters')">Filters</button>
          <button class="mobile-tab-btn" onclick="switchMobileTab('columns')">Columns</button>
          <button class="mobile-tab-btn" onclick="switchMobileTab('daytotals')">DayTotals</button>
          <button class="mobile-tab-btn" onclick="switchMobileTab('colfilters')">ColFilters</button>
          <button class="mobile-tab-btn" onclick="switchMobileTab('settings')">Settings</button>
        </div>

        <div class="mobile-filter-body">
          <!-- Tab 1: Filters -->
          <div id="mobile-tab-filters" class="mobile-tab-panel active">
            <div class="mobile-filter-section">
              <h3>Years</h3>
              <div class="mobile-filter-btns" id="mobile-year-filters"></div>
            </div>

            <div class="mobile-filter-section">
              <h3>Months</h3>
              <div class="mobile-filter-btns">
                <button class="mobile-filter-btn quick" onclick="setQ1(); updateMobileFilterUI();">Q1</button>
                <button class="mobile-filter-btn quick" onclick="setQ2(); updateMobileFilterUI();">Q2</button>
                <button class="mobile-filter-btn quick" onclick="setQ3(); updateMobileFilterUI();">Q3</button>
                <button class="mobile-filter-btn quick" onclick="setQ4(); updateMobileFilterUI();">Q4</button>
                <button class="mobile-filter-btn quick" onclick="setAllMonths(); updateMobileFilterUI();">All</button>
                <button class="mobile-filter-btn none-btn" onclick="setNoMonths(); updateMobileFilterUI();">None</button>
              </div>
              <div class="mobile-filter-btns" id="mobile-month-filters" style="margin-top:8px;"></div>
            </div>

            <div class="mobile-filter-section">
              <h3>Days of Week</h3>
              <div class="mobile-filter-btns">
                <button class="mobile-filter-btn quick" onclick="setWeekdays(); updateMobileFilterUI();">Weekdays</button>
                <button class="mobile-filter-btn quick" onclick="setWeekend(); updateMobileFilterUI();">Weekend</button>
                <button class="mobile-filter-btn quick" onclick="setAllDays(); updateMobileFilterUI();">All</button>
                <button class="mobile-filter-btn none-btn" onclick="setNoDays(); updateMobileFilterUI();">None</button>
              </div>
              <div class="mobile-filter-btns" id="mobile-day-filters" style="margin-top:8px;"></div>
            </div>

            <div class="mobile-filter-section">
              <h3>Day # in Month</h3>
              <div class="mobile-filter-btns" id="mobile-occ-filters"></div>
            </div>

            <div class="mobile-filter-section">
              <h3>Hours (Eastern Time)</h3>
              <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
                <div style="flex:1;min-width:120px;">
                  <label style="font-size:0.65rem;color:var(--text-muted);display:block;margin-bottom:4px;">From Hour:</label>
                  <select id="mobile-hour-from" class="mobile-settings-input" style="width:100%;" onchange="updateHourRange()"></select>
                </div>
                <div style="flex:1;min-width:120px;">
                  <label style="font-size:0.65rem;color:var(--text-muted);display:block;margin-bottom:4px;">To Hour:</label>
                  <select id="mobile-hour-to" class="mobile-settings-input" style="width:100%;" onchange="updateHourRange()"></select>
                </div>
              </div>
              <div class="mobile-filter-btns">
                <button class="mobile-filter-btn quick" onclick="setHours(0, 23)">All (0-23)</button>
                <button class="mobile-filter-btn quick" onclick="setHours(9, 16)">RTH (9-16)</button>
                <button class="mobile-filter-btn quick" onclick="setHours(4, 9)">Pre (4-9)</button>
                <button class="mobile-filter-btn quick" onclick="setHours(16, 20)">AH (16-20)</button>
              </div>
            </div>

            <div class="mobile-filter-section">
              <h3>Specific Dates</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                <button class="mobile-filter-btn quick" onclick="selectAllDates(); updateMobileFilterUI();">All Dates</button>
                <button class="mobile-filter-btn none-btn" onclick="selectNoDates(); updateMobileFilterUI();">Clear Dates</button>
                <button class="mobile-filter-btn quick" onclick="syncDatesFromFilters(); updateMobileFilterUI();">Sync from Filters</button>
              </div>
              <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:8px;">
                Selected: <span id="mobile-date-count">0</span> dates
              </div>
              <div id="mobile-date-list" style="max-height:200px;overflow-y:auto;border:1px solid var(--border-medium);border-radius:4px;padding:4px;"></div>
            </div>
          </div>

          <!-- Tab 2: Columns -->
          <div id="mobile-tab-columns" class="mobile-tab-panel">
            <div class="mobile-filter-section">
              <h3>Column Presets</h3>
              <div class="mobile-filter-btns">
                <button class="mobile-filter-btn quick" onclick="setDefaultCols()">Default</button>
                <button class="mobile-filter-btn quick" onclick="setAllCols()">All</button>
                <button class="mobile-filter-btn quick" onclick="setNoCols()">None</button>
                <button class="mobile-filter-btn quick" onclick="setRangeCols()">Range</button>
                <button class="mobile-filter-btn quick" onclick="setOHLCVCols()">OHLCV</button>
                <button class="mobile-filter-btn quick" onclick="setRSICols()">RSI</button>
              </div>
            </div>

            <div class="mobile-filter-section">
              <h3>Gradient Mode</h3>
              <select id="mobile-gradient-mode" class="mobile-settings-input" style="width:100%;" onchange="document.getElementById('gradient-mode').value=this.value; renderTable();">
                <option value="row">Per Row</option>
                <option value="column">Per Column</option>
              </select>
            </div>

            <div class="mobile-filter-section">
              <h3>Select Columns (per Hour)</h3>
              <div id="mobile-col-grid" class="mobile-settings-row"></div>
            </div>
          </div>

          <!-- Tab 3: DayTotals -->
          <div id="mobile-tab-daytotals" class="mobile-tab-panel">
            <div class="mobile-filter-section">
              <h3>Day Total Presets</h3>
              <div class="mobile-filter-btns">
                <button class="mobile-filter-btn quick" onclick="defaultDTCols()">Default</button>
                <button class="mobile-filter-btn quick" onclick="showAllDTCols()">All</button>
                <button class="mobile-filter-btn none-btn" onclick="hideAllDTCols()">None</button>
              </div>
            </div>

            <div class="mobile-filter-section">
              <h3>Show in Table</h3>
              <button id="mobile-btn-show-dt-cols" class="mobile-action-btn-large" onclick="toggleShowDayCols()" style="width:100%;margin-bottom:12px;">
                <span id="mobile-show-dt-text">Show Day Totals</span>
              </button>
            </div>

            <div class="mobile-filter-section">
              <h3>Established % Threshold</h3>
              <input id="mobile-est-pct" type="number" value="85" min="1" max="100" class="mobile-settings-input" style="width:100%;" onchange="document.getElementById('est-pct').value=this.value; computeEstablishedHours(); computeRelativeVolume(); renderTable();" />
            </div>

            <div class="mobile-filter-section">
              <h3>O-C Close Hour</h3>
              <select id="mobile-oc-close-hour" class="mobile-settings-input" style="width:100%;" onchange="document.getElementById('oc-close-hour').value=this.value; renderTable();"></select>
            </div>

            <div class="mobile-filter-section">
              <h3>Select Day Total Columns</h3>
              <div id="mobile-dt-col-grid" class="mobile-settings-row"></div>
            </div>
          </div>

          <!-- Tab 4: ColFilters -->
          <div id="mobile-tab-colfilters" class="mobile-tab-panel">
            <div class="mobile-filter-section">
              <h3>Active Column Filters</h3>
              <div id="mobile-active-filters" style="margin-bottom:12px;">
                <div style="font-size:0.7rem;color:var(--text-muted);">No active filters</div>
              </div>
              <button class="mobile-filter-btn none-btn" onclick="clearAllFilters()" style="width:100%;">Clear All Filters</button>
            </div>

            <div class="mobile-filter-section">
              <h3>Add New Filter</h3>
              <div class="mobile-settings-row">
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Hour/Day:</span>
                  <select id="mobile-filter-hour" class="mobile-settings-input" style="flex:1;margin-left:8px;">
                    <option value="day">Day Total</option>
                  </select>
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Column:</span>
                  <select id="mobile-filter-column" class="mobile-settings-input" style="flex:1;margin-left:8px;"></select>
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Operator:</span>
                  <select id="mobile-filter-op" class="mobile-settings-input" style="flex:1;margin-left:8px;">
                    <option value=">="></option>
                    <option value="<="></option>
                    <option value=">">&gt;</option>
                    <option value="<">&lt;</option>
                    <option value="=="></option>
                    <option value="!="></option>
                  </select>
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Value:</span>
                  <input type="number" id="mobile-filter-value" placeholder="Value" class="mobile-settings-input" style="flex:1;margin-left:8px;">
                </div>
                <button class="mobile-action-btn-large" onclick="addMobileColumnFilter()" style="width:100%;">+ Add Filter</button>
              </div>
            </div>
          </div>

          <!-- Tab 5: Settings -->
          <div id="mobile-tab-settings" class="mobile-tab-panel">
            <div class="mobile-filter-section">
              <h3>Quick Actions</h3>
              <div style="display:flex;flex-direction:column;gap:8px;">
                <button class="mobile-action-btn-large" onclick="showLegendPopup();"> Show Grid Legend</button>
                <button class="mobile-action-btn-large" onclick="resetAll(); closeMobileFilterModal();"> Reset All Filters</button>
                <button class="mobile-action-btn-large" onclick="setRTH(); closeMobileFilterModal();"> US RTH (9-16, Weekdays)</button>
                <button class="mobile-action-btn-large" onclick="loadNewFile(); closeMobileFilterModal();"> Load New File</button>
              </div>
            </div>

            <div class="mobile-filter-section">
              <h3>RSI Settings</h3>
              <div class="mobile-settings-row">
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">RSI Length:</span>
                  <input type="number" id="mobile-rsi-length" value="9" min="2" class="mobile-settings-input" style="width:80px;" onchange="document.getElementById('rsi-length').value=this.value; recalcRSI();">
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">RSI Method:</span>
                  <select id="mobile-rsi-method" class="mobile-settings-input" style="flex:1;margin-left:8px;" onchange="document.getElementById('rsi-method').value=this.value; recalcRSI();">
                    <option value="RMA" selected>RMA</option>
                    <option value="EMA">EMA</option>
                    <option value="SMA">SMA</option>
                  </select>
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Signal Length:</span>
                  <input type="number" id="mobile-signal-length" value="5" min="1" class="mobile-settings-input" style="width:80px;" onchange="document.getElementById('signal-length').value=this.value; recalcRSI();">
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Signal Method:</span>
                  <select id="mobile-signal-method" class="mobile-settings-input" style="flex:1;margin-left:8px;" onchange="document.getElementById('signal-method').value=this.value; recalcRSI();">
                    <option value="EMA" selected>EMA</option>
                    <option value="RMA">RMA</option>
                    <option value="SMA">SMA</option>
                  </select>
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">OB Level:</span>
                  <input type="number" id="mobile-ob-level" value="88" min="50" max="100" class="mobile-settings-input" style="width:80px;" onchange="document.getElementById('ob-level').value=this.value; recalcRSI();">
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">OS Level:</span>
                  <input type="number" id="mobile-os-level" value="12" min="0" max="50" class="mobile-settings-input" style="width:80px;" onchange="document.getElementById('os-level').value=this.value; recalcRSI();">
                </div>
              </div>
            </div>

            <div class="mobile-filter-section">
              <h3>Display Settings</h3>
              <div class="mobile-settings-row">
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Font Family:</span>
                  <select id="mobile-font-family" class="mobile-settings-input" style="flex:1;margin-left:8px;" onchange="document.getElementById('font-family').value=this.value; updateFont();">
                    <option value="'JetBrains Mono', monospace">JetBrains</option>
                    <option value="'Roboto Mono', monospace">Roboto</option>
                    <option value="'Fira Code', monospace">Fira</option>
                  </select>
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Font Size:</span>
                  <select id="mobile-font-size" class="mobile-settings-input" style="flex:1;margin-left:8px;" onchange="document.getElementById('font-size').value=this.value; updateFont();">
                    <option value="9">9px</option>
                    <option value="10" selected>10px</option>
                    <option value="11">11px</option>
                    <option value="12">12px</option>
                  </select>
                </div>
                <div class="mobile-settings-item">
                  <span class="mobile-settings-label">Level Size:</span>
                  <input type="number" id="mobile-level-size" value="250" min="1" class="mobile-settings-input" style="width:100px;" onchange="document.getElementById('level-size').value=this.value; updateLevel();">
                </div>
              </div>
            </div>

            <div class="mobile-filter-section">
              <h3>Data Settings</h3>
              <div class="mobile-settings-row">
                <div class="mobile-settings-item" style="flex-direction:row;align-items:center;">
                  <span class="mobile-settings-label" style="flex:1;">Live Data Updates:</span>
                  <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                    <input type="checkbox" id="live-data-toggle" checked onchange="toggleLiveData(this.checked)" style="width:20px;height:20px;cursor:pointer;">
                    <span id="live-data-status" style="font-size:0.75rem;color:var(--accent-green);">Enabled</span>
                  </label>
                </div>
              </div>
              <p style="font-size:0.65rem;color:var(--text-muted);margin-top:8px;line-height:1.3;">
                When enabled, fetches latest data from Coinbase API every 5 minutes. When disabled, shows only historical data from last commit.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Filter Button - Visible on all tabs -->
  <button class="mobile-menu-btn" onclick="toggleMobileFilterModal()"></button>

  <script>
    // ==================== CONSTANTS ====================
    const HOURS = Array.from({ length: 24 }, (_, i) => i);
    // ================= RELATIVE VOLUME SETTINGS =================
    const RELVOL_LOOKBACK_HOUR = 2500; // per-hour history
    const RELVOL_LOOKBACK_DAY  = 30;   // cumulative day comparison
    const RELVOL_LOOKBACK_DOW  = 10;   // same hour + same DOW
    const DAYS_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const MONTHS_SHORT = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const MINS = ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'];
    
    const ALL_COLUMNS = [
      { id: 'rng', label: 'Rng', desc: 'Range', default: false, gradient: 'orange', group: 'rng' },
      { id: 'ur', label: 'UR', desc: 'Upper Rng', default: false, gradient: 'orange', group: 'urlr' },
      { id: 'lr', label: 'LR', desc: 'Lower Rng', default: false, gradient: 'orange', group: 'urlr' },
      { id: 'mxr', label: 'MxR', desc: 'Max Range', default: true, gradient: 'orange', group: 'mxr' },
      { id: 'mxrRk', label: 'MxR#', desc: 'Max Rng Rank', default: false, gradient: 'orange-inv', group: 'rank' },
      { id: 'rngRk', label: 'Rng#', desc: 'Range Rank', default: false, gradient: 'orange-inv', group: 'rank' },
      { id: 'urRk', label: 'UR#', desc: 'Upper Rng Rank', default: false, gradient: 'orange-inv', group: 'rank' },
      { id: 'lrRk', label: 'LR#', desc: 'Lower Rng Rank', default: false, gradient: 'orange-inv', group: 'rank' },
      { id: 'up', label: '#Up', desc: 'Lvls Up', default: false, gradient: null },
      { id: 'dn', label: '#Dn', desc: 'Lvls Down', default: false, gradient: null },
      { id: 'totl', label: 'TotL', desc: 'Total Levels', default: false, gradient: 'orange', group: 'mxl' },
      { id: 'toNxtLvl', label: 'ToNxt', desc: 'Distance to next levels (up - down)', default: false, gradient: 'rg' },
      { id: 'mxl', label: 'MxL', desc: 'Max Level', default: false, gradient: 'orange', group: 'mxl' },
      { id: 'mxlRk', label: 'MxL#', desc: 'Max Lvl Rank', default: false, gradient: 'orange-inv', group: 'rank' },
      { id: 'cl', label: '#Cl', desc: 'Net Lvls', default: false, gradient: 'rg', group: 'cl' },
      { id: 'oc', label: 'O-C', desc: 'Open-Close', default: true, gradient: 'rg', group: 'oc' },
      { id: 'oc25', label: 'OC25', desc: ':00-:25 O-C', default: false, gradient: 'rg', group: 'oc' },
      { id: 'oc55', label: 'OC55', desc: ':30-:55 O-C', default: false, gradient: 'rg', group: 'oc' },
      { id: 'ocRk', label: 'OC#', desc: 'O-C Rank', default: false, gradient: 'orange-inv', group: 'rank' },
      { id: 'cdrU', label: 'CDU', desc: 'Cum Day Up', default: false, gradient: 'orange-col', group: 'cdr' },
      { id: 'cdrD', label: 'CDD', desc: 'Cum Day Dn', default: false, gradient: 'orange-col', group: 'cdr' },
      { id: 'mxcd', label: 'MxCD', desc: 'Max Cum D', default: true, gradient: 'orange-col', group: 'mxcd' },
      { id: 'cdr', label: 'CDR', desc: 'Cum Day Rng', default: true, gradient: 'rg-col', group: 'cdrRG' },
      { id: 'hm', label: 'HMin', desc: 'High Min', default: false, gradient: 'minute' },
      { id: 'lm', label: 'LMin', desc: 'Low Min', default: false, gradient: 'minute' },
      { id: 'maxRngBarMin', label: 'MxRBm', desc: 'Max Range Bar Minute', default: false, gradient: 'minute', group: 'maxrngbar' },
      { id: 'maxRngBarVal', label: 'MxRBv', desc: 'Max Range Bar Value', default: false, gradient: 'orange', group: 'maxrngbar' },
      { id: 'o', label: 'Open', desc: 'Open', default: false, gradient: null },
      { id: 'hi', label: 'High', desc: 'High', default: false, gradient: null },
      { id: 'lo', label: 'Low', desc: 'Low', default: false, gradient: null },
      { id: 'c', label: 'Close', desc: 'Close', default: false, gradient: null },
      { id: 'vol', label: 'Vol', desc: 'Volume', default: false, gradient: null },

      // ===== RELATIVE VOLUME (HOURLY) =====
      { id: 'rVol', label: 'rVol', desc: 'Relative Volume (hour)', default: false, gradient: 'purple', group: 'vol' },
      { id: 'rVolC', label: 'rVolC', desc: 'Cumulative Relative Volume (day)', default: false, gradient: 'purple', group: 'vol' },
      { id: 'rVolDOW', label: 'rVolDOW', desc: 'Relative Volume (hour + DOW)', default: false, gradient: 'purple', group: 'vol' },

      // RSI columns
      { id: 'rsiMax', label: 'RSI', desc: 'Max RSI', default: false, gradient: 'purple', group: 'rsi' },
      { id: 'rsiMin', label: 'RSI', desc: 'Min RSI', default: false, gradient: 'purple', group: 'rsi' },
      { id: 'rsiAvg', label: 'RSI', desc: 'Avg RSI', default: false, gradient: 'purple', group: 'rsi' },
      { id: 'rsiOpen', label: 'RSIo', desc: 'RSI Open (first 5-min)', default: false, gradient: 'purple', group: 'rsi' },
      { id: 'rsiClose', label: 'RSIc', desc: 'RSI Close (last 5-min)', default: false, gradient: 'purple', group: 'rsi' },
      { id: 'rsiDelta', label: 'RSI', desc: 'RSI Open - RSI Close', default: false, gradient: 'purple', group: 'rsi' },
      { id: 'rsiOBmin', label: 'OBm', desc: 'First OB minute in hour', default: false, group: 'rsi' },
      { id: 'rsiOSmin', label: 'OSm', desc: 'First OS minute in hour', default: false, group: 'rsi' },
      { id: 'sigMax', label: 'Sig', desc: 'Max Signal', default: false, gradient: 'purple', group: 'sig' },
      { id: 'sigMin', label: 'Sig', desc: 'Min Signal', default: false, gradient: 'purple', group: 'sig' },
      { id: 'sigAvg', label: 'Sig', desc: 'Avg Signal', default: false, gradient: 'purple', group: 'sig' },
      { id: 'obos', label: 'OB/OS', desc: 'OB/OS Hit', default: false, gradient: null },

      // ===== 15-MINUTE RANGE METRICS =====
      { id: 'm15UpperRng', label: '15MUR', desc: '15min Upper Range (Open-High)', default: false, gradient: 'orange', group: 'm15rng' },
      { id: 'm15LowerRng', label: '15MLR', desc: '15min Lower Range (Open-Low)', default: false, gradient: 'orange', group: 'm15rng' },
      { id: 'm15FullRng', label: '15MFR', desc: '15min Full Range (High-Low)', default: false, gradient: 'orange', group: 'm15rng' },
      { id: 'm15MaxRng', label: '15MMx', desc: '15min Max Range (Max of Upper/Lower)', default: false, gradient: 'orange', group: 'm15rng' },

      // Weekly cumulative columns
      { id: 'wCdrU', label: 'WCU', desc: 'Weekly Cum Up', default: false, gradient: 'orange-col', group: 'wcdr' },
      { id: 'wCdrD', label: 'WCD', desc: 'Weekly Cum Dn', default: false, gradient: 'orange-col', group: 'wcdr' },
      { id: 'wMxcd', label: 'WMxC', desc: 'Weekly Max Cum', default: false, gradient: 'orange-col', group: 'wmxcd' },
      { id: 'wCdr', label: 'WCR', desc: 'Weekly Cum Rng', default: false, gradient: 'rg-col', group: 'wcdrRG' },
      // 5PM hourly cumulative columns
      { id: 'p5CdrU', label: '5CU', desc: '5PM Cum Up', default: false, gradient: 'orange-col', group: 'p5cdr' },
      { id: 'p5CdrD', label: '5CD', desc: '5PM Cum Dn', default: false, gradient: 'orange-col', group: 'p5cdr' },
      { id: 'p5Mxcd', label: '5MxC', desc: '5PM Max Cum', default: false, gradient: 'orange-col', group: 'p5mxcd' },
      { id: 'p5Cdr', label: '5CR', desc: '5PM Cum Rng', default: false, gradient: 'rg-col', group: 'p5cdrRG' },
      // Bar count metrics
      { id: 'cumGreenBars', label: 'CumG', desc: 'Cumulative green bars', default: false, gradient: 'orange', group: 'bars' },
      { id: 'cumRedBars', label: 'CumR', desc: 'Cumulative red bars', default: false, gradient: 'orange', group: 'bars' },
      { id: 'barDelta', label: 'Bar', desc: 'Bar delta (red - green)', default: false, gradient: 'rg-col', group: 'bars' },
      { id: 'rthCumGreenBars', label: 'RTHG', desc: 'RTH cumulative green bars', default: false, gradient: 'orange', group: 'bars' },
      { id: 'rthCumRedBars', label: 'RTHR', desc: 'RTH cumulative red bars', default: false, gradient: 'orange', group: 'bars' },
      { id: 'rthBarDelta', label: 'RTHBar', desc: 'RTH bar delta (red - green)', default: false, gradient: 'rg', group: 'bars' },
      // Interval close-open metrics
      { id: 'oc0010', label: 'OC0010', desc: ':10 close - :00 open', default: false, gradient: 'rg', group: 'interval' },
      { id: 'oc1525', label: 'OC1525', desc: ':25 close - :15 open', default: false, gradient: 'rg', group: 'interval' },
      { id: 'oc3040', label: 'OC3040', desc: ':40 close - :30 open', default: false, gradient: 'rg', group: 'interval' },
      { id: 'oc4555', label: 'OC4555', desc: ':55 close - :45 open', default: false, gradient: 'rg', group: 'interval' },
      // After bar metrics (last bar where threshold exceeded)
      { id: 'lastAfterHiBarMin', label: 'LAHm', desc: 'Last bar with after high > threshold', default: false, gradient: 'minute', group: 'afterbar' },
      { id: 'lastAfterLoBarMin', label: 'LALm', desc: 'Last bar with after low > threshold', default: false, gradient: 'minute', group: 'afterbar' },
      { id: 'maxLastAfterBarMin', label: 'MxLABm', desc: 'Max of LAHm and LALm', default: false, gradient: 'minute', group: 'afterbar' },
      // :40 bar after bar metrics
      { id: 'bar40AfterHi', label: 'B40AH', desc: ':40 bar after high', default: false, gradient: 'orange', group: 'b40' },
      { id: 'bar40AfterLo', label: 'B40AL', desc: ':40 bar after low', default: false, gradient: 'orange', group: 'b40' },
      { id: 'maxB40HL', label: 'MxB40', desc: 'Max of B40AH and B40AL', default: false, gradient: 'orange', group: 'b40' },
      // Strength indicators
      { id: 'buyStr', label: 'BuyStr', desc: 'Buy Strength: (C-L)/(H-L)*100', default: false, gradient: 'orange', group: 'strength' },
      { id: 'sellStr', label: 'SellStr', desc: 'Sell Strength: (H-C)/(H-L)*100', default: false, gradient: 'orange', group: 'strength' },
      { id: 'overallStr', label: 'NetStr', desc: 'Overall Strength: (C-O)/(H-L)*100', default: false, gradient: 'rg', group: 'strength' },
    ];
    
    const DAY_TOTAL_COLS = [
      { id: 'dRng', label: 'DRng', desc: 'Day Range', default: true, gradient: 'orange' },
      { id: 'dUR', label: 'DUR', desc: 'Day Up Rng', default: true, gradient: 'orange' },
      { id: 'dLR', label: 'DLR', desc: 'Day Low Rng', default: true, gradient: 'orange' },
      { id: 'dOC', label: 'DO-C', desc: 'Day O-C', default: true, gradient: 'rg' },
      { id: 'dOCH', label: 'O-CH', desc: 'O-C to Hour', default: false, gradient: 'rg' },
      { id: 'dHiHr', label: 'HiHr', desc: 'High Hour', default: false },
      { id: 'dLoHr', label: 'LoHr', desc: 'Low Hour', default: false },
      { id: 'dRthHiHr', label: 'RTHHi', desc: 'RTH High Hour (9a-3p)', default: false },
      { id: 'dRthLoHr', label: 'RTHLo', desc: 'RTH Low Hour (9a-3p)', default: false },
      { id: 'dDD', label: 'DD', desc: 'Drawdown', default: false, gradient: 'orange' },
      { id: 'dRev', label: 'Rev', desc: 'Reversal', default: false, gradient: 'orange' },
      { id: 'dVol', label: 'Vol', desc: 'Total Volume', default: false },
      { id: 'dRsiMed', label: 'RSIm', desc: 'Median RSI', default: false, gradient: 'purple' },
      { id: 'dOpen', label: 'Open', desc: 'Open', default: false },
      { id: 'dHigh', label: 'High', desc: 'High', default: false },
      { id: 'dLow', label: 'Low', desc: 'Low', default: false },
      { id: 'dClose', label: 'Close', desc: 'Close', default: false },
      // 5PM Session metrics
      { id: 'd5pmUR', label: '5pUR', desc: '5PM Up Range', default: false, gradient: 'orange' },
      { id: 'd5pmLR', label: '5pLR', desc: '5PM Low Range', default: false, gradient: 'orange' },
      { id: 'd5pmMx', label: '5pMx', desc: '5PM Max Range', default: false, gradient: 'orange' },
      { id: 'd5pmOC', label: '5pOC', desc: '5PM Open-Close', default: false, gradient: 'rg' },
      // Weekly metrics
      { id: 'wUR', label: 'WUR', desc: 'Weekly Up Range', default: false, gradient: 'orange' },
      { id: 'wLR', label: 'WLR', desc: 'Weekly Low Range', default: false, gradient: 'orange' },
      { id: 'wMx', label: 'WMx', desc: 'Weekly Max Range', default: false, gradient: 'orange' },
      { id: 'wOC', label: 'WOC', desc: 'Weekly Open-Close', default: false, gradient: 'rg' },
      // Extra day-level helpers
      { id: 'dOW', label: 'Day', desc: 'Day of Week (0=Sun)', default: false },
      { id: 'dDayNum', label: 'Day#', desc: 'Day number in month', default: false },
      { id: 'dUpEstHr', label: 'UpEst', desc: 'Hour Up % Established', default: false, gradient: 'esthr' },
      { id: 'dDnEstHr', label: 'DnEst', desc: 'Hour Down % Established', default: false, gradient: 'esthr' },
      { id: 'dRangeEstHr', label: 'RngEst', desc: 'Hour Range % Established', default: false, gradient: 'esthr' },
      { id: 'dHourlyMaxRng', label: 'HMaxR', desc: 'Hourly Max Range', default: false, gradient: 'orange' },
      // ===== RELATIVE VOLUME (DAY) =====
      { id: 'dRelVol', label: 'dRV', desc: 'Day Relative Volume (30d)', default: false, gradient: 'purple' },
      { id: 'dRelVolDOW', label: 'dRV-DOW', desc: 'Day Relative Volume (DOW)', default: false, gradient: 'purple' },
      // RTH RSI
      { id: 'dRthRsiAvg', label: 'RTHRSI', desc: 'RTH Average RSI (9a-3p)', default: false, gradient: 'purple' },
      // Bar count metrics for day totals
      { id: 'dCumGreenBars', label: 'DGreen', desc: 'Day cumulative green bars', default: false, gradient: 'orange' },
      { id: 'dCumRedBars', label: 'DRed', desc: 'Day cumulative red bars', default: false, gradient: 'orange' },
      { id: 'dBarDelta', label: 'DBar', desc: 'Day bar delta (red - green)', default: false, gradient: 'rg' },
      { id: 'dRthCumGreenBars', label: 'RTHGreen', desc: 'RTH cumulative green bars', default: false, gradient: 'orange' },
      { id: 'dRthCumRedBars', label: 'RTHRed', desc: 'RTH cumulative red bars', default: false, gradient: 'orange' },
      { id: 'dRthBarDelta', label: 'RTHBar', desc: 'RTH bar delta (red - green)', default: false, gradient: 'rg' },
    ];
    
    // ==================== STATE ====================
    let rawBars = [];
    let realHours = [];
    let barsByET = {};
    let etDays = {};
    let allETDates = [];
    let availableYears = [];
    let selectedYears = new Set();
    let selectedMonths = new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
    let selectedDays = new Set([0,1,2,3,4,5,6]);
    let selectedOccs = new Set([1,2,3,4,5]);
    let selectedDates = new Set();
    let useDateFilter = false;
    let hourFrom = 0;
    let hourTo = 23;
    let levelSize = 250;
    let visibleColumns = new Set(ALL_COLUMNS.filter(c => c.default).map(c => c.id));
    let visibleDTCols = new Set(DAY_TOTAL_COLS.filter(c => c.default).map(c => c.id));
    let showDayCols = true;
    let showPercentiles = false;
    let sortColumn = 'date';
    let sortDirection = 'desc';
    let sortHour = null;
    let dayHlFrom = 9;
    let dayHlTo = 15;
    let showDayOHLC = true;
    let compareMode = false;
    let showAfterHL = 'off'; // Modes: 'off', 'afterhl' (hour H/L after bar), 'hhcll' (hour H - close, close - hour L)
    let rVolThreshold = 4; // Relative volume highlight threshold
    let calColorDays = new Set([0,1,2,3,4,5,6]);
    let calColorDates = null;
    let calSelectedYears = new Set();
    let columnFilters = [];
    let ocCloseHour = 16;
    let hvSelectedDays = new Set([0,1,2,3,4,5,6]);
    let hvSelectedHour = 9;
    let afterBarThreshold = 400; // Threshold for after bar high/low metrics

    // RSI settings
    let rsiLength = 9;
    let rsiMethod = 'RMA';
    let signalLength = 5;
    let signalMethod = 'EMA';
    let obLevel = 88;
    let osLevel = 12;
    
    // 5PM Session & Weekly tracking
    let pmSessionDays = {}; // Days keyed by 5PM session date
    let weeklyData = {}; // Weekly data keyed by week start (Sunday)
    let hvFilteredDates = new Set(); // Track actual filtered dates from overview for hour view sync
    let showDayColsPanel = false; // Panel visibility (separate from column display)
    
    // 5PM Session tab state
    let pm5SelectedYears = new Set();
    let pm5SelectedDays = new Set([0,1,2,3,4,5,6]);
    let pm5SelectedMonths = new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
    let pm5SelectedOccs = new Set([1,2,3,4,5]);
    let pm5SelectedDates = new Set();
    let pm5UseDateFilter = false;
    let pm5SortColumn = 'date';
    let pm5SortDirection = 'desc';
    let pm5SortHour = null;
    let pm5ShowCumulative = true;
    // Default columns for 5PM Session: Rng, UR, LR, O-C
    let pm5VisibleColumns = new Set(['rng', 'ur', 'lr', 'oc']);

    // ==================== MOBILE DETECTION ====================
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
    let mobileFilterModalOpen = false;
    let currentMobileTab = 'filters';
    let dayViewStatsCollapsed = true; // Start collapsed on mobile

    if (isMobile) {
      document.documentElement.classList.add('is-mobile');
      console.log('Mobile device detected');
      // Initialize day view as collapsed on mobile
      setTimeout(() => {
        const toolbarEl = document.getElementById('day-toolbar-main');
        if (toolbarEl) toolbarEl.classList.add('collapsed');
      }, 100);
    }

    // ==================== MOBILE FILTER MODAL ====================
    function toggleMobileFilterModal() {
      mobileFilterModalOpen = !mobileFilterModalOpen;
      const modal = document.getElementById('mobile-filter-modal');
      modal.classList.toggle('visible', mobileFilterModalOpen);
      if (mobileFilterModalOpen) {
        updateMobileFilterUI();
        syncMobileSettingsInputs();
      }
    }

    function closeMobileFilterModal() {
      mobileFilterModalOpen = false;
      document.getElementById('mobile-filter-modal').classList.remove('visible');
    }

    function switchMobileTab(tabName) {
      currentMobileTab = tabName;
      // Update tab buttons
      document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Update tab panels
      document.querySelectorAll('.mobile-tab-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById(`mobile-tab-${tabName}`).classList.add('active');
    }

    function updateMobileFilterUI() {
      // Update year filters
      const yearContainer = document.getElementById('mobile-year-filters');
      if (yearContainer) {
        yearContainer.innerHTML = '';
        availableYears.forEach(year => {
          const btn = document.createElement('button');
          btn.className = 'mobile-filter-btn';
          btn.textContent = year;
          btn.onclick = () => {
            toggleYear(year);
            updateMobileFilterUI();
          };
          if (selectedYears.has(year)) btn.classList.add('active');
          yearContainer.appendChild(btn);
        });
      }

      // Update month filters
      const monthContainer = document.getElementById('mobile-month-filters');
      if (monthContainer) {
        monthContainer.innerHTML = '';
        MONTHS_SHORT.forEach((month, idx) => {
          const btn = document.createElement('button');
          btn.className = 'mobile-filter-btn';
          btn.textContent = month;
          btn.onclick = () => {
            toggleMonth(idx + 1);
            updateMobileFilterUI();
          };
          if (selectedMonths.has(idx + 1)) btn.classList.add('active');
          monthContainer.appendChild(btn);
        });
      }

      // Update day filters
      const dayContainer = document.getElementById('mobile-day-filters');
      if (dayContainer) {
        dayContainer.innerHTML = '';
        DAYS_SHORT.forEach((day, idx) => {
          const btn = document.createElement('button');
          btn.className = 'mobile-filter-btn';
          btn.textContent = day;
          btn.onclick = () => {
            toggleDay(idx);
            updateMobileFilterUI();
          };
          if (selectedDays.has(idx)) btn.classList.add('active');
          dayContainer.appendChild(btn);
        });
      }

      // Update occurrence filters
      const occContainer = document.getElementById('mobile-occ-filters');
      if (occContainer) {
        occContainer.innerHTML = '';
        ['1st', '2nd', '3rd', '4th', '5th'].forEach((occ, idx) => {
          const btn = document.createElement('button');
          btn.className = 'mobile-filter-btn';
          btn.textContent = occ;
          btn.onclick = () => {
            toggleOcc(idx + 1);
            updateMobileFilterUI();
          };
          if (selectedOccs.has(idx + 1)) btn.classList.add('active');
          occContainer.appendChild(btn);
        });
      }

      // Update date count
      const dateCount = document.getElementById('mobile-date-count');
      if (dateCount) {
        dateCount.textContent = selectedDates.size;
      }

      // Update mobile date list
      const mobileDateList = document.getElementById('mobile-date-list');
      if (mobileDateList && allETDates && allETDates.length > 0) {
        mobileDateList.innerHTML = '';
        allETDates.forEach(date => {
          const dateBtn = document.createElement('button');
          dateBtn.className = 'mobile-filter-btn';
          dateBtn.style.margin = '2px';
          dateBtn.style.fontSize = '0.65rem';
          dateBtn.textContent = date;
          dateBtn.onclick = () => {
            if (selectedDates.has(date)) {
              selectedDates.delete(date);
            } else {
              selectedDates.add(date);
            }
            useDateFilter = selectedDates.size > 0;
            renderTable();
            render5pmSession();
            if (typeof renderCalendar === 'function') renderCalendar();
            updateMobileFilterUI();
          };
          if (selectedDates.has(date)) dateBtn.classList.add('active');
          mobileDateList.appendChild(dateBtn);
        });
      }

      // Update hour dropdowns (ensure they're populated with all 24 hours)
      const mobileHourFrom = document.getElementById('mobile-hour-from');
      const mobileHourTo = document.getElementById('mobile-hour-to');
      if (mobileHourFrom && mobileHourFrom.options.length === 0) {
        // Populate with all 24 hours
        for (let h = 0; h < 24; h++) {
          const ampm = h >= 12 ? 'PM' : 'AM';
          const disp = h === 0 ? 12 : h > 12 ? h - 12 : h;
          const option = document.createElement('option');
          option.value = h;
          option.textContent = `${disp}${ampm}`;
          mobileHourFrom.appendChild(option);
        }
        mobileHourFrom.value = hourFrom;
      }
      if (mobileHourTo && mobileHourTo.options.length === 0) {
        // Populate with all 24 hours
        for (let h = 0; h < 24; h++) {
          const ampm = h >= 12 ? 'PM' : 'AM';
          const disp = h === 0 ? 12 : h > 12 ? h - 12 : h;
          const option = document.createElement('option');
          option.value = h;
          option.textContent = `${disp}${ampm}`;
          mobileHourTo.appendChild(option);
        }
        mobileHourTo.value = hourTo;
      }

      // Update column grid
      updateMobileColumnGrid();
      updateMobileDayTotalsGrid();
      updateMobileActiveFilters();
    }

    function updateMobileColumnGrid() {
      const container = document.getElementById('mobile-col-grid');
      if (!container) return;
      container.innerHTML = '';

      ALL_COLUMNS.forEach(col => {
        const item = document.createElement('div');
        item.className = 'mobile-settings-item';
        item.style.padding = '8px';
        item.style.cursor = 'pointer';
        item.onclick = () => {
          toggleColumn(col.id);
          updateMobileColumnGrid();
        };

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = visibleColumns.has(col.id);
        checkbox.style.accentColor = 'var(--accent-btc)';
        checkbox.onclick = (e) => e.stopPropagation();
        checkbox.onchange = () => {
          toggleColumn(col.id);
        };

        const label = document.createElement('span');
        label.className = 'mobile-settings-label';
        label.textContent = `${col.label} (${col.desc})`;
        label.style.flex = '1';
        label.style.marginLeft = '8px';

        item.appendChild(checkbox);
        item.appendChild(label);
        container.appendChild(item);
      });
    }

    function updateMobileDayTotalsGrid() {
      const container = document.getElementById('mobile-dt-col-grid');
      if (!container) return;
      container.innerHTML = '';

      DAY_TOTAL_COLS.forEach(col => {
        const item = document.createElement('div');
        item.className = 'mobile-settings-item';
        item.style.padding = '8px';
        item.style.cursor = 'pointer';
        item.onclick = () => {
          toggleDayTotalCol(col.id);
          updateMobileDayTotalsGrid();
        };

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = visibleDayTotalCols.has(col.id);
        checkbox.style.accentColor = 'var(--accent-blue)';
        checkbox.onclick = (e) => e.stopPropagation();
        checkbox.onchange = () => {
          toggleDayTotalCol(col.id);
        };

        const label = document.createElement('span');
        label.className = 'mobile-settings-label';
        label.textContent = `${col.label} (${col.desc})`;
        label.style.flex = '1';
        label.style.marginLeft = '8px';

        item.appendChild(checkbox);
        item.appendChild(label);
        container.appendChild(item);
      });

      // Update show/hide button text
      const showBtn = document.getElementById('mobile-show-dt-text');
      if (showBtn) {
        showBtn.textContent = showDayCols ? 'Hide Day Totals' : 'Show Day Totals';
      }
    }

    function editMobileFilter(idx) {
      const filter = columnFilters[idx];
      if (!filter) return;

      // Populate the mobile filter inputs
      document.getElementById('mobile-filter-hour').value = filter.hour;
      document.getElementById('mobile-filter-column').value = filter.col;
      document.getElementById('mobile-filter-op').value = filter.op;
      const filterValue = document.getElementById('mobile-filter-value');
      filterValue.value = filter.val;

      // Also update desktop inputs for consistency
      document.getElementById('filter-hour').value = filter.hour;

      // Update column select
      const hourVal = filter.hour;
      const currentHourType = hourVal === 'day' ? 'day' : 'hour';
      if (currentHourType !== previousHourType) {
        const colSel = document.getElementById('mobile-filter-column');
        const options = hourVal === 'day'
          ? DAY_TOTAL_COLS.map(c => `<option value="${c.id}">${c.label}</option>`).join('')
          : ALL_COLUMNS.map(c => `<option value="${c.id}">${c.label}</option>`).join('');
        if (colSel) colSel.innerHTML = options;
        previousHourType = currentHourType;
      }
      document.getElementById('mobile-filter-column').value = filter.col;

      // Focus the value input
      filterValue.focus();
      filterValue.select();

      // Remove the old filter
      removeFilter(idx);
    }

    function updateMobileActiveFilters() {
      const container = document.getElementById('mobile-active-filters');
      if (!container) return;

      if (columnFilters.length === 0) {
        container.innerHTML = '<div style="font-size:0.7rem;color:var(--text-muted);">No active filters</div>';
      } else {
        container.innerHTML = '';
        columnFilters.forEach((filter, idx) => {
          let hourLabel;
          if (filter.hour === 'day') {
            hourLabel = 'Day';
          } else if (filter.hour === 'any') {
            hourLabel = 'Any';
          } else {
            hourLabel = formatHourHeader(parseInt(filter.hour));
          }
          const colDef = filter.hour === 'day' ? DAY_TOTAL_COLS.find(c => c.id === filter.col) : ALL_COLUMNS.find(c => c.id === filter.col);
          const logic = filter.logic || 'AND';

          const tag = document.createElement('div');
          tag.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(74,222,128,0.15);border:1px solid rgba(74,222,128,0.3);border-radius:6px;margin-bottom:8px;';

          // AND/OR selector
          const logicSelect = document.createElement('select');
          logicSelect.style.cssText = 'padding:2px 4px;background:rgba(0,0,0,0.3);border:1px solid rgba(74,222,128,0.3);border-radius:3px;color:var(--accent-green);font-size:0.65rem;margin-right:6px;';
          logicSelect.innerHTML = `
            <option value="AND" ${logic === 'AND' ? 'selected' : ''}>AND</option>
            <option value="OR" ${logic === 'OR' ? 'selected' : ''}>OR</option>
          `;
          logicSelect.onchange = () => {
            updateFilterLogic(idx, logicSelect.value);
            updateMobileActiveFilters();
          };

          const text = document.createElement('span');
          text.style.cssText = 'font-size:0.7rem;color:var(--accent-green);flex:1;cursor:pointer;';
          text.innerHTML = `${hourLabel} ${colDef?.label || filter.col} ${filter.op} <u>${filter.val}</u>`;
          text.title = 'Tap to edit';
          text.onclick = () => editMobileFilter(idx);

          const removeBtn = document.createElement('button');
          removeBtn.textContent = '';
          removeBtn.style.cssText = 'background:rgba(248,113,113,0.2);border:none;color:var(--accent-red);font-size:1.2rem;width:28px;height:28px;border-radius:50%;cursor:pointer;margin-left:6px;';
          removeBtn.onclick = (e) => {
            e.stopPropagation(); // Prevent edit trigger
            removeColumnFilter(idx);
            updateMobileActiveFilters();
          };

          tag.appendChild(logicSelect);
          tag.appendChild(text);
          tag.appendChild(removeBtn);
          container.appendChild(tag);
        });
      }
    }

    function addMobileColumnFilter() {
      const hour = document.getElementById('mobile-filter-hour').value;
      const column = document.getElementById('mobile-filter-column').value;
      const op = document.getElementById('mobile-filter-op').value;
      const value = parseFloat(document.getElementById('mobile-filter-value').value);

      if (!column || isNaN(value)) {
        alert('Please select a column and enter a valid value');
        return;
      }

      // Also update the desktop version
      document.getElementById('filter-hour').value = hour;
      document.getElementById('filter-column').value = column;
      document.getElementById('filter-op').value = op;
      document.getElementById('filter-value').value = value;

      addColumnFilter();
      updateMobileActiveFilters();
      document.getElementById('mobile-filter-value').value = '';
    }

    function syncMobileSettingsInputs() {
      // Sync RSI settings
      document.getElementById('mobile-rsi-length').value = document.getElementById('rsi-length').value;
      document.getElementById('mobile-rsi-method').value = document.getElementById('rsi-method').value;
      document.getElementById('mobile-signal-length').value = document.getElementById('signal-length').value;
      document.getElementById('mobile-signal-method').value = document.getElementById('signal-method').value;
      document.getElementById('mobile-ob-level').value = document.getElementById('ob-level').value;
      document.getElementById('mobile-os-level').value = document.getElementById('os-level').value;

      // Sync display settings
      document.getElementById('mobile-font-family').value = document.getElementById('font-family').value;
      document.getElementById('mobile-font-size').value = document.getElementById('font-size').value;
      document.getElementById('mobile-level-size').value = document.getElementById('level-size').value;

      // Sync gradient mode
      document.getElementById('mobile-gradient-mode').value = document.getElementById('gradient-mode').value;

      // Sync established %
      document.getElementById('mobile-est-pct').value = document.getElementById('est-pct').value;
    }

    // Close modal when clicking outside
    document.addEventListener('click', (e) => {
      if (mobileFilterModalOpen && e.target.id === 'mobile-filter-modal') {
        closeMobileFilterModal();
      }
    });

    // ==================== DAY VIEW STATS COLLAPSE ====================
    function toggleDayViewStats() {
      dayViewStatsCollapsed = !dayViewStatsCollapsed;
      const statsEl = document.getElementById('day-view-stats-collapsible');
      const btnEl = document.getElementById('day-view-collapse-btn');
      const toolbarEl = document.getElementById('day-toolbar-main');

      if (dayViewStatsCollapsed) {
        statsEl.classList.add('collapsed');
        btnEl.classList.add('collapsed');
        if (toolbarEl) toolbarEl.classList.add('collapsed');
        statsEl.style.maxHeight = '0px';
      } else {
        statsEl.classList.remove('collapsed');
        btnEl.classList.remove('collapsed');
        if (toolbarEl) toolbarEl.classList.remove('collapsed');
        statsEl.style.maxHeight = statsEl.scrollHeight + 'px';
      }
    }

    // ==================== HELPER FUNCTIONS ====================
    function setAllMonths() {
      selectedMonths = new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
      document.querySelectorAll('[data-month]').forEach(b => b.classList.add('active'));
      useDateFilter = false;
      selectedDates.clear();
      updateDatePickerUI();
      renderTable();
    }

    function setAllDays() {
      selectedDays = new Set([0,1,2,3,4,5,6]);
      document.querySelectorAll('[data-day]').forEach(b => b.classList.add('active'));
      useDateFilter = false;
      selectedDates.clear();
      updateDatePickerUI();
      renderTable();
    }

    // Handle orientation changes
    window.addEventListener('orientationchange', () => {
      setTimeout(() => {
        if (window.innerWidth <= 768) {
          document.documentElement.classList.add('is-mobile');
        } else {
          document.documentElement.classList.remove('is-mobile');
        }
      }, 100);
    });
    
    // ==================== INIT ====================
    document.getElementById('file-input').addEventListener('change', handleFileSelect);

    function getSortedHourKeys(day) {
      return Object.keys(day.hrs || {})
        .map(Number)
        .sort((a, b) => a - b)
        .map(h => h.toString());
    }

    // ==================== FILE ====================
    
    // Auto-load data from GitHub Pages
    const DATA_URLS = [
      './data/bitcoin_5m_combined.csv',
      './data/bitcoin_5m_coinbase.csv',
      'data/bitcoin_5m_combined.csv',
      'data/bitcoin_5m_coinbase.csv'
    ];

    // Global variable for live data fetcher
    let liveDataFetcher = null;

    async function autoLoadData() {
      // Check if we're on GitHub Pages or a web server (not file://)
      if (window.location.protocol === 'file:') {
        console.log('Local file, skipping auto-load');
        return false;
      }

      document.getElementById('upload-screen').style.display = 'none';
      document.getElementById('loading-screen').style.display = 'flex';
      document.getElementById('loading-text').textContent = 'Loading Bitcoin data with live updates...';

      try {
        // Check if live data is enabled (default: true)
        const liveDataEnabled = localStorage.getItem('btc-live-data-enabled') !== 'false';

        // Create live data fetcher
        liveDataFetcher = new LiveDataFetcher({
          dataFile: 'data/bitcoin_5m_combined.csv',
          refreshInterval: 5 * 60 * 1000, // 5 minutes
          enabled: liveDataEnabled,

          // Callback when new data arrives
          onDataUpdate: (mergedData) => {
            console.log(`Data updated: ${mergedData.length} total bars`);

            // Convert to rawBars format
            rawBars = mergedData.map(bar => ({
              timestamp: new Date(bar.timestamp),
              open: parseFloat(bar.open),
              high: parseFloat(bar.high),
              low: parseFloat(bar.low),
              close: parseFloat(bar.close),
              volume: parseFloat(bar.volume) || 0,
            })).filter(b => !isNaN(b.open) && b.timestamp instanceof Date && !isNaN(b.timestamp.getTime()));

            if (rawBars.length === 0) {
              throw new Error('No valid data found');
            }

            // Process data
            calculateRSI();
            calculateBarMetrics();
            processDataET();

            // Update UI (only if not first load)
            if (document.getElementById('app').classList.contains('visible')) {
              renderTable();
              if (window.location.hash === '#dayview') renderDayView();
              if (window.location.hash === '#hourview') renderHourView();
              if (window.location.hash === '#pm5session') render5pmSession();
              console.log(' Data refreshed and UI updated');
            } else {
              // First load - initialize UI
              populateFilterSelects();
              document.getElementById('loading-screen').style.display = 'none';
              document.getElementById('app').classList.add('visible');
              renderTable();
              populateDayViewSelect();
              populateHourViewSelect();
              populateCalendarYearSelect();
              initPm5YearFilters();
              console.log(`Loaded ${rawBars.length} bars, ${allETDates.length} days`);
            }
          },

          // Callback for status changes
          onStatusChange: (statusInfo) => {
            updateLiveStatusIndicator(statusInfo);
          }
        });

        // Start live data fetching
        await liveDataFetcher.start();
        return true;

      } catch (error) {
        console.error('Failed to start live data:', error);
        showError(`Failed to load live data: ${error.message}`);
        return false;
      }
    }

    // Update live status indicator
    function updateLiveStatusIndicator(statusInfo) {
      const indicator = document.getElementById('live-status');
      if (!indicator) return;

      // Update status class
      indicator.className = 'live-status-indicator ' + statusInfo.status;

      // Update text - set both short and full versions
      const textShort = indicator.querySelector('.live-text-short');
      const textFull = indicator.querySelector('.live-text-full');

      if (textShort && textFull) {
        // Short text: just status
        const shortTexts = {
          'loading': 'Loading',
          'live': 'Live',
          'refreshing': 'Sync',
          'error': 'Error',
          'disabled': 'Off',
          'stopped': 'Off'
        };
        textShort.textContent = shortTexts[statusInfo.status] || 'Live';

        // Full text: complete message
        textFull.textContent = statusInfo.message;
      }

      // Update title with details
      const details = `Historical: ${statusInfo.historicalBarCount.toLocaleString()} bars\nLive: ${statusInfo.liveBarCount.toLocaleString()} bars\nLast update: ${statusInfo.timestamp.toLocaleTimeString()}`;
      indicator.title = details;
    }

    // Manual refresh function
    function manualRefresh() {
      if (!liveDataFetcher) {
        console.log('Live data fetcher not initialized');
        return;
      }

      console.log('Manual refresh triggered');
      liveDataFetcher.refresh();
    }

    // Toggle live data updates
    function toggleLiveData(enabled) {
      if (!liveDataFetcher) {
        console.log('Live data fetcher not initialized');
        return;
      }

      const statusSpan = document.getElementById('live-data-status');

      if (enabled) {
        liveDataFetcher.enable();
        if (statusSpan) {
          statusSpan.textContent = 'Enabled';
          statusSpan.style.color = 'var(--accent-green)';
        }
        console.log('Live data enabled');
      } else {
        liveDataFetcher.disable();
        if (statusSpan) {
          statusSpan.textContent = 'Disabled';
          statusSpan.style.color = 'var(--text-muted)';
        }
        console.log('Live data disabled');
      }
    }

    // Add click handler to status indicator for manual refresh
    document.addEventListener('DOMContentLoaded', () => {
      const statusIndicator = document.getElementById('live-status');
      if (statusIndicator) {
        statusIndicator.addEventListener('click', manualRefresh);
      }

      // Initialize live data toggle state
      const liveDataToggle = document.getElementById('live-data-toggle');
      if (liveDataToggle) {
        const enabled = localStorage.getItem('btc-live-data-enabled') !== 'false';
        liveDataToggle.checked = enabled;

        const statusSpan = document.getElementById('live-data-status');
        if (statusSpan) {
          statusSpan.textContent = enabled ? 'Enabled' : 'Disabled';
          statusSpan.style.color = enabled ? 'var(--accent-green)' : 'var(--text-muted)';
        }
      }
    });

    function buildRealHours(data) {
      const hourSet = new Set();
      data.forEach(d => {
        Object.keys(d.hrs || {}).forEach(h => hourSet.add(Number(h)));
      });
      return [...hourSet].sort((a, b) => a - b);
    }
    
    const colGrid = document.getElementById('col-grid');
    ALL_COLUMNS.forEach(col => {
      colGrid.innerHTML += `<label class="col-item" title="${col.desc}"><input type="checkbox" ${col.default ? 'checked' : ''} onchange="toggleColumn('${col.id}')"><span class="col-label">${col.label}</span><span class="col-desc">${col.desc}</span></label>`;
    });
    
    const dtColGrid = document.getElementById('dt-col-grid');
    DAY_TOTAL_COLS.forEach(col => {
      dtColGrid.innerHTML += `<label class="dt-col-item"><input type="checkbox" ${col.default ? 'checked' : ''} data-dtcol="${col.id}" onchange="toggleDTCol('${col.id}')"><span>${col.label}</span></label>`;
    });

    // Populate PM5 column grid (using subset of ALL_COLUMNS that make sense for hourly data)
    const pm5ColGrid = document.getElementById('pm5-col-grid');
    ALL_COLUMNS.forEach(col => {
      const isDefault = pm5VisibleColumns.has(col.id);
      pm5ColGrid.innerHTML += `<label class="col-item" title="${col.desc}"><input type="checkbox" ${isDefault ? 'checked' : ''} onchange="togglePm5Column('${col.id}')"><span class="col-label">${col.label}</span><span class="col-desc">${col.desc}</span></label>`;
    });

    document.addEventListener('click', (e) => {
      const dd = document.getElementById('date-picker-dropdown');
      const btn = document.querySelector('.date-picker-btn');
      if (dd && btn && !dd.contains(e.target) && !btn.contains(e.target)) dd.classList.remove('visible');
    });
    
    // Auto-load data on page load (for GitHub Pages)
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => autoLoadData(), 100);
    });
    
    // ==================== TAB SWITCHING ====================
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
      if (tab === 'dayview' && allETDates.length > 0) renderDayView();
      if (tab === 'hourview' && allETDates.length > 0) renderHourView();
      if (tab === 'calendar' && allETDates.length > 0) renderCalendar();
      if (tab === 'pm5session' && allETDates.length > 0) render5pmSession();
    }
    
    function processCSVText(csvText) {
      // Handle both CSV text and array of objects
      if (Array.isArray(csvText)) {
        // Already parsed data
        try {
          rawBars = csvText.map(row => ({
            timestamp: new Date(row.timestamp),
            open: parseFloat(row.open),
            high: parseFloat(row.high),
            low: parseFloat(row.low),
            close: parseFloat(row.close),
            volume: parseFloat(row.volume) || 0,
          })).filter(b => !isNaN(b.open) && b.timestamp instanceof Date && !isNaN(b.timestamp.getTime())).sort((a, b) => a.timestamp - b.timestamp);

          if (rawBars.length === 0) {
            throw new Error('No valid data found');
          }

          calculateRSI();
          calculateBarMetrics();
          processDataET();
          populateFilterSelects();
          document.getElementById('loading-screen').style.display = 'none';
          document.getElementById('app').classList.add('visible');
          renderTable();
          populateDayViewSelect();
          populateHourViewSelect();
          populateCalendarYearSelect();
          initPm5YearFilters();

          console.log(`Loaded ${rawBars.length} bars, ${allETDates.length} days`);
        } catch (err) {
          showError(err.message);
        }
        return;
      }

      // Original CSV text parsing
      Papa.parse(csvText, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          try {
            rawBars = results.data.map(row => ({
              timestamp: new Date(row.timestamp),
              open: parseFloat(row.open),
              high: parseFloat(row.high),
              low: parseFloat(row.low),
              close: parseFloat(row.close),
              volume: parseFloat(row.volume) || 0,
            })).filter(b => !isNaN(b.open) && b.timestamp instanceof Date && !isNaN(b.timestamp.getTime())).sort((a, b) => a.timestamp - b.timestamp);

            if (rawBars.length === 0) {
              throw new Error('No valid data found in CSV');
            }

            calculateRSI();
            calculateBarMetrics();
            processDataET();
            populateFilterSelects();
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app').classList.add('visible');
            renderTable();
            populateDayViewSelect();
            populateHourViewSelect();
            populateCalendarYearSelect();
            initPm5YearFilters();

            console.log(`Loaded ${rawBars.length} bars, ${allETDates.length} days`);
          } catch (err) {
            showError(err.message);
          }
        },
        error: (err) => showError(err.message)
      });
    }
    
    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById('upload-screen').style.display = 'none';
      document.getElementById('loading-screen').style.display = 'flex';
      document.getElementById('loading-text').textContent = 'Processing file...';
      
      Papa.parse(file, {
        header: true, skipEmptyLines: true,
        complete: function(results) {
          try {
            rawBars = results.data.map(row => ({
              timestamp: new Date(row.timestamp),
              open: parseFloat(row.open),
              high: parseFloat(row.high),
              low: parseFloat(row.low),
              close: parseFloat(row.close),
              volume: parseFloat(row.volume) || 0,
            })).filter(b => !isNaN(b.open) && b.timestamp instanceof Date && !isNaN(b.timestamp.getTime())).sort((a, b) => a.timestamp - b.timestamp);

            calculateRSI();
            calculateBarMetrics();
            processDataET();
            populateFilterSelects();
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app').classList.add('visible');
            renderTable();
            populateDayViewSelect();
            populateHourViewSelect();
            populateCalendarYearSelect();
            initPm5YearFilters();
          } catch (err) { showError(err.message); }
        },
        error: (err) => showError(err.message)
      });
    }
    
    function showError(msg) {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('upload-screen').style.display = 'flex';
      document.getElementById('error-msg').textContent = msg;
      document.getElementById('error-msg').style.display = 'block';
    }
    
    function loadNewFile() {
      document.getElementById('app').classList.remove('visible');
      document.getElementById('upload-screen').style.display = 'flex';
      document.getElementById('error-msg').style.display = 'none';
      document.getElementById('file-input').value = '';
    }
    
    // ==================== RSI CALCULATION ====================
    function maCalc(arr, length, method) {
      const result = new Array(arr.length).fill(null);
      if (arr.length < length) return result;
      
      if (method === 'SMA') {
        for (let i = length - 1; i < arr.length; i++) {
          let sum = 0;
          for (let j = 0; j < length; j++) sum += arr[i - j];
          result[i] = sum / length;
        }
      } else if (method === 'EMA') {
        const k = 2 / (length + 1);
        let ema = 0;
        for (let i = 0; i < length; i++) ema += arr[i];
        ema /= length;
        result[length - 1] = ema;
        for (let i = length; i < arr.length; i++) {
          ema = arr[i] * k + ema * (1 - k);
          result[i] = ema;
        }
      } else if (method === 'RMA') {
        const alpha = 1 / length;
        let rma = 0;
        for (let i = 0; i < length; i++) rma += arr[i];
        rma /= length;
        result[length - 1] = rma;
        for (let i = length; i < arr.length; i++) {
          rma = alpha * arr[i] + (1 - alpha) * rma;
          result[i] = rma;
        }
      }
      return result;
    }
    
    function calculateRSI() {
      rsiLength = parseInt(document.getElementById('rsi-length')?.value) || 9;
      rsiMethod = document.getElementById('rsi-method')?.value || 'RMA';
      signalLength = parseInt(document.getElementById('signal-length')?.value) || 5;
      signalMethod = document.getElementById('signal-method')?.value || 'EMA';
      obLevel = parseInt(document.getElementById('ob-level')?.value) || 88;
      osLevel = parseInt(document.getElementById('os-level')?.value) || 12;
      
      const closes = rawBars.map(b => b.close);
      const highs = rawBars.map(b => b.high);
      const lows = rawBars.map(b => b.low);
      const n = closes.length;
      
      // Calculate Ultimate RSI
      const upper = [], lower = [], range = [], diff = [];
      for (let i = 0; i < n; i++) {
        let hi = -Infinity, lo = Infinity;
        for (let j = Math.max(0, i - rsiLength + 1); j <= i; j++) {
          hi = Math.max(hi, closes[j]);
          lo = Math.min(lo, closes[j]);
        }
        upper[i] = hi;
        lower[i] = lo;
        range[i] = hi - lo;
        
        const d = i > 0 ? closes[i] - closes[i-1] : 0;
        const prevUpper = i > 0 ? upper[i-1] : hi;
        const prevLower = i > 0 ? lower[i-1] : lo;
        diff[i] = hi > prevUpper ? range[i] : lo < prevLower ? -range[i] : d;
      }
      
      const absDiff = diff.map(d => Math.abs(d));
      const num = maCalc(diff, rsiLength, rsiMethod);
      const den = maCalc(absDiff, rsiLength, rsiMethod);
      
      const rsiVals = num.map((n, i) => {
        if (n === null || den[i] === null || den[i] === 0) return null;
        return (n / den[i]) * 50 + 50;
      });
      
      const sigVals = maCalc(rsiVals.map(v => v ?? 50), signalLength, signalMethod);
      
      rawBars.forEach((bar, i) => {
        bar.rsi = rsiVals[i];
        bar.signal = sigVals[i];
      });
    }

    function calculateBarMetrics() {
      // Calculate 5-minute bar relative volume
      // Group bars by hour and minute
      const barsByHourMin = {};
      rawBars.forEach(bar => {
        const etDate = getETDateString(bar.timestamp);
        const etHour = getETHour(bar.timestamp);
        const etMin = getETMinute(bar.timestamp);
        const key = `${etHour}-${etMin}`;
        if (!barsByHourMin[key]) barsByHourMin[key] = [];
        barsByHourMin[key].push(bar);
      });

      // Calculate rVol for each bar based on historical average for same hour:minute
      Object.keys(barsByHourMin).forEach(key => {
        const bars = barsByHourMin[key];
        bars.forEach((bar, idx) => {
          // Get historical bars for same hour:minute (lookback 2500)
          const historicalBars = bars.slice(Math.max(0, idx - RELVOL_LOOKBACK_HOUR), idx);
          if (historicalBars.length > 0) {
            const avgVol = historicalBars.reduce((sum, b) => sum + b.volume, 0) / historicalBars.length;
            bar.rVol = avgVol > 0 ? bar.volume / avgVol : null;
          } else {
            bar.rVol = null;
          }
        });
      });
    }

    function recalcRSI() {
      if (rawBars.length === 0) return;
      calculateRSI();
      calculateBarMetrics();
      processDataET();
      renderTable();
    }
    
    // ==================== EASTERN TIME ====================
    function getETOffset(date) {
      const year = date.getUTCFullYear();
      const mar = new Date(Date.UTC(year, 2, 1));
      while (mar.getUTCDay() !== 0) mar.setUTCDate(mar.getUTCDate() + 1);
      mar.setUTCDate(mar.getUTCDate() + 7);
      mar.setUTCHours(7);
      const nov = new Date(Date.UTC(year, 10, 1));
      while (nov.getUTCDay() !== 0) nov.setUTCDate(nov.getUTCDate() + 1);
      nov.setUTCHours(6);
      return (date >= mar && date < nov) ? -4 : -5;
    }
    
    function utcToET(utcDate) { return new Date(utcDate.getTime() + getETOffset(utcDate) * 3600000); }
    function getETDateString(utcDate) { return utcToET(utcDate).toISOString().split('T')[0]; }
    function getETHour(utcDate) { return utcToET(utcDate).getUTCHours(); }
    function getETMinute(utcDate) { return utcToET(utcDate).getUTCMinutes(); }
    
    // ==================== LEVEL CALCS ====================
    function getLevel(price) { return Math.floor(price / levelSize); }
    function calcLvlUp(o, h) { return Math.max(0, getLevel(h) - getLevel(o)); }
    function calcLvlDn(o, l) { return Math.max(0, getLevel(o) - getLevel(l)); }
    function calcLvlCl(o, c) { return getLevel(c) - getLevel(o); }
    function calcDayOcc(date) { return Math.ceil(new Date(date + 'T12:00:00Z').getUTCDate() / 7); }
    
    // ==================== DATA PROCESSING ====================
    function processDataET() {
      etDays = {};
      barsByET = {};
      
      rawBars.forEach(bar => {
        const etDate = getETDateString(bar.timestamp);
        const etHour = getETHour(bar.timestamp);
        const etMin = getETMinute(bar.timestamp);
        
        if (!barsByET[etDate]) barsByET[etDate] = [];
        barsByET[etDate].push({ ...bar, etHour, etMin });
        
        if (!etDays[etDate]) {
          const etDateObj = new Date(etDate + 'T12:00:00Z');
          etDays[etDate] = {
            date: etDate,
            month: etDateObj.getUTCMonth() + 1,
            dow: etDateObj.getUTCDay(),
            occ: calcDayOcc(etDate),
            hrs: {},
            dO: null, dH: -Infinity, dL: Infinity, dC: null,
            dHiHr: null, dLoHr: null, dHiIdx: -1, dLoIdx: -1,
          };
        }
        
        const day = etDays[etDate];
        if (etHour === 0 && day.dO === null) day.dO = bar.open;
        if (etHour === 23) day.dC = bar.close;
        if (bar.high > day.dH) { day.dH = bar.high; day.dHiHr = etHour; }
        if (bar.low < day.dL) { day.dL = bar.low; day.dLoHr = etHour; }
        
        if (!day.hrs[etHour]) {
          day.hrs[etHour] = { 
            o: bar.open, h: bar.high, l: bar.low, c: bar.close, v: 0, 
            hm: etMin, lm: etMin, greenBars: 0,
            rsiVals: [], sigVals: []
          };
        }
        
        const hd = day.hrs[etHour];
        hd.c = bar.close;
        hd.v += bar.volume;
        if (bar.high > hd.h) { hd.h = bar.high; hd.hm = etMin; }
        if (bar.low < hd.l) { hd.l = bar.low; hd.lm = etMin; }
        if (bar.close >= bar.open) hd.greenBars++;
        if (bar.rsi != null) hd.rsiVals.push(bar.rsi);
        if (bar.signal != null) hd.sigVals.push(bar.signal);
      });

      // Calculate "after bar high" and "after bar low" for each bar
      Object.keys(barsByET).forEach(etDate => {
        const dayBars = barsByET[etDate];
        dayBars.forEach((bar, idx) => {
          // Find max high and min low of all bars after this one in the same hour
          let afterHigh = -Infinity;
          let afterLow = Infinity;

          for (let i = idx + 1; i < dayBars.length; i++) {
            const laterBar = dayBars[i];
            // Only consider bars in the same hour
            if (laterBar.etHour === bar.etHour) {
              if (laterBar.high > afterHigh) afterHigh = laterBar.high;
              if (laterBar.low < afterLow) afterLow = laterBar.low;
            } else {
              break; // Different hour, stop
            }
          }

          // Calculate after bar high/low as the difference from current bar's close
          bar.afterBarHigh = afterHigh > -Infinity ? Math.round(afterHigh - bar.close) : null;
          bar.afterBarLow = afterLow < Infinity ? Math.round(bar.close - afterLow) : null;

          // Calculate strength indicators for this bar
          const barRng = bar.high - bar.low;
          if (barRng > 0) {
            bar.buyStr = Math.round(((bar.close - bar.low) / barRng) * 100);
            bar.sellStr = Math.round(((bar.high - bar.close) / barRng) * 100);
            bar.overallStr = Math.round(((bar.close - bar.open) / barRng) * 100);
          } else {
            bar.buyStr = null;
            bar.sellStr = null;
            bar.overallStr = null;
          }
        });
      });

      // Second pass: calculate derived metrics
      Object.values(etDays).forEach(day => {
        if (day.dO === null) {
          for (let h = 0; h < 24; h++) {
            if (day.hrs[h]) { day.dO = day.hrs[h].o; break; }
          }
        }
        if (day.dC === null) {
          for (let h = 23; h >= 0; h--) {
            if (day.hrs[h]) { day.dC = day.hrs[h].c; break; }
          }
        }
        
        day.dRng = day.dH > -Infinity ? Math.round(day.dH - day.dL) : null;
        day.dUR = day.dO && day.dH > -Infinity ? Math.round(day.dH - day.dO) : null;
        day.dLR = day.dO && day.dL < Infinity ? Math.round(day.dO - day.dL) : null;
        day.dOC = day.dO && day.dC ? Math.round(day.dC - day.dO) : null;
        day.dMx = Math.max(day.dUR || 0, day.dLR || 0);
        
        // Calculate total volume and collect RSI values
        let totalVol = 0;
        const dayRsiVals = [];
        getSortedHourKeys(day).forEach(h => {
          const hr = day.hrs[h];
          totalVol += hr.v || 0;
          if (hr.rsiVals) dayRsiVals.push(...hr.rsiVals);
        });
        day.dVol = totalVol;
        day.dayVol = day.dVol;
        
        // Calculate median RSI
        if (dayRsiVals.length > 0) {
          dayRsiVals.sort((a, b) => a - b);
          const mid = Math.floor(dayRsiVals.length / 2);
          day.dRsiMed = dayRsiVals.length % 2 ? dayRsiVals[mid] : (dayRsiVals[mid - 1] + dayRsiVals[mid]) / 2;
          day.dRsiMed = Math.round(day.dRsiMed * 100) / 100;
        } else {
          day.dRsiMed = null;
        }
        
        // Drawdown: fall from high to subsequent low
        // Reversal: rise from low to subsequent high
        let postHiLow = Infinity, postLoHigh = -Infinity;
        let foundHi = false, foundLo = false;
        
        getSortedHourKeys(day).forEach(h => {
          const hrNum = Number(h);
          const hr = day.hrs[h];
        
          if (day.dHiHr !== null && hrNum >= day.dHiHr) {
            foundHi = true;
            postHiLow = Math.min(postHiLow, hr.l);
          }
        
          if (day.dLoHr !== null && hrNum >= day.dLoHr) {
            foundLo = true;
            postLoHigh = Math.max(postLoHigh, hr.h);
          }
        });
        
        day.dDD = foundHi && day.dH > -Infinity && postHiLow < Infinity ? Math.round(day.dH - postHiLow) : null;
        day.dRev = foundLo && day.dL < Infinity && postLoHigh > -Infinity ? Math.round(postLoHigh - day.dL) : null;
        
        // Calculate RTH (9am-3pm) high/low hours
        let rthHigh = -Infinity, rthLow = Infinity;
        let rthHiHr = null, rthLoHr = null;
        for (let h = 9; h <= 15; h++) {
          if (day.hrs[h]) {
            if (day.hrs[h].h > rthHigh) { rthHigh = day.hrs[h].h; rthHiHr = h; }
            if (day.hrs[h].l < rthLow) { rthLow = day.hrs[h].l; rthLoHr = h; }
          }
        }
        day.dRthHiHr = rthHiHr;
        day.dRthLoHr = rthLoHr;
        
        let runH = -Infinity, runL = Infinity;
        let prevCdrU = null, prevCdrD = null, prevMxcd = null;
        
        getSortedHourKeys(day).forEach(h => {
          const hd = day.hrs[h];
          const hrNum = Number(h);
        
          runH = Math.max(runH, hd.h);
          runL = Math.min(runL, hd.l);
          
          const cdrU = day.dO ? Math.round(runH - day.dO) : null;
          const cdrD = day.dO ? Math.round(day.dO - runL) : null;
          const mxcd = Math.max(cdrU || 0, cdrD || 0);
          
          // RSI metrics
          const rsiMax = hd.rsiVals.length ? Math.max(...hd.rsiVals) : null;
          const rsiMin = hd.rsiVals.length ? Math.min(...hd.rsiVals) : null;
          const rsiAvg = hd.rsiVals.length
            ? hd.rsiVals.reduce((a,b) => a+b, 0) / hd.rsiVals.length
            : null;

          // RSI open/close/delta - get from bars for this day and hour
          let rsiOpen = null, rsiClose = null, rsiDelta = null;
          let rsiOBmin = null, rsiOSmin = null;
          const dayBars = barsByET[day.date] || [];
          const hourBars = dayBars.filter(b => b.etHour === hrNum);

          if (hourBars.length > 0) {
            // Find first and last bars with RSI values
            const barsWithRSI = hourBars.filter(b => b.rsi != null);
            if (barsWithRSI.length > 0) {
              // RSI open should be the RSI close from the previous 5-minute bar (:55 from previous hour)
              // This ensures RSI open equals the previous bar's close since nothing happened in that instant
              let prevBar = null;
              if (hrNum > 0) {
                // Look for :55 bar in previous hour of same day
                prevBar = dayBars.find(b => b.etHour === hrNum - 1 && b.etMin === 55);
              } else {
                // hrNum === 0, look at previous day's hour 23, minute 55
                const prevDateIdx = allETDates.indexOf(day.date) + 1;
                const prevDate = prevDateIdx < allETDates.length ? allETDates[prevDateIdx] : null;
                if (prevDate) {
                  const prevDayBars = barsByET[prevDate] || [];
                  prevBar = prevDayBars.find(b => b.etHour === 23 && b.etMin === 55);
                }
              }

              // Use previous bar's RSI if available, otherwise fall back to first bar's RSI
              rsiOpen = prevBar && prevBar.rsi != null ? prevBar.rsi : barsWithRSI[0].rsi;
              rsiClose = barsWithRSI[barsWithRSI.length - 1].rsi;
              rsiDelta = rsiOpen - rsiClose;
            }

            // Find first OB/OS minute
            for (const bar of hourBars) {
              if (bar.rsi != null) {
                if (rsiOBmin === null && bar.rsi >= obLevel) {
                  rsiOBmin = bar.etMin;
                }
                if (rsiOSmin === null && bar.rsi <= osLevel) {
                  rsiOSmin = bar.etMin;
                }
              }
              if (rsiOBmin !== null && rsiOSmin !== null) break;
            }
          }

          const sigMax = hd.sigVals.length ? Math.max(...hd.sigVals) : null;
          const sigMin = hd.sigVals.length ? Math.min(...hd.sigVals) : null;
          const sigAvg = hd.sigVals.length
            ? hd.sigVals.reduce((a,b) => a+b, 0) / hd.sigVals.length
            : null;

          const obos =
            hd.rsiVals.some(r => r >= obLevel) ? 'OB'
            : hd.rsiVals.some(r => r <= osLevel) ? 'OS'
            : null;

          // Calculate half-hour O-C metrics (:00-:25 and :30-:55)
          let oc25 = null, oc55 = null;
          if (hourBars.length > 0) {
            const bar00 = hourBars.find(b => b.etMin === 0);
            const bar25 = hourBars.find(b => b.etMin === 25);
            const bar30 = hourBars.find(b => b.etMin === 30);
            const bar55 = hourBars.find(b => b.etMin === 55);

            if (bar00 && bar25) oc25 = Math.round(bar25.close - bar00.open);
            if (bar30 && bar55) oc55 = Math.round(bar55.close - bar30.open);
          }
          
          // Calculate toNxtLvl: (next level up - close) - (close - next level down)
          const closeLevel = getLevel(hd.c);
          const nextLevelUp = (closeLevel + 1) * levelSize;
          const nextLevelDown = closeLevel * levelSize;
          const toNxtLvl = Math.round((nextLevelUp - hd.c) - (hd.c - nextLevelDown));

          // Calculate interval close-open metrics (15-minute intervals)
          let oc0010 = null, oc1525 = null, oc3040 = null, oc4555 = null;
          if (hourBars.length > 0) {
            const bar00 = hourBars.find(b => b.etMin === 0);
            const bar10 = hourBars.find(b => b.etMin === 10);
            const bar15 = hourBars.find(b => b.etMin === 15);
            const bar25 = hourBars.find(b => b.etMin === 25);
            const bar30 = hourBars.find(b => b.etMin === 30);
            const bar40 = hourBars.find(b => b.etMin === 40);
            const bar45 = hourBars.find(b => b.etMin === 45);
            const bar55 = hourBars.find(b => b.etMin === 55);

            if (bar00 && bar10) oc0010 = Math.round(bar10.close - bar00.open);
            if (bar15 && bar25) oc1525 = Math.round(bar25.close - bar15.open);
            if (bar30 && bar40) oc3040 = Math.round(bar40.close - bar30.open);
            if (bar45 && bar55) oc4555 = Math.round(bar55.close - bar45.open);
          }

          // Calculate 15-minute range metrics for each quarter of the hour
          let m15UpperRng = null, m15LowerRng = null, m15FullRng = null, m15MaxRng = null;
          if (hourBars.length > 0) {
            // Define 15-minute periods: 0-10, 15-25, 30-40, 45-55
            const periods = [
              { start: 0, end: 10, bars: [0, 5, 10] },
              { start: 15, end: 25, bars: [15, 20, 25] },
              { start: 30, end: 40, bars: [30, 35, 40] },
              { start: 45, end: 55, bars: [45, 50, 55] }
            ];

            let maxUpper = -Infinity, maxLower = -Infinity, maxFull = -Infinity, maxOfBoth = -Infinity;

            periods.forEach(period => {
              const periodBars = hourBars.filter(b => period.bars.includes(b.etMin));
              if (periodBars.length > 0) {
                // First bar's open
                const firstBar = periodBars.find(b => b.etMin === period.start);
                if (firstBar) {
                  // Get high and low within this period
                  const periodHigh = Math.max(...periodBars.map(b => b.high));
                  const periodLow = Math.min(...periodBars.map(b => b.low));

                  // Upper range: high - open (how much it went up from open)
                  const upper = Math.round(periodHigh - firstBar.open);
                  // Lower range: open - low (how much it went down from open)
                  const lower = Math.round(firstBar.open - periodLow);
                  // Full range: high - low
                  const full = Math.round(periodHigh - periodLow);
                  // Max of upper and lower
                  const maxRange = Math.max(upper, lower);

                  // Track the maximum values across all periods
                  maxUpper = Math.max(maxUpper, upper);
                  maxLower = Math.max(maxLower, lower);
                  maxFull = Math.max(maxFull, full);
                  maxOfBoth = Math.max(maxOfBoth, maxRange);
                }
              }
            });

            // Set the metrics to the maximum values found across all 15-min periods
            if (maxUpper > -Infinity) m15UpperRng = maxUpper;
            if (maxLower > -Infinity) m15LowerRng = maxLower;
            if (maxFull > -Infinity) m15FullRng = maxFull;
            if (maxOfBoth > -Infinity) m15MaxRng = maxOfBoth;
          }

          // Calculate after bar metrics
          let lastAfterHiBarMin = null, lastAfterLoBarMin = null;
          let bar40AfterHi = null, bar40AfterLo = null;

          if (hourBars.length > 0) {
            // Find last bar where after bar high > threshold
            for (let i = hourBars.length - 1; i >= 0; i--) {
              const bar = hourBars[i];
              if (bar.afterBarHigh != null && bar.afterBarHigh > afterBarThreshold) {
                lastAfterHiBarMin = bar.etMin;
                break;
              }
            }

            // Find last bar where after bar low > threshold
            for (let i = hourBars.length - 1; i >= 0; i--) {
              const bar = hourBars[i];
              if (bar.afterBarLow != null && bar.afterBarLow > afterBarThreshold) {
                lastAfterLoBarMin = bar.etMin;
                break;
              }
            }

            // Get :40 bar after bar high/low (ensure positive values)
            const bar40 = hourBars.find(b => b.etMin === 40);
            if (bar40) {
              bar40AfterHi = bar40.afterBarHigh != null ? Math.max(0, Math.round(bar40.afterBarHigh)) : null;
              bar40AfterLo = bar40.afterBarLow != null ? Math.max(0, Math.round(bar40.afterBarLow)) : null;
            }
          }

          // Calculate max B40HL
          let maxB40HL = null;
          if (bar40AfterHi != null && bar40AfterLo != null) {
            maxB40HL = Math.max(bar40AfterHi, bar40AfterLo);
          } else if (bar40AfterHi != null) {
            maxB40HL = bar40AfterHi;
          } else if (bar40AfterLo != null) {
            maxB40HL = bar40AfterLo;
          }

          // Calculate cumulative bar counts
          const hourGreenBars = hd.greenBars || 0;
          const hourRedBars = hourBars.length - hourGreenBars;

          // Calculate max range bar minute (minute with max UR or LR value)
          let maxRngBarMin = null, maxRngBarVal = null;
          if (hourBars.length > 0) {
            let maxUR = -Infinity, maxLR = -Infinity;
            let maxURMin = null, maxLRMin = null;

            hourBars.forEach(bar => {
              const ur = Math.round(bar.high - bar.open);
              const lr = Math.round(bar.open - bar.low);

              if (ur > maxUR) {
                maxUR = ur;
                maxURMin = bar.etMin;
              }
              if (lr > maxLR) {
                maxLR = lr;
                maxLRMin = bar.etMin;
              }
            });

            // Return whichever is larger (UR or LR)
            if (maxUR >= maxLR) {
              maxRngBarMin = maxURMin;
              maxRngBarVal = maxUR;
            } else {
              maxRngBarMin = maxLRMin;
              maxRngBarVal = maxLR;
            }
          }

          hd.m = {
            rng: Math.round(hd.h - hd.l),
            ur: Math.round(hd.h - hd.o),
            lr: Math.round(hd.o - hd.l),
            up: calcLvlUp(hd.o, hd.h),
            dn: calcLvlDn(hd.o, hd.l),
            totl: calcLvlUp(hd.o, hd.h) + calcLvlDn(hd.o, hd.l),
            cl: calcLvlCl(hd.o, hd.c),
            oc: Math.round(hd.c - hd.o),
            oc25,
            oc55,
            hm: hd.hm, lm: hd.lm,
            maxRngBarMin,
            maxRngBarVal,
            o: Math.round(hd.o), hi: Math.round(hd.h), lo: Math.round(hd.l), c: Math.round(hd.c),
            v: Math.round(hd.v * 100) / 100,
            cdr: day.dO ? Math.round(hd.c - day.dO) : null,
            greenBars: hd.greenBars,
            cdrU: (cdrU !== prevCdrU) ? cdrU : null,
            cdrD: (cdrD !== prevCdrD) ? cdrD : null,
            mxcd: (mxcd !== prevMxcd) ? mxcd : null,
            cdrUActual: cdrU,
            cdrDActual: cdrD,
            mxcdActual: mxcd,
            rsiMax,
            rsiMin,
            rsiAvg: rsiAvg ? Math.round(rsiAvg * 10) / 10 : null,
            rsiOpen: rsiOpen ? Math.round(rsiOpen * 10) / 10 : null,
            rsiClose: rsiClose ? Math.round(rsiClose * 10) / 10 : null,
            rsiDelta: rsiDelta ? Math.round(rsiDelta * 10) / 10 : null,
            rsiOBmin,
            rsiOSmin,
            sigMax,
            sigMin,
            sigAvg: sigAvg ? Math.round(sigAvg * 10) / 10 : null,
            obos,
            toNxtLvl,
            oc0010,
            oc1525,
            oc3040,
            oc4555,
            m15UpperRng,
            m15LowerRng,
            m15FullRng,
            m15MaxRng,
            lastAfterHiBarMin,
            lastAfterLoBarMin,
            maxLastAfterBarMin: (lastAfterHiBarMin != null && lastAfterLoBarMin != null) ? Math.max(lastAfterHiBarMin, lastAfterLoBarMin) : (lastAfterHiBarMin ?? lastAfterLoBarMin),
            bar40AfterHi,
            bar40AfterLo,
            maxB40HL,
            cumGreenBars: null, // Will be calculated cumulatively
            cumRedBars: null,
            barDelta: null,
            rthCumGreenBars: null,
            rthCumRedBars: null,
            rthBarDelta: null,
          };

          // Calculate strength indicators
          const rng = hd.h - hd.l;
          if (rng > 0) {
            // buyStr: % of range from low to close (0-100)
            hd.m.buyStr = Math.round(((hd.c - hd.l) / rng) * 100);
            // sellStr: % of range from close to high (0-100)
            hd.m.sellStr = Math.round(((hd.h - hd.c) / rng) * 100);
            // overallStr: net direction as % of range (-100 to +100)
            hd.m.overallStr = Math.round(((hd.c - hd.o) / rng) * 100);
          } else {
            hd.m.buyStr = null;
            hd.m.sellStr = null;
            hd.m.overallStr = null;
          }

          hd.m.mxr = Math.max(hd.m.ur, hd.m.lr);
          hd.m.mxl = Math.max(hd.m.up, hd.m.dn);
        
          prevCdrU = cdrU;
          prevCdrD = cdrD;
          prevMxcd = mxcd;
        });

        // Second pass: Calculate cumulative bar counts
        let cumGreenBars = 0, cumRedBars = 0;
        let rthCumGreenBars = 0, rthCumRedBars = 0;

        getSortedHourKeys(day).forEach(h => {
          const hd = day.hrs[h];
          const hrNum = Number(h);
          if (!hd.m) return;

          const dayBars = barsByET[day.date] || [];
          const hourBars = dayBars.filter(b => b.etHour === hrNum);
          const hourGreenBars = hd.greenBars || 0;
          const hourRedBars = hourBars.length - hourGreenBars;

          cumGreenBars += hourGreenBars;
          cumRedBars += hourRedBars;

          hd.m.cumGreenBars = cumGreenBars;
          hd.m.cumRedBars = cumRedBars;
          hd.m.barDelta = cumRedBars - cumGreenBars;

          // RTH cumulative bars (9am-3pm, hours 9-15)
          if (hrNum >= 9 && hrNum <= 15) {
            rthCumGreenBars += hourGreenBars;
            rthCumRedBars += hourRedBars;
          }

          // Store RTH values for all hours (will be same for hours > 15)
          if (hrNum >= 9) {
            hd.m.rthCumGreenBars = rthCumGreenBars;
            hd.m.rthCumRedBars = rthCumRedBars;
            hd.m.rthBarDelta = rthCumRedBars - rthCumGreenBars;
          }
        });

        // Calculate day total bar counts
        day.dCumGreenBars = cumGreenBars;
        day.dCumRedBars = cumRedBars;
        day.dBarDelta = cumRedBars - cumGreenBars;
        day.dRthCumGreenBars = rthCumGreenBars;
        day.dRthCumRedBars = rthCumRedBars;
        day.dRthBarDelta = rthCumRedBars - rthCumGreenBars;

        // Calculate RTH average RSI
        let rthRsiSum = 0, rthRsiCount = 0;
        for (let h = 9; h <= 15; h++) {
          if (day.hrs[h] && day.hrs[h].rsiVals) {
            day.hrs[h].rsiVals.forEach(rsi => {
              if (rsi != null) {
                rthRsiSum += rsi;
                rthRsiCount++;
              }
            });
          }
        }
        day.dRthRsiAvg = rthRsiCount > 0 ? Math.round((rthRsiSum / rthRsiCount) * 10) / 10 : null;
      });

      // Calculate 5PM session metrics (5PM previous day to 4PM current day)
      // Also calculate weekly metrics (Sunday 12AM open)
      const sortedDates = Object.keys(etDays).sort();
      pmSessionDays = {};
      weeklyData = {};
      
      sortedDates.forEach((dateStr, idx) => {
        const day = etDays[dateStr];
        
        // Get 5PM open from previous day
        const prevDateIdx = idx - 1;
        if (prevDateIdx >= 0) {
          const prevDateStr = sortedDates[prevDateIdx];
          const prevDay = etDays[prevDateStr];
          const pm5Hour = prevDay?.hrs[17]; // 5PM = hour 17
          if (pm5Hour) {
            const pm5Open = pm5Hour.o;
            
            // Calculate high/low from 5PM previous day to 4PM current day
            let pmHigh = pm5Open, pmLow = pm5Open;
            
            // Include 5PM-11PM from previous day
            for (let h = 17; h <= 23; h++) {
              if (prevDay.hrs[h]) {
                pmHigh = Math.max(pmHigh, prevDay.hrs[h].h);
                pmLow = Math.min(pmLow, prevDay.hrs[h].l);
              }
            }
            
            // Include 12AM-4PM from current day
            for (let h = 0; h <= 16; h++) {
              if (day.hrs[h]) {
                pmHigh = Math.max(pmHigh, day.hrs[h].h);
                pmLow = Math.min(pmLow, day.hrs[h].l);
              }
            }
            
            // Get 4PM close
            const pm4Hour = day.hrs[16];
            const pm4Close = pm4Hour ? pm4Hour.c : day.dC;
            
            day.d5pmOpen = pm5Open;
            day.d5pmUR = Math.round(pmHigh - pm5Open);
            day.d5pmLR = Math.round(pm5Open - pmLow);
            day.d5pmMx = Math.max(day.d5pmUR, day.d5pmLR);
            day.d5pmOC = pm4Close ? Math.round(pm4Close - pm5Open) : null;
          }
        }
        
        // Calculate weekly metrics (from Sunday 12AM open)
        const dateObj = new Date(dateStr + 'T12:00:00Z');
        const dayOfWeek = dateObj.getUTCDay(); // 0=Sunday
        
        // Find the Sunday of this week
        const sundayOffset = dayOfWeek;
        const sundayDate = new Date(dateObj);
        sundayDate.setUTCDate(sundayDate.getUTCDate() - sundayOffset);
        const sundayStr = sundayDate.toISOString().split('T')[0];
        
        // Get Sunday's open (12AM)
        const sundayDay = etDays[sundayStr];
        const weekOpen = sundayDay?.dO;
        
        if (weekOpen != null) {
          // Calculate cumulative high/low from Sunday to this day
          let weekHigh = weekOpen, weekLow = weekOpen;
          
          // Loop through all days from Sunday to current day
          const currentDate = new Date(sundayDate);
          while (currentDate <= dateObj) {
            const checkStr = currentDate.toISOString().split('T')[0];
            const checkDay = etDays[checkStr];
            if (checkDay) {
              if (checkDay.dH > weekHigh) weekHigh = checkDay.dH;
              if (checkDay.dL < weekLow) weekLow = checkDay.dL;
            }
            currentDate.setUTCDate(currentDate.getUTCDate() + 1);
          }
          
          day.wOpen = weekOpen;
          day.wUR = Math.round(weekHigh - weekOpen);
          day.wLR = Math.round(weekOpen - weekLow);
          day.wMx = Math.max(day.wUR, day.wLR);
          day.wOC = day.dC ? Math.round(day.dC - weekOpen) : null;
          day.wHigh = weekHigh;
          day.wLow = weekLow;
          
          // Calculate hourly weekly cumulative metrics
          let wRunH = weekOpen, wRunL = weekOpen;
          let wPrevCdrU = null, wPrevCdrD = null, wPrevMxcd = null;
          
          // First accumulate high/low from previous days this week
          const prevDaysDate = new Date(sundayDate);
          while (prevDaysDate < dateObj) {
            const prevStr = prevDaysDate.toISOString().split('T')[0];
            const prevDayData = etDays[prevStr];
            if (prevDayData) {
              if (prevDayData.dH > wRunH) wRunH = prevDayData.dH;
              if (prevDayData.dL < wRunL) wRunL = prevDayData.dL;
            }
            prevDaysDate.setUTCDate(prevDaysDate.getUTCDate() + 1);
          }
          
          // Now calculate for each hour today
          getSortedHourKeys(day).forEach(h => {
            const hd = day.hrs[h];
            if (!hd.m) return;
          
            wRunH = Math.max(wRunH, hd.h);
            wRunL = Math.min(wRunL, hd.l);
            
            const wCdrU = Math.round(wRunH - weekOpen);
            const wCdrD = Math.round(weekOpen - wRunL);
            const wMxcd = Math.max(wCdrU, wCdrD);
            
            hd.m.wCdr = Math.round(hd.c - weekOpen);
            hd.m.wCdrU = (wCdrU !== wPrevCdrU) ? wCdrU : null;
            hd.m.wCdrD = (wCdrD !== wPrevCdrD) ? wCdrD : null;
            hd.m.wMxcd = (wMxcd !== wPrevMxcd) ? wMxcd : null;
            hd.m.wCdrUActual = wCdrU;
            hd.m.wCdrDActual = wCdrD;
            hd.m.wMxcdActual = wMxcd;
            
            wPrevCdrU = wCdrU;
            wPrevCdrD = wCdrD;
            wPrevMxcd = wMxcd;
          });
        }
        
        // Calculate 5PM hourly cumulative metrics for hours after 5PM session starts
        // For hours 17-23 of current day: use current day's hour 17 open (reset at 5PM)
        // For hours 0-16 of current day: use previous day's hour 17 open (continuation of 5PM session)
        if (day.hrs[17]) {
          // For hours 17-23, reset at hour 17 (5PM) of current day
          const currentDayPm5Open = day.hrs[17].o;
          let p5RunH = currentDayPm5Open, p5RunL = currentDayPm5Open;
          let p5PrevCdrU = null, p5PrevCdrD = null, p5PrevMxcd = null;

          for (let h = 17; h <= 23; h++) {
            if (day.hrs[h] && day.hrs[h].m) {
              const hd = day.hrs[h];
              p5RunH = Math.max(p5RunH, hd.h);
              p5RunL = Math.min(p5RunL, hd.l);

              const p5CdrU = Math.round(p5RunH - currentDayPm5Open);
              const p5CdrD = Math.round(currentDayPm5Open - p5RunL);
              const p5Mxcd = Math.max(p5CdrU, p5CdrD);

              hd.m.p5Cdr = Math.round(hd.c - currentDayPm5Open);
              hd.m.p5CdrU = (p5CdrU !== p5PrevCdrU) ? p5CdrU : null;
              hd.m.p5CdrD = (p5CdrD !== p5PrevCdrD) ? p5CdrD : null;
              hd.m.p5Mxcd = (p5Mxcd !== p5PrevMxcd) ? p5Mxcd : null;
              hd.m.p5CdrUActual = p5CdrU;
              hd.m.p5CdrDActual = p5CdrD;
              hd.m.p5MxcdActual = p5Mxcd;

              p5PrevCdrU = p5CdrU;
              p5PrevCdrD = p5CdrD;
              p5PrevMxcd = p5Mxcd;
            }
          }
        }

        // For hours 0-16: use previous day's 5PM open (continuation of 5PM session)
        if (day.d5pmOpen != null) {
          const pm5Open = day.d5pmOpen;

          // Get previous day for high/low from 5PM-11PM
          const prevDateIdx = idx - 1;
          const prevDateStr = prevDateIdx >= 0 ? sortedDates[prevDateIdx] : null;
          const prevDay = prevDateStr ? etDays[prevDateStr] : null;

          // Reset for continuation into next day (hours 0-16)
          p5RunH = pm5Open;
          p5RunL = pm5Open;
          p5PrevCdrU = null;
          p5PrevCdrD = null;
          p5PrevMxcd = null;

          // First accumulate from 5PM-11PM of previous day
          if (prevDay) {
            for (let h = 17; h <= 23; h++) {
              if (prevDay.hrs[h]) {
                p5RunH = Math.max(p5RunH, prevDay.hrs[h].h);
                p5RunL = Math.min(p5RunL, prevDay.hrs[h].l);
              }
            }
          }

          // Now calculate for hours 0-16 of current day (continuation of 5PM session)
          for (let h = 0; h <= 16; h++) {
            if (day.hrs[h] && day.hrs[h].m) {
              const hd = day.hrs[h];
              p5RunH = Math.max(p5RunH, hd.h);
              p5RunL = Math.min(p5RunL, hd.l);

              const p5CdrU = Math.round(p5RunH - pm5Open);
              const p5CdrD = Math.round(pm5Open - p5RunL);
              const p5Mxcd = Math.max(p5CdrU, p5CdrD);

              hd.m.p5Cdr = Math.round(hd.c - pm5Open);
              hd.m.p5CdrU = (p5CdrU !== p5PrevCdrU) ? p5CdrU : null;
              hd.m.p5CdrD = (p5CdrD !== p5PrevCdrD) ? p5CdrD : null;
              hd.m.p5Mxcd = (p5Mxcd !== p5PrevMxcd) ? p5Mxcd : null;
              hd.m.p5CdrUActual = p5CdrU;
              hd.m.p5CdrDActual = p5CdrD;
              hd.m.p5MxcdActual = p5Mxcd;

              p5PrevCdrU = p5CdrU;
              p5PrevCdrD = p5CdrD;
              p5PrevMxcd = p5Mxcd;
            }
          }
        }
      });
      
      // Calculate hour high/low after close for each bar
      Object.keys(barsByET).forEach(date => {
        const bars = barsByET[date];

        // Group bars by hour
        const barsByHour = {};
        bars.forEach(bar => {
          if (!barsByHour[bar.etHour]) barsByHour[bar.etHour] = [];
          barsByHour[bar.etHour].push(bar);
        });

        // For each hour, calculate after-close metrics
        Object.keys(barsByHour).forEach(hour => {
          const hourBars = barsByHour[hour];

          hourBars.forEach((bar, idx) => {
            // Get all bars after this one in the same hour
            const barsAfter = hourBars.slice(idx + 1);

            if (barsAfter.length > 0) {
              const maxHighAfter = Math.max(...barsAfter.map(b => b.high));
              const minLowAfter = Math.min(...barsAfter.map(b => b.low));

              // Hour high after close: max high after - this bar's close
              bar.hhAfterClose = Math.round(maxHighAfter - bar.close);
              // Hour low after close: this bar's close - min low after
              bar.hlAfterClose = Math.round(bar.close - minLowAfter);
            } else {
              // Last bar of the hour has no bars after
              bar.hhAfterClose = 0;
              bar.hlAfterClose = 0;
            }
          });
        });
      });

      allETDates = Object.keys(etDays).sort().reverse();
      availableYears = [...new Set(allETDates.map(d => d.slice(0, 4)))].sort();
      selectedYears = new Set(availableYears);

      document.getElementById('year-filters').innerHTML = availableYears.map(y =>
        `<button class="f-btn active" data-year="${y}" onclick="toggleYear('${y}')">${y}</button>`
      ).join('');

      populateDatePicker();
      computeEstablishedHours();
      computeRelativeVolume();
    }

    realHours = buildRealHours(Object.values(etDays));

    realHours.forEach(h => {
      const ampm = h >= 12 ? 'PM' : 'AM';
      const disp = h === 0 ? 12 : h > 12 ? h - 12 : h;
      ['hour-from', 'hour-to', 'mobile-hour-from', 'mobile-hour-to', 'day-hl-from', 'day-hl-to', 'oc-close-hour', 'mobile-oc-close-hour', 'calendar-close-hour'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML += `<option value="${h}" ${(id==='hour-from'&&h===0)||(id==='hour-to'&&h===23)||(id==='mobile-hour-from'&&h===0)||(id==='mobile-hour-to'&&h===23)||(id==='day-hl-from'&&h===9)||(id==='day-hl-to'&&h===15)||(id==='oc-close-hour'&&h===16)||(id==='mobile-oc-close-hour'&&h===16)||(id==='calendar-close-hour'&&h===16)?'selected':''}>${disp}${ampm}</option>`;
      });
    });
    document.getElementById('hour-from').value = hourFrom;
    document.getElementById('hour-to').value = hourTo;
    const mobileHourFrom = document.getElementById('mobile-hour-from');
    const mobileHourTo = document.getElementById('mobile-hour-to');
    if (mobileHourFrom) mobileHourFrom.value = hourFrom;
    if (mobileHourTo) mobileHourTo.value = hourTo;

    // Set day highlight dropdowns to default 9am-3pm
    const dayHlFromEl = document.getElementById('day-hl-from');
    const dayHlToEl = document.getElementById('day-hl-to');
    if (dayHlFromEl) dayHlFromEl.value = 9;
    if (dayHlToEl) dayHlToEl.value = 15;

    function updateLevel() {
      levelSize = parseInt(document.getElementById('level-size').value) || 250;
      Object.values(etDays).forEach(day => {
        getSortedHourKeys(day).forEach(h => {
          const hd = day.hrs[h];
          if (!hd.m) return;

          hd.m.up = calcLvlUp(hd.o, hd.h);
          hd.m.dn = calcLvlDn(hd.o, hd.l);
          hd.m.cl = calcLvlCl(hd.o, hd.c);
          hd.m.mxl = Math.max(hd.m.up, hd.m.dn);
          hd.m.totl = hd.m.up + hd.m.dn;

          // Recalculate toNxtLvl
          const closeLevel = getLevel(hd.c);
          const nextLevelUp = (closeLevel + 1) * levelSize;
          const nextLevelDown = closeLevel * levelSize;
          hd.m.toNxtLvl = Math.round((nextLevelUp - hd.c) - (hd.c - nextLevelDown));
        });
      });
      renderTable();
    }
    
    // ==================== COLUMN FILTERS ====================
    function populateFilterSelects() {
      const hourSel = document.getElementById('filter-hour');
      const mobileHourSel = document.getElementById('mobile-filter-hour');

      const hourOptions = '<option value="day">Day Total</option><option value="any">Any Hour</option>' +
        Array.from({ length: 24 }, (_, h) => {
          const ampm = h >= 12 ? 'PM' : 'AM';
          const disp = h === 0 ? 12 : h > 12 ? h - 12 : h;
          return `<option value="${h}">${disp}${ampm}</option>`;
        }).join('');

      if (hourSel) hourSel.innerHTML = hourOptions;
      if (mobileHourSel) mobileHourSel.innerHTML = hourOptions;

      updateFilterColumnSelect();
    }
    
    // Track previous hour type (day vs non-day) to only update dropdown when switching categories
    let previousHourType = 'day';

    function updateFilterColumnSelect() {
      const hourVal = document.getElementById('filter-hour').value;
      const currentHourType = hourVal === 'day' ? 'day' : 'hour';

      // Only update dropdown if switching between day and hour categories
      if (currentHourType !== previousHourType) {
        const colSel = document.getElementById('filter-column');
        const mobileColSel = document.getElementById('mobile-filter-column');

        const options = hourVal === 'day'
          ? DAY_TOTAL_COLS.map(c => `<option value="${c.id}">${c.label}</option>`).join('')
          : ALL_COLUMNS.map(c => `<option value="${c.id}">${c.label}</option>`).join('');

        if (colSel) colSel.innerHTML = options;
        if (mobileColSel) mobileColSel.innerHTML = options;

        previousHourType = currentHourType;
      }
    }

    document.getElementById('filter-hour')?.addEventListener('change', updateFilterColumnSelect);
    document.getElementById('mobile-filter-hour')?.addEventListener('change', () => {
      const val = document.getElementById('mobile-filter-hour').value;
      document.getElementById('filter-hour').value = val;
      updateFilterColumnSelect();
    });
    
    function addColumnFilter() {
      const hour = document.getElementById('filter-hour').value;
      const col = document.getElementById('filter-column').value;
      const op = document.getElementById('filter-op').value;
      const val = parseFloat(document.getElementById('filter-value').value);

      if (isNaN(val)) { alert('Please enter a valid number'); return; }

      columnFilters.push({ hour, col, op, val, logic: 'AND' });
      document.getElementById('filter-value').value = '';
      updateFilterUI();
      renderTable();
    }
    
    function removeFilter(idx) {
      columnFilters.splice(idx, 1);
      updateFilterUI();
      if (mobileFilterModalOpen) updateMobileActiveFilters();
      renderTable();
    }

    // Alias for mobile compatibility
    function removeColumnFilter(idx) { removeFilter(idx); }

    function updateFilterLogic(idx, logic) {
      if (columnFilters[idx]) {
        columnFilters[idx].logic = logic;
        renderTable();
      }
    }

    function clearAllFilters() {
      columnFilters = [];
      updateFilterUI();
      if (mobileFilterModalOpen) updateMobileActiveFilters();
      renderTable();
    }
    
    function editFilter(idx) {
      const filter = columnFilters[idx];
      if (!filter) return;

      // Populate the filter inputs
      document.getElementById('filter-hour').value = filter.hour;
      document.getElementById('filter-column').value = filter.col;
      document.getElementById('filter-op').value = filter.op;
      const filterValue = document.getElementById('filter-value');
      filterValue.value = filter.val;

      // Update column select in case we're switching between day/hour
      const hourVal = filter.hour;
      const currentHourType = hourVal === 'day' ? 'day' : 'hour';
      if (currentHourType !== previousHourType) {
        const colSel = document.getElementById('filter-column');
        const options = hourVal === 'day'
          ? DAY_TOTAL_COLS.map(c => `<option value="${c.id}">${c.label}</option>`).join('')
          : ALL_COLUMNS.map(c => `<option value="${c.id}">${c.label}</option>`).join('');
        if (colSel) colSel.innerHTML = options;
        previousHourType = currentHourType;
      }
      document.getElementById('filter-column').value = filter.col;

      // Focus and select the value input
      filterValue.focus();
      filterValue.select();

      // Remove the old filter
      removeFilter(idx);
    }

    function updateFilterUI() {
      const container = document.getElementById('active-filters');
      container.innerHTML = columnFilters.map((f, i) => {
        let hourLabel;
        if (f.hour === 'day') {
          hourLabel = 'Day';
        } else if (f.hour === 'any') {
          hourLabel = 'Any';
        } else {
          hourLabel = formatHourHeader(parseInt(f.hour));
        }
        const colDef = f.hour === 'day' ? DAY_TOTAL_COLS.find(c => c.id === f.col) : ALL_COLUMNS.find(c => c.id === f.col);
        const logic = f.logic || 'AND';
        return `<div class="filter-tag">
          <select onchange="updateFilterLogic(${i}, this.value)" style="padding:1px 3px;background:rgba(0,0,0,0.3);border:1px solid rgba(74,222,128,0.3);border-radius:2px;color:var(--accent-green);font-size:0.5rem;margin-right:4px;">
            <option value="AND" ${logic === 'AND' ? 'selected' : ''}>AND</option>
            <option value="OR" ${logic === 'OR' ? 'selected' : ''}>OR</option>
          </select>
          <span onclick="editFilter(${i})" style="cursor:pointer;" title="Click to edit">
            ${hourLabel} ${colDef?.label || f.col} ${f.op} <u>${f.val}</u>
          </span>
          <span class="remove-filter" onclick="removeFilter(${i})"></span>
        </div>`;
      }).join('');

      document.getElementById('btn-col-filter').classList.toggle('has-filters', columnFilters.length > 0);
    }
    
    function applyColumnFilters(data) {
      if (columnFilters.length === 0) return data;

      // Separate filters by logic type
      const andFilters = columnFilters.filter(f => (f.logic || 'AND') === 'AND');
      const orFilters = columnFilters.filter(f => f.logic === 'OR');

      return data.filter(day => {
        // Clear previous matched hours
        day._matchedHours = {};

        // Helper function to evaluate a filter
        const evaluateFilter = (f) => {
          if (f.hour === 'day') {
            // Day total filter
            const val = day[f.col];
            if (val == null) return false;

            switch (f.op) {
              case '>=': return val >= f.val;
              case '<=': return val <= f.val;
              case '>': return val > f.val;
              case '<': return val < f.val;
              case '==': return val === f.val;
              case '!=': return val !== f.val;
              default: return true;
            }
          } else if (f.hour === 'any') {
            // Any hour filter - check if ANY hour meets the criteria and track matches
            const hours = Object.keys(day.hrs);
            const matchedHours = [];

            hours.forEach(h => {
              const val = day.hrs[h]?.m?.[f.col];
              if (val == null) return;

              let matches = false;
              switch (f.op) {
                case '>=': matches = val >= f.val; break;
                case '<=': matches = val <= f.val; break;
                case '>': matches = val > f.val; break;
                case '<': matches = val < f.val; break;
                case '==': matches = val === f.val; break;
                case '!=': matches = val !== f.val; break;
              }

              if (matches) {
                matchedHours.push(parseInt(h));
              }
            });

            // Store matched hours for this column
            if (matchedHours.length > 0) {
              if (!day._matchedHours[f.col]) {
                day._matchedHours[f.col] = new Set();
              }
              matchedHours.forEach(h => day._matchedHours[f.col].add(h));
            }

            return matchedHours.length > 0;
          } else {
            // Specific hour filter
            const h = parseInt(f.hour);
            const val = day.hrs[h]?.m?.[f.col];
            if (val == null) return false;

            switch (f.op) {
              case '>=': return val >= f.val;
              case '<=': return val <= f.val;
              case '>': return val > f.val;
              case '<': return val < f.val;
              case '==': return val === f.val;
              case '!=': return val !== f.val;
              default: return true;
            }
          }
        };

        // All AND filters must pass
        const andPass = andFilters.every(evaluateFilter);

        // At least one OR filter must pass (if any OR filters exist)
        const orPass = orFilters.length === 0 || orFilters.some(evaluateFilter);

        return andPass && orPass;
      });
    }
    
    // ==================== RANKS ====================
    function calcRanks(day, hours) {
      ['mxr', 'mxl', 'oc', 'rng', 'ur', 'lr'].forEach(m => {
        const vals = hours.map(h => ({ h, v: day.hrs[h]?.m?.[m] }))
          .filter(x => x.v != null)
          .sort((a, b) => Math.abs(b.v) - Math.abs(a.v));
        vals.forEach((x, i) => { if (day.hrs[x.h]?.m) day.hrs[x.h].m[m + 'Rk'] = i + 1; });
      });
    }
    
    // ==================== DATE PICKER ====================
    

function getFilteredDays() {
  if (typeof getFilteredData === 'function') {
    return getFilteredData();
  }
  return Object.values(etDays);
}

function computeRelativeVolume() {
  console.log("computeRelativeVolume() RUNNING");
  try {
    const days = getFilteredDays ? getFilteredDays() : Object.values(etDays);

    days.forEach((day, idx) => {
      if (!day.hrs) return;

      const hourKeys = Object.keys(day.hrs)
        .map(Number)
        .sort((a, b) => a - b)
        .map(String);

      let cumVol = 0;

      hourKeys.forEach(h => {
        const m = day.hrs[h]?.m;
        if (!m || m.v == null) return;

        // cumulative
        cumVol += m.v;
        m.cumVol = cumVol;

        /* ======================
           Hourly Relative Volume
        ====================== */
        const hourHist = days
          .filter(d => d.hrs?.[h]?.m?.v != null)
          .map(d => d.hrs[h].m.v)
          .slice(-RELVOL_LOOKBACK_HOUR);

        const hAvg = hourHist.reduce((a,b)=>a+b,0) / Math.max(1, hourHist.length);
        m.rVol = hAvg ? m.v / hAvg : null;

        /* ======================
           Cumulative Relative Vol
        ====================== */
        const prevDays = days.slice(0, idx).slice(-RELVOL_LOOKBACK_DAY);
        const cumHist = prevDays
          .map(d => d.hrs?.[h]?.m?.cumVol)
          .filter(v => v != null);

        const cAvg = cumHist.reduce((a,b)=>a+b,0) / Math.max(1, cumHist.length);
        m.rVolC = cAvg ? cumVol / cAvg : null;

        /* ======================
           Same Hour + Same DOW
        ====================== */
        const dowHist = days
          .filter(d => d.dow === day.dow && d.hrs?.[h]?.m?.v != null)
          .map(d => d.hrs[h].m.v)
          .slice(-RELVOL_LOOKBACK_DOW);

        const dAvg = dowHist.reduce((a,b)=>a+b,0) / Math.max(1, dowHist.length);
        m.rVolDOW = dAvg ? m.v / dAvg : null;
      });

      /* ======================
         Day Total RV
      ====================== */
      const prev = days.slice(0, idx).slice(-RELVOL_LOOKBACK_DAY);
      const dayAvg = prev.reduce((s,d)=>s+(d.dayVol||0),0) / Math.max(1, prev.length);
      day.dRelVol = dayAvg ? day.dayVol / dayAvg : null;

      const dow = prev.filter(d=>d.dow===day.dow);
      const dowAvg = dow.reduce((s,d)=>s+(d.dayVol||0),0) / Math.max(1, dow.length);
      day.dRelVolDOW = dowAvg ? day.dayVol / dowAvg : null;
    });

  } catch (e) {
    console.warn('Relative Volume error:', e);
  }
}

function computeEstablishedHours(){

  try {
    const pct = parseFloat(document.getElementById('est-pct')?.value) || 85;
    const P = Math.max(1, Math.min(100, pct)) / 100;
    Object.values(etDays).forEach(day => {
      // Day metadata
      day.dOW = day.dow;
      day.dDayNum = (new Date(day.date + 'T12:00:00Z')).getUTCDate();
      // Find maximum actual cumulative up/down and range across hours
      const hours = HOURS.slice();
      // Up (cdrUActual)
      const upVals = hours.map(h => (day.hrs[h] && day.hrs[h].m && typeof day.hrs[h].m.cdrUActual !== 'undefined') ? day.hrs[h].m.cdrUActual : null).filter(v=>v!=null);
      const maxUp = upVals.length ? Math.max(...upVals) : null;
      day.dUpEstHr = null;
      if (maxUp != null && maxUp > 0) {
        const thr = maxUp * P;
        for (let h=0; h<=23; h++) {
          const v = day.hrs[h]?.m?.cdrUActual;
          if (typeof v !== 'undefined' && v != null && v > thr) { day.dUpEstHr = h; break; }
        }
      }
      // Down (cdrDActual)
      const dnVals = hours.map(h => (day.hrs[h] && day.hrs[h].m && typeof day.hrs[h].m.cdrDActual !== 'undefined') ? day.hrs[h].m.cdrDActual : null).filter(v=>v!=null);
      const maxDn = dnVals.length ? Math.max(...dnVals) : null;
      day.dDnEstHr = null;
      if (maxDn != null && maxDn > 0) {
        const thr = maxDn * P;
        for (let h=0; h<=23; h++) {
          const v = day.hrs[h]?.m?.cdrDActual;
          if (typeof v !== 'undefined' && v != null && v > thr) { day.dDnEstHr = h; break; }
        }
      }
      // Range (mxcdActual)
      const mxVals = hours.map(h => (day.hrs[h] && day.hrs[h].m && typeof day.hrs[h].m.mxcdActual !== 'undefined') ? day.hrs[h].m.mxcdActual : null).filter(v=>v!=null);
      const maxMx = mxVals.length ? Math.max(...mxVals) : null;
      day.dRangeEstHr = null;
      if (maxMx != null && maxMx > 0) {
        const thr = maxMx * P;
        for (let h=0; h<=23; h++) {
          const v = day.hrs[h]?.m?.mxcdActual;
          if (typeof v !== 'undefined' && v != null && v > thr) { day.dRangeEstHr = h; break; }
        }
      }
      // Hourly max range (max of hd.m.rng across hours)
      const hourlyRngs = hours.map(h => (day.hrs[h] && day.hrs[h].m && typeof day.hrs[h].m.rng !== 'undefined') ? day.hrs[h].m.rng : null).filter(v=>v!=null);
      day.dHourlyMaxRng = hourlyRngs.length ? Math.max(...hourlyRngs) : null;
    });
  } catch (e) { console.warn('computeEstablishedHours error', e); }
}


function populateDatePicker() {
      document.getElementById('date-list').innerHTML = allETDates.map(d => 
        `<div class="date-item ${selectedDates.has(d) ? 'selected' : ''}" data-date="${d}" onclick="toggleDate('${d}')">${d}</div>`
      ).join('');
      updateDateCount();
    }
    
    function toggleDatePicker() { document.getElementById('date-picker-dropdown').classList.toggle('visible'); }
    function toggleDate(d) {
      selectedDates.has(d) ? selectedDates.delete(d) : selectedDates.add(d);
      useDateFilter = selectedDates.size > 0;
      updateDatePickerUI();
      renderTable();
    }
    function selectAllDates() { selectedDates = new Set(allETDates); useDateFilter = true; updateDatePickerUI(); renderTable(); }
    function selectNoDates() { selectedDates.clear(); useDateFilter = false; updateDatePickerUI(); renderTable(); }
    function syncDatesFromFilters() {
      selectedDates.clear();
      Object.values(etDays).forEach(d => {
        if (selectedYears.has(d.date.slice(0,4)) && selectedMonths.has(d.month) && selectedDays.has(d.dow) && selectedOccs.has(d.occ))
          selectedDates.add(d.date);
      });
      useDateFilter = true;
      updateDatePickerUI();
      renderTable();
    }
    function updateDatePickerUI() {
      document.querySelectorAll('.date-item').forEach(el => el.classList.toggle('selected', selectedDates.has(el.dataset.date)));
      updateDateCount();
    }
    function updateDateCount() { document.getElementById('date-count').textContent = selectedDates.size; }
    
    // ==================== FILTERING ====================
    function getFilteredData() {
      let data = Object.values(etDays).filter(d => {
        if (useDateFilter && selectedDates.size > 0) return selectedDates.has(d.date);
        return selectedYears.has(d.date.slice(0,4)) && selectedMonths.has(d.month) && selectedDays.has(d.dow) && selectedOccs.has(d.occ);
      });
      
      data = applyColumnFilters(data);
      
      data.sort((a, b) => {
        let va, vb;
        if (sortColumn === 'date') { va = a.date; vb = b.date; }
        else if (DAY_TOTAL_COLS.some(c => c.id === sortColumn)) { va = a[sortColumn]; vb = b[sortColumn]; }
        else if (sortHour !== null && a.hrs[sortHour]?.m && b.hrs[sortHour]?.m) {
          va = a.hrs[sortHour].m[sortColumn]; vb = b.hrs[sortHour].m[sortColumn];
        } else { va = a.date; vb = b.date; }
        if (va == null) va = -Infinity;
        if (vb == null) vb = -Infinity;
        return sortDirection === 'asc' ? (va < vb ? -1 : va > vb ? 1 : 0) : (va > vb ? -1 : va < vb ? 1 : 0);
      });
      
      return data;
    }
    
    function getVisibleHours() { return HOURS.filter(h => h >= hourFrom && h <= hourTo); }
    function getActiveColumns() { return ALL_COLUMNS.filter(c => visibleColumns.has(c.id)); }
    function getActiveDTCols() { return DAY_TOTAL_COLS.filter(c => visibleDTCols.has(c.id)); }
    
    // ==================== GRADIENTS ====================
    function getOrangeGradient(val, min, max) {
      if (val == null || max === min) return '#0d0d12';
      const t = Math.max(0, Math.min(1, (val - min) / (max - min)));
      return `rgb(${Math.round(13 + t * 238)}, ${Math.round(13 + t * 133)}, ${Math.round(18 + t * 42)})`;
    }
    
    function getOrangeGradientInverted(val, min, max) {
      if (val == null || max === min) return '#0d0d12';
      const t = 1 - Math.max(0, Math.min(1, (val - min) / (max - min)));
      return `rgb(${Math.round(13 + t * 238)}, ${Math.round(13 + t * 133)}, ${Math.round(18 + t * 42)})`;
    }
    
    function getPurpleGradient(val, min, max) {
      if (val == null || max === min) return '#0d0d12';
      const t = Math.max(0, Math.min(1, (val - min) / (max - min)));

      // Use power curve to emphasize extremes
      // Low values stay darker, high values become more vibrant purple
      const curved = Math.pow(t, 1.8);

      return `rgb(${Math.round(13 + curved * 154)}, ${Math.round(13 + curved * 126)}, ${Math.round(18 + curved * 232)})`;
    }
    
    function getRGGradient(val, min, max, allValues) {
      if (val == null) return '#0d0d12';
      if (val === 0) return '#0d0d12';

      // If allValues is provided, use percentile-based gradient
      if (allValues && allValues.length > 0) {
        const sorted = [...allValues].sort((a, b) => a - b);

        if (val > 0) {
          // For positive values, calculate percentile within positive values
          const positiveValues = sorted.filter(v => v > 0);
          if (positiveValues.length === 0) return '#0d0d12';

          // Find position of val in positiveValues
          const position = positiveValues.findIndex(v => v >= val);
          const percentile = position >= 0 ? position / positiveValues.length : 1;

          // Map percentile to gradient intensity (0 = transparent, 1 = full green)
          const t = Math.min(1, percentile);
          return `rgba(${Math.round(13 + t * 61)}, ${Math.round(13 + t * 209)}, ${Math.round(18 + t * 110)}, ${0.2 + t * 0.8})`;
        } else {
          // For negative values, calculate percentile within negative values
          const negativeValues = sorted.filter(v => v < 0);
          if (negativeValues.length === 0) return '#0d0d12';

          // Find position of val in negativeValues (reversed, so more negative = higher intensity)
          const position = negativeValues.findIndex(v => v >= val);
          const percentile = position >= 0 ? 1 - (position / negativeValues.length) : 0;

          // Map percentile to gradient intensity (0 = transparent, 1 = full red)
          const t = Math.min(1, percentile);
          return `rgba(${Math.round(13 + t * 235)}, ${Math.round(13 + t * 100)}, ${Math.round(18 + t * 95)}, ${0.2 + t * 0.8})`;
        }
      }

      // Fallback to original min/max based gradient
      if (val > 0) {
        const t = Math.min(1, val / Math.max(max, 1));
        return `rgb(${Math.round(13 + t * 61)}, ${Math.round(13 + t * 209)}, ${Math.round(18 + t * 110)})`;
      } else {
        const t = Math.min(1, Math.abs(val) / Math.abs(Math.min(min, -1)));
        return `rgb(${Math.round(13 + t * 235)}, ${Math.round(13 + t * 100)}, ${Math.round(18 + t * 95)})`;
      }
    }
    
    function getEstablishedHourGradient(hour) {
      if (hour == null) return '#0d0d12';
      // 12am-11am (hours 0-11): cyan gradient (transparent to cyan)
      if (hour >= 0 && hour <= 11) {
        const t = hour / 11; // 0 at 12am, 1 at 11am
        return `rgba(${Math.round(13 + t * 47)}, ${Math.round(13 + t * 198)}, ${Math.round(18 + t * 200)}, ${0.2 + t * 0.8})`;
      }
      // 12pm-11pm (hours 12-23): orange gradient (transparent to orange)
      else if (hour >= 12 && hour <= 23) {
        const t = (hour - 12) / 11; // 0 at 12pm, 1 at 11pm
        return `rgba(${Math.round(13 + t * 238)}, ${Math.round(13 + t * 133)}, ${Math.round(18 + t * 42)}, ${0.2 + t * 0.8})`;
      }
      return '#0d0d12';
    }

    function getMinuteGradient(minute) {
      if (minute == null) return '#0d0d12';
      // 0-25: Cyan gradient (transparent to cyan)
      if (minute >= 0 && minute <= 25) {
        const t = minute / 25;
        return `rgba(${Math.round(13 + t * 47)}, ${Math.round(13 + t * 198)}, ${Math.round(18 + t * 200)}, ${0.2 + t * 0.8})`;
      }
      // 30-55: Orange gradient (transparent to orange)
      else if (minute >= 30 && minute <= 55) {
        const t = (minute - 30) / 25;
        return `rgba(${Math.round(13 + t * 238)}, ${Math.round(13 + t * 133)}, ${Math.round(18 + t * 42)}, ${0.2 + t * 0.8})`;
      }
      return '#0d0d12';
    }

    function getGreenBarGradient(val) {
      if (val == null) return '#0d0d12';
      if (val < 6) {
        const t = (6 - val) / 6;
        return `rgb(${Math.round(13 + t * 235)}, ${Math.round(13 + t * 100)}, ${Math.round(18 + t * 95)})`;
      } else if (val > 6) {
        const t = (val - 6) / 6;
        return `rgb(${Math.round(13 + t * 61)}, ${Math.round(13 + t * 209)}, ${Math.round(18 + t * 110)})`;
      }
      return '#0d0d12';
    }
    
    function getRSIGradient(val) {
      // RSI gradient: 5-40 orange to transparent, 40-60 transparent, 60-95 transparent to blue
      if (val == null) return 'transparent';
      if (val <= 5) {
        // Full orange at 5
        return 'rgba(247, 147, 26, 0.7)';
      } else if (val < 40) {
        // Orange fading to transparent from 5 to 40
        const t = (val - 5) / 35; // 0 at 5, 1 at 40
        const alpha = 0.7 * (1 - t);
        return `rgba(247, 147, 26, ${alpha.toFixed(2)})`;
      } else if (val <= 60) {
        // Transparent in the middle
        return 'transparent';
      } else if (val < 95) {
        // Transparent to blue from 60 to 95
        const t = (val - 60) / 35; // 0 at 60, 1 at 95
        const alpha = 0.7 * t;
        return `rgba(100, 149, 237, ${alpha.toFixed(2)})`;
      } else {
        // Full blue at 95+
        return 'rgba(100, 149, 237, 0.7)';
      }
    }
    
    function calcRowStats(day, hours) {
      const s = { rng: [], urlr: [], mxr: [], mxl: [], rank: [], cl: [], oc: [], cdr: [], cdrRG: [], mxcd: [], rsi: [], sig: [], vol: [], b40: [], bars: [], interval: [], afterbar: [], maxrngbar: [], strength: [], m15rng: [] };
      getSortedHourKeys(day).forEach(h => {
        const m = day.hrs[h].m;
        if (!m) return;

        if (m.rng != null) s.rng.push(m.rng);
        if (m.ur != null) s.urlr.push(m.ur);
        if (m.lr != null) s.urlr.push(m.lr);
        if (m.mxr != null) s.mxr.push(m.mxr);
        if (m.mxl != null) s.mxl.push(m.mxl);

        ['mxrRk','mxlRk','ocRk','rngRk'].forEach(r => {
          if (m[r] != null) s.rank.push(m[r]);
        });

        if (m.cl != null) s.cl.push(m.cl);
        if (m.oc != null) s.oc.push(m.oc);

        if (m.cdrUActual != null) s.cdr.push(m.cdrUActual);
        if (m.cdrDActual != null) s.cdr.push(m.cdrDActual);
        if (m.cdr != null) s.cdrRG.push(m.cdr);

        if (m.mxcdActual != null) s.mxcd.push(m.mxcdActual);

        ['rsiMax','rsiMin','rsiAvg','rsiOpen','rsiClose','rsiDelta'].forEach(r => {
          if (m[r] != null) s.rsi.push(m[r]);
        });

        ['sigMax','sigMin','sigAvg'].forEach(r => {
          if (m[r] != null) s.sig.push(m[r]);
        });

        // Relative volume metrics
        if (m.rVol != null) s.vol.push(m.rVol);
        if (m.rVolC != null) s.vol.push(m.rVolC);
        if (m.rVolDOW != null) s.vol.push(m.rVolDOW);

        // B40 metrics
        if (m.bar40AfterHi != null) s.b40.push(m.bar40AfterHi);
        if (m.bar40AfterLo != null) s.b40.push(m.bar40AfterLo);
        if (m.maxB40HL != null) s.b40.push(m.maxB40HL);

        // Bar count metrics
        if (m.cumGreenBars != null) s.bars.push(m.cumGreenBars);
        if (m.cumRedBars != null) s.bars.push(m.cumRedBars);
        if (m.rthCumGreenBars != null) s.bars.push(m.rthCumGreenBars);
        if (m.rthCumRedBars != null) s.bars.push(m.rthCumRedBars);

        // Interval metrics
        if (m.oc0010 != null) s.interval.push(m.oc0010);
        if (m.oc1525 != null) s.interval.push(m.oc1525);
        if (m.oc3040 != null) s.interval.push(m.oc3040);
        if (m.oc4555 != null) s.interval.push(m.oc4555);

        // 15-minute range metrics
        if (m.m15UpperRng != null) s.m15rng.push(m.m15UpperRng);
        if (m.m15LowerRng != null) s.m15rng.push(m.m15LowerRng);
        if (m.m15FullRng != null) s.m15rng.push(m.m15FullRng);
        if (m.m15MaxRng != null) s.m15rng.push(m.m15MaxRng);

        // Max range bar metrics
        if (m.maxRngBarVal != null) s.maxrngbar.push(m.maxRngBarVal);

        // Strength metrics
        if (m.buyStr != null) s.strength.push(m.buyStr);
        if (m.sellStr != null) s.strength.push(m.sellStr);
        // overallStr can be negative, collect separately for red-green gradient
      });
      const r = {};
      Object.keys(s).forEach(k => {
        r[k] = s[k].length ? { min: Math.min(...s[k]), max: Math.max(...s[k]) } : { min: 0, max: 100 };
      });
      return r;
    }
    
    function calcColStats(data, hours) {
      const s = {};
      const hourSet = new Set();
      data.forEach(d => {
        getSortedHourKeys(d).forEach(h => hourSet.add(h));
      });
      const realHours = [...hourSet].map(Number).sort((a,b) => a-b);
      realHours.forEach(h => {
        s[h] = {
          rng: [], urlr: [], mxr: [], mxl: [], rank: [], cl: [], oc: [],
          cdrRG: [], cdr: [], mxcd: [], rsi: [], sig: [], vol: [],
          wcdr: [], wcdrRG: [], wmxcd: [],
          p5cdr: [], p5cdrRG: [], p5mxcd: [],
          b40: [], bars: [], interval: [], afterbar: [], maxrngbar: [], strength: [], m15rng: []
        };

        data.forEach(d => {
          const m = d.hrs[h]?.m;
          if (!m) return;

          if (m.rng != null) s[h].rng.push(m.rng);
          if (m.ur != null) s[h].urlr.push(m.ur);
          if (m.lr != null) s[h].urlr.push(m.lr);
          if (m.mxr != null) s[h].mxr.push(m.mxr);
          if (m.mxl != null) s[h].mxl.push(m.mxl);

          ['mxrRk','mxlRk','ocRk','rngRk'].forEach(r => {
            if (m[r] != null) s[h].rank.push(m[r]);
          });

          if (m.cl != null) s[h].cl.push(m.cl);
          if (m.oc != null) s[h].oc.push(m.oc);

          if (m.cdr != null) s[h].cdrRG.push(m.cdr);
          if (m.cdrUActual != null) s[h].cdr.push(m.cdrUActual);
          if (m.cdrDActual != null) s[h].cdr.push(m.cdrDActual);

          if (m.mxcdActual != null) s[h].mxcd.push(m.mxcdActual);

          ['rsiMax','rsiMin','rsiAvg','rsiOpen','rsiClose','rsiDelta'].forEach(r => {
            if (m[r] != null) s[h].rsi.push(m[r]);
          });

          ['sigMax','sigMin','sigAvg'].forEach(r => {
            if (m[r] != null) s[h].sig.push(m[r]);
          });

          // Relative volume metrics
          if (m.rVol != null) s[h].vol.push(m.rVol);
          if (m.rVolC != null) s[h].vol.push(m.rVolC);
          if (m.rVolDOW != null) s[h].vol.push(m.rVolDOW);

          // Weekly cumulative
          if (m.wCdr != null) s[h].wcdrRG.push(m.wCdr);
          if (m.wCdrUActual != null) s[h].wcdr.push(m.wCdrUActual);
          if (m.wCdrDActual != null) s[h].wcdr.push(m.wCdrDActual);
          if (m.wMxcdActual != null) s[h].wmxcd.push(m.wMxcdActual);

          // 5PM cumulative
          if (m.p5Cdr != null) s[h].p5cdrRG.push(m.p5Cdr);
          if (m.p5CdrUActual != null) s[h].p5cdr.push(m.p5CdrUActual);
          if (m.p5CdrDActual != null) s[h].p5cdr.push(m.p5CdrDActual);
          if (m.p5MxcdActual != null) s[h].p5mxcd.push(m.p5MxcdActual);

          // B40 metrics
          if (m.bar40AfterHi != null) s[h].b40.push(m.bar40AfterHi);
          if (m.bar40AfterLo != null) s[h].b40.push(m.bar40AfterLo);
          if (m.maxB40HL != null) s[h].b40.push(m.maxB40HL);

          // Bar count metrics
          if (m.cumGreenBars != null) s[h].bars.push(m.cumGreenBars);
          if (m.cumRedBars != null) s[h].bars.push(m.cumRedBars);
          if (m.rthCumGreenBars != null) s[h].bars.push(m.rthCumGreenBars);
          if (m.rthCumRedBars != null) s[h].bars.push(m.rthCumRedBars);

          // Interval metrics
          if (m.oc0010 != null) s[h].interval.push(m.oc0010);
          if (m.oc1525 != null) s[h].interval.push(m.oc1525);
          if (m.oc3040 != null) s[h].interval.push(m.oc3040);
          if (m.oc4555 != null) s[h].interval.push(m.oc4555);

          // 15-minute range metrics
          if (m.m15UpperRng != null) s[h].m15rng.push(m.m15UpperRng);
          if (m.m15LowerRng != null) s[h].m15rng.push(m.m15LowerRng);
          if (m.m15FullRng != null) s[h].m15rng.push(m.m15FullRng);
          if (m.m15MaxRng != null) s[h].m15rng.push(m.m15MaxRng);

          // Max range bar metrics
          if (m.maxRngBarVal != null) s[h].maxrngbar.push(m.maxRngBarVal);

          // Strength metrics
          if (m.buyStr != null) s[h].strength.push(m.buyStr);
          if (m.sellStr != null) s[h].strength.push(m.sellStr);
          if (m.overallStr != null) s[h].strength.push(m.overallStr);
        });
      });
      const r = {};
      realHours.forEach(h => {
        r[h] = {};
        Object.keys(s[h]).forEach(k => {
          r[h][k] = s[h][k].length
            ? { min: Math.min(...s[h][k]), max: Math.max(...s[h][k]), values: s[h][k] }
            : { min: 0, max: 100, values: [] };
        });
      });
      return r;
    }
    
    function calcDayTotalsStats(data) {
      const s = { drng: [], durdlr: [], doc: [], doch: [], ddd: [], drev: [], d5pm: [], d5pmoc: [], weekly: [], woc: [], dRelVol: [], dRsi: [], dBars: [], dBarDelta: [], dHourlyMaxRng: [] };
      data.forEach(d => {
        if (d.dRng != null) s.drng.push(d.dRng);
        if (d.dUR != null) s.durdlr.push(d.dUR);
        if (d.dLR != null) s.durdlr.push(d.dLR);
        if (d.dOC != null) s.doc.push(d.dOC);
        if (d.dDD != null) s.ddd.push(d.dDD);
        if (d.dRev != null) s.drev.push(d.dRev);
        // 5PM metrics
        if (d.d5pmUR != null) s.d5pm.push(d.d5pmUR);
        if (d.d5pmLR != null) s.d5pm.push(d.d5pmLR);
        if (d.d5pmMx != null) s.d5pm.push(d.d5pmMx);
        if (d.d5pmOC != null) s.d5pmoc.push(d.d5pmOC);
        // Weekly metrics
        if (d.wUR != null) s.weekly.push(d.wUR);
        if (d.wLR != null) s.weekly.push(d.wLR);
        if (d.wMx != null) s.weekly.push(d.wMx);
        if (d.wOC != null) s.woc.push(d.wOC);
        // Relative volume metrics
        if (d.dRelVol != null) s.dRelVol.push(d.dRelVol);
        if (d.dRelVolDOW != null) s.dRelVol.push(d.dRelVolDOW);
        // RSI metrics
        if (d.dRsiMed != null) s.dRsi.push(d.dRsiMed);
        if (d.dRthRsiAvg != null) s.dRsi.push(d.dRthRsiAvg);
        // Bar count metrics
        if (d.dCumGreenBars != null) s.dBars.push(d.dCumGreenBars);
        if (d.dCumRedBars != null) s.dBars.push(d.dCumRedBars);
        if (d.dRthCumGreenBars != null) s.dBars.push(d.dRthCumGreenBars);
        if (d.dRthCumRedBars != null) s.dBars.push(d.dRthCumRedBars);
        // Bar delta metrics
        if (d.dBarDelta != null) s.dBarDelta.push(d.dBarDelta);
        if (d.dRthBarDelta != null) s.dBarDelta.push(d.dRthBarDelta);
        // Hourly max range
        if (d.dHourlyMaxRng != null) s.dHourlyMaxRng.push(d.dHourlyMaxRng);
      });
      return {
        drng: s.drng.length ? { min: Math.min(...s.drng), max: Math.max(...s.drng) } : { min: 0, max: 0 },
        durdlr: s.durdlr.length ? { min: Math.min(...s.durdlr), max: Math.max(...s.durdlr) } : { min: 0, max: 0 },
        doc: s.doc.length ? { min: Math.min(...s.doc), max: Math.max(...s.doc) } : { min: 0, max: 0 },
        ddd: s.ddd.length ? { min: Math.min(...s.ddd), max: Math.max(...s.ddd) } : { min: 0, max: 0 },
        drev: s.drev.length ? { min: Math.min(...s.drev), max: Math.max(...s.drev) } : { min: 0, max: 0 },
        d5pm: s.d5pm.length ? { min: Math.min(...s.d5pm), max: Math.max(...s.d5pm) } : { min: 0, max: 1000 },
        d5pmoc: s.d5pmoc.length ? { min: Math.min(...s.d5pmoc), max: Math.max(...s.d5pmoc) } : { min: -500, max: 500 },
        weekly: s.weekly.length ? { min: Math.min(...s.weekly), max: Math.max(...s.weekly) } : { min: 0, max: 5000 },
        woc: s.woc.length ? { min: Math.min(...s.woc), max: Math.max(...s.woc) } : { min: -2000, max: 2000 },
        dRelVol: s.dRelVol.length ? { min: Math.min(...s.dRelVol), max: Math.max(...s.dRelVol) } : { min: 0, max: 2 },
        dRsi: s.dRsi.length ? { min: Math.min(...s.dRsi), max: Math.max(...s.dRsi) } : { min: 0, max: 100 },
        dBars: s.dBars.length ? { min: Math.min(...s.dBars), max: Math.max(...s.dBars) } : { min: 0, max: 288 },
        dBarDelta: s.dBarDelta.length ? { min: Math.min(...s.dBarDelta), max: Math.max(...s.dBarDelta) } : { min: -144, max: 144 },
        dHourlyMaxRng: s.dHourlyMaxRng.length ? { min: Math.min(...s.dHourlyMaxRng), max: Math.max(...s.dHourlyMaxRng) } : { min: 0, max: 2000 },
      };
    }
    
    // ==================== FORMATTING ====================
    function fmt(v, id) {
      if (v == null) return '';
      if (['hm','lm','rsiOBmin','rsiOSmin'].includes(id)) return ':' + String(v).padStart(2, '0');
      if (['up','dn','totl','mxl'].includes(id)) return v;
      if (id === 'cl') return v === 0 ? '0' : (v > 0 ? '+' + v : v);
      if (id === 'v') return v.toFixed(1);
      if (['o','hi','lo','c'].includes(id)) return v.toLocaleString();
      if (['oc','oc25','oc55','cdr','wCdr','p5Cdr','toNxtLvl'].includes(id)) return (v >= 0 ? '+' : '') + v.toLocaleString();
      if (id.endsWith('Rk')) return v;
      if (['cdrU','cdrD','mxcd','wCdrU','wCdrD','wMxcd','p5CdrU','p5CdrD','p5Mxcd'].includes(id)) return v.toLocaleString();
      if (['rsiMax','rsiMin','rsiAvg','rsiOpen','rsiClose','rsiDelta','sigMax','sigMin','sigAvg'].includes(id)) return v.toFixed(1);
      if (id === 'obos') return v;
      return v.toLocaleString();
    }
    
    function formatHourHeader(h) {
      const ampm = h >= 12 ? 'PM' : 'AM';
      const disp = h === 0 ? 12 : h > 12 ? h - 12 : h;
      return disp + ampm;
    }
    
    // ==================== RENDER TABLE ====================
    function renderTable() {
      const data = getFilteredData();

      // REAL hours actually present in filtered data
      const hourSet = new Set();
      data.forEach(d => {
        getSortedHourKeys(d).forEach(h => hourSet.add(Number(h)));
      });
      const realHours = [...hourSet].sort((a, b) => a - b);
      if (!realHours.length) {
        console.warn('renderTable: no realHours found');
        return;
      }
    
      // UI / settings
      const hours = getVisibleHours();
      const cols = getActiveColumns();
      const dtCols = getActiveDTCols();
      const gMode = document.getElementById('gradient-mode').value;
      ocCloseHour = parseInt(document.getElementById('oc-close-hour').value) || 16;
      
      // Calculate O-C to hour for each day
      data.forEach(d => {
        const closeHr = d.hrs[ocCloseHour];
        d.dOCH = d.dO && closeHr ? Math.round(closeHr.c - d.dO) : null;
      });
      
      data.forEach(d => calcRanks(d, hours));
      
      document.getElementById('stat-days').textContent = data.length;
      document.getElementById('stat-hours').textContent = hours.length;
      document.getElementById('stat-cols').textContent = cols.length;
      
      const dtStats = calcDayTotalsStats(data);
      const colStats = calcColStats(data, hours);
      
      // Build header
      let hd = '<tr class="hour-row">';
      hd += `<th class="sticky-col sticky-header" style="left:0;min-width:65px" rowspan="2" onclick="sortBy('date',null)">Date${sortColumn==='date'?(sortDirection==='asc'?'':''):''}</th>`;
      hd += `<th class="sticky-col sticky-header" style="left:65px;min-width:28px" rowspan="2">Day</th>`;
      hd += `<th class="sticky-col sticky-header" style="left:93px;min-width:20px" rowspan="2">#</th>`;
      
      if (showDayCols && dtCols.length > 0) {
        hd += `<th class="sticky-col sticky-header day-totals-header" style="left:113px" colspan="${dtCols.length}">Day Totals (ET)</th>`;
      }
      
      realHours.forEach((h, i) => {
        hd += `<th class="hour-header${i===0?' hour-border-left':''}" colspan="${cols.length}">${formatHourHeader(h)}</th>`;
      });
      hd += '</tr><tr class="col-row">';
      
      if (showDayCols && dtCols.length > 0) {
        let pos = 113;
        dtCols.forEach((c, i) => {
          const w = ['dOpen','dHigh','dLow','dClose'].includes(c.id) ? 52 : ['dOC','dOCH'].includes(c.id) ? 48 : 38;
          const isSorted = sortColumn === c.id;
          const isLast = i === dtCols.length - 1;
          hd += `<th class="sticky-col sticky-header-sub col-header${isSorted?' sorted':''}" style="left:${pos}px;min-width:${w}px${isLast?';border-right:2px solid rgba(100,149,237,0.3)':''}" onclick="sortBy('${c.id}',null)">${c.label}${isSorted?(sortDirection==='asc'?'':''):''}</th>`;
          pos += w;
        });
      }
      
      realHours.forEach((h, hi) => {
        cols.forEach((col, ci) => {
          const isSorted = sortColumn === col.id && sortHour === h;
          hd += `<th class="col-header${ci===0?' hour-border-left':''}${isSorted?' sorted':''}"
                  onclick="sortBy('${col.id}',${h})">
                  ${col.label}${isSorted?(sortDirection==='asc'?'':''):''}
                </th>`;
        });
      });
      hd += '</tr>';
      document.getElementById('table-head').innerHTML = hd;
      
      // Build body
      let bd = '';
      data.forEach(day => {
        const rowStats = gMode === 'row' ? calcRowStats(day, hours) : null;
        
        bd += '<tr>';
        bd += `<td class="sticky-col date-cell" style="left:0;min-width:65px;cursor:pointer;" onclick="loadDateInDayView('${day.date}')" title="Click to view in Day View">${day.date}</td>`;
        bd += `<td class="sticky-col day-cell" style="left:65px;min-width:28px">${DAYS_SHORT[day.dow]}</td>`;
        bd += `<td class="sticky-col occ-cell" style="left:93px;min-width:20px">${day.occ}</td>`;
        
        if (showDayCols && dtCols.length > 0) {
          let pos = 113;
          dtCols.forEach((c, i) => {
            const w = ['dOpen','dHigh','dLow','dClose'].includes(c.id) ? 52 : ['dOC','dOCH','d5pmOC','wOC'].includes(c.id) ? 48 : 38;
            const isLast = i === dtCols.length - 1;
            let val = day[c.id];
            let bg = '#0d0d12';
            let cls = 'day-total-cell';
            let extraStyle = '';
            
            if (c.id === 'dRng') bg = getOrangeGradient(val, dtStats.drng.min, dtStats.drng.max);
            else if (c.id === 'dUR' || c.id === 'dLR') bg = getOrangeGradient(val, dtStats.durdlr.min, dtStats.durdlr.max);
            else if (c.id === 'dOC' || c.id === 'dOCH') {
              bg = getRGGradient(val, dtStats.doc.min, dtStats.doc.max);
              cls += val >= 0 ? ' up' : ' down';
            }
            else if (c.id === 'dDD') bg = getOrangeGradient(val, dtStats.ddd.min, dtStats.ddd.max);
            else if (c.id === 'dRev') bg = getOrangeGradient(val, dtStats.drev.min, dtStats.drev.max);
            else if (c.id === 'dHiHr' || c.id === 'dLoHr' || c.id === 'dRthHiHr' || c.id === 'dRthLoHr') {
              val = val != null ? formatHourHeader(val) : '';
            }
            else if (['dOpen','dHigh','dLow','dClose'].includes(c.id)) {
              val = c.id === 'dOpen' ? day.dO : c.id === 'dHigh' ? day.dH : c.id === 'dLow' ? day.dL : day.dC;
              val = val && val !== -Infinity && val !== Infinity ? Math.round(val).toLocaleString() : '';
            }
            // 5PM metrics
            else if (c.id === 'd5pmUR' || c.id === 'd5pmLR' || c.id === 'd5pmMx') {
              bg = getOrangeGradient(val, dtStats.d5pm?.min || 0, dtStats.d5pm?.max || 1000);
            }
            else if (c.id === 'd5pmOC') {
              bg = getRGGradient(val, dtStats.d5pmoc?.min || -500, dtStats.d5pmoc?.max || 500);
              cls += val >= 0 ? ' up' : ' down';
            }
            // Weekly metrics
            else if (c.id === 'wUR' || c.id === 'wLR' || c.id === 'wMx') {
              bg = getOrangeGradient(val, dtStats.weekly?.min || 0, dtStats.weekly?.max || 5000);
            }
            else if (c.id === 'wOC') {
              bg = getRGGradient(val, dtStats.woc?.min || -2000, dtStats.woc?.max || 2000);
              cls += val >= 0 ? ' up' : ' down';
            }
            // Established hour metrics (color by hour column)
            else if (c.id === 'dUpEstHr' || c.id === 'dDnEstHr' || c.id === 'dRangeEstHr') {
              bg = getEstablishedHourGradient(val);
              val = val != null ? formatHourHeader(val) : '';
            }
            // Relative volume metrics (color by column)
            else if (c.id === 'dRelVol' || c.id === 'dRelVolDOW') {
              bg = getPurpleGradient(val, dtStats.dRelVol?.min || 0, dtStats.dRelVol?.max || 2);
            }
            // RSI metrics (purple gradient)
            else if (c.id === 'dRsiMed' || c.id === 'dRthRsiAvg') {
              bg = getPurpleGradient(val, dtStats.dRsi?.min || 0, dtStats.dRsi?.max || 100);
            }
            // Bar count metrics (orange gradient)
            else if (c.id === 'dCumGreenBars' || c.id === 'dCumRedBars' || c.id === 'dRthCumGreenBars' || c.id === 'dRthCumRedBars') {
              bg = getOrangeGradient(val, dtStats.dBars?.min || 0, dtStats.dBars?.max || 288);
            }
            // Bar delta metrics (red-green gradient)
            else if (c.id === 'dBarDelta' || c.id === 'dRthBarDelta') {
              bg = getRGGradient(val, dtStats.dBarDelta?.min || -144, dtStats.dBarDelta?.max || 144);
              cls += val >= 0 ? ' up' : ' down';
            }
            // Hourly max range
            else if (c.id === 'dHourlyMaxRng') {
              bg = getOrangeGradient(val, dtStats.dHourlyMaxRng?.min || 0, dtStats.dHourlyMaxRng?.max || 2000);
            }

            const fmtVal = typeof val === 'number' ? ((['dOC','dOCH','d5pmOC','wOC','dBarDelta','dRthBarDelta'].includes(c.id) ? (val >= 0 ? '+' : '') : '') + val.toLocaleString()) : val;
            bd += `<td class="sticky-col ${cls}" style="left:${pos}px;min-width:${w}px;background:${bg}${isLast?';border-right:2px solid rgba(100,149,237,0.3)':''}${extraStyle}">${fmtVal ?? ''}</td>`;
            pos += w;
          });
        }
        
        realHours.forEach((h, hi) => {
          const m = day.hrs[h]?.m;
          const stats = gMode === 'row' ? rowStats : colStats[h];
          const cStats = colStats[h];
          
          // Check if this hour made a new day high/low (for hi/lo column borders)
          let madeNewDayHigh = false, madeNewDayLow = false;
          if (day.hrs[h]) {
            let runH = -Infinity, runL = Infinity;
            realHours.forEach(ph => {
              if (ph >= h) return;
              if (day.hrs[ph]) {
                runH = Math.max(runH, day.hrs[ph].h);
                runL = Math.min(runL, day.hrs[ph].l);
              }
            });
            madeNewDayHigh = day.hrs[h].h > runH;
            madeNewDayLow = day.hrs[h].l < runL;
          }
          
          cols.forEach((col, ci) => {
            // For Overview tab, always show actual CDU/CDD/MXCD values (not conditional)
            let v;
            if (col.id === 'cdrU') v = m?.cdrUActual;
            else if (col.id === 'cdrD') v = m?.cdrDActual;
            else if (col.id === 'mxcd') v = m?.mxcdActual;
            else if (col.id === 'wCdrU') v = m?.wCdrUActual;
            else if (col.id === 'wCdrD') v = m?.wCdrDActual;
            else if (col.id === 'wMxcd') v = m?.wMxcdActual;
            else if (col.id === 'p5CdrU') v = m?.p5CdrUActual;
            else if (col.id === 'p5CdrD') v = m?.p5CdrDActual;
            else if (col.id === 'p5Mxcd') v = m?.p5MxcdActual;
            else v = m?.[col.id];
            
            let bg = '#0d0d12';
            
            if (col.gradient === 'orange' && stats[col.group]) bg = getOrangeGradient(v, stats[col.group].min, stats[col.group].max);
            else if (col.gradient === 'orange-inv' && stats[col.group]) bg = getOrangeGradientInverted(v, stats[col.group].min, stats[col.group].max);
            else if (col.gradient === 'rg' && stats[col.group]) {
              // For overallStr (NetStr), use percentile-based gradient
              if (col.id === 'overallStr' && stats[col.group].values) {
                bg = getRGGradient(v, stats[col.group].min, stats[col.group].max, stats[col.group].values);
              } else {
                bg = getRGGradient(v, stats[col.group].min, stats[col.group].max);
              }
            }
            else if (col.gradient === 'orange-col' && cStats?.cdr) bg = getOrangeGradient(v, cStats.cdr.min, cStats.cdr.max);
            else if (col.gradient === 'rg-col' && cStats?.cdrRG) bg = getRGGradient(v, cStats.cdrRG.min, cStats.cdrRG.max);
            else if (col.gradient === 'purple' && stats[col.group]) bg = getPurpleGradient(v, stats[col.group].min, stats[col.group].max);
            else if (col.gradient === 'minute') bg = getMinuteGradient(v);
            else if (col.gradient === 'esthr') bg = getEstablishedHourGradient(v);
            
            if (col.id === 'mxcd' && cStats?.mxcd) bg = getOrangeGradient(v, cStats.mxcd.min, cStats.mxcd.max);
            // Weekly cumulative gradients
            if (col.id === 'wCdrU' && cStats?.wcdr) bg = getOrangeGradient(v, cStats.wcdr.min, cStats.wcdr.max);
            else if (col.id === 'wCdrD' && cStats?.wcdr) bg = getOrangeGradient(v, cStats.wcdr.min, cStats.wcdr.max);
            else if (col.id === 'wMxcd' && cStats?.wmxcd) bg = getOrangeGradient(v, cStats.wmxcd.min, cStats.wmxcd.max);
            else if (col.id === 'wCdr' && cStats?.wcdrRG) bg = getRGGradient(v, cStats.wcdrRG.min, cStats.wcdrRG.max);
            // 5PM cumulative gradients
            if (col.id === 'p5CdrU' && cStats?.p5cdr) bg = getOrangeGradient(v, cStats.p5cdr.min, cStats.p5cdr.max);
            else if (col.id === 'p5CdrD' && cStats?.p5cdr) bg = getOrangeGradient(v, cStats.p5cdr.min, cStats.p5cdr.max);
            else if (col.id === 'p5Mxcd' && cStats?.p5mxcd) bg = getOrangeGradient(v, cStats.p5mxcd.min, cStats.p5mxcd.max);
            else if (col.id === 'p5Cdr' && cStats?.p5cdrRG) bg = getRGGradient(v, cStats.p5cdrRG.min, cStats.p5cdrRG.max);
            // Minute-based gradients for HMin/LMin
            if (col.id === 'hm' || col.id === 'lm') {
              bg = getMinuteGradient(v);
            }

            let cls = 'data-cell';
            if (col.id === 'cl') cls += v > 0 ? ' up' : v < 0 ? ' down' : ' neutral';
            else if (col.id === 'up' && v > 0) cls += ' up';
            else if (col.id === 'dn' && v > 0) cls += ' down';
            else if (['oc','cdr','wCdr','p5Cdr'].includes(col.id)) cls += v > 0 ? ' up' : v < 0 ? ' down' : '';
            else if (col.id === 'obos') cls += v === 'OB' ? ' ob' : v === 'OS' ? ' os' : '';
            
            // Add border for hi/lo columns if new day high/low made
            let extraStyle = '';
            if (col.id === 'hi' && madeNewDayHigh) extraStyle = 'border:2px solid #4ade80;';
            else if (col.id === 'lo' && madeNewDayLow) extraStyle = 'border:2px solid #f87171;';

            // Add border for Any Hour filter matches
            const hasMatch = day._matchedHours?.[col.id]?.has(h);
            if (hasMatch) extraStyle = 'border:2px solid #fbbf24;';

            bd += `<td class="${cls}${ci===0?' hour-border-left':''}" style="background:${bg};${extraStyle}">${fmt(v, col.id)}</td>`;
          });
        });
        bd += '</tr>';
      });
      
      // Add percentile rows if enabled
      if (showPercentiles && data.length > 0) {
        const percentiles = [10, 25, 50, 75, 90];

        // Calculate percentile values for day total columns
        const dayColVals = {};
        if (showDayCols && dtCols.length > 0) {
          dtCols.forEach(col => {
            dayColVals[col.id] = [];
          });
          data.forEach(day => {
            dtCols.forEach(col => {
              const v = day[col.id];
              if (v != null && typeof v === 'number') dayColVals[col.id].push(v);
            });
          });
        }

        // Calculate percentile values for each hour and column
        const hourColVals = {};
        realHours.forEach(h => {
          hourColVals[h] = {};
          cols.forEach(col => {
            hourColVals[h][col.id] = [];
          });
        });

        data.forEach(day => {
          realHours.forEach(h => {
            const m = day.hrs[h]?.m;
            if (!m) return;
            cols.forEach(col => {
              let v;
              if (col.id === 'cdrU') v = m.cdrUActual;
              else if (col.id === 'cdrD') v = m.cdrDActual;
              else if (col.id === 'mxcd') v = m.mxcdActual;
              else v = m[col.id];
              if (v != null && typeof v === 'number') hourColVals[h][col.id].push(v);
            });
          });
        });

        // Calculate percentile function
        function calcPercentile(arr, p) {
          if (arr.length === 0) return null;
          const sorted = [...arr].sort((a, b) => a - b);
          const idx = (p / 100) * (sorted.length - 1);
          const lower = Math.floor(idx);
          const upper = Math.ceil(idx);
          if (lower === upper) return sorted[lower];
          return sorted[lower] + (sorted[upper] - sorted[lower]) * (idx - lower);
        }

        // Add percentile rows
        percentiles.forEach(p => {
          bd += `<tr class="percentile-row" style="background:rgba(247,147,26,0.08);border-top:2px solid rgba(247,147,26,0.3);">`;
          bd += `<td class="sticky-col" style="left:0;min-width:65px;font-weight:600;color:var(--accent-btc)">P${p}</td>`;
          bd += `<td class="sticky-col" style="left:65px;min-width:28px"></td>`;
          bd += `<td class="sticky-col" style="left:93px;min-width:20px"></td>`;

          if (showDayCols && dtCols.length > 0) {
            let pos = 113;
            dtCols.forEach((c, i) => {
              const vals = dayColVals[c.id];
              const pVal = calcPercentile(vals, p);
              const display = pVal != null ? (Number.isInteger(pVal) ? pVal : pVal.toFixed(1)) : '';
              const w = ['dOpen','dHigh','dLow','dClose'].includes(c.id) ? 52 : ['dOC','dOCH','d5pmOC','wOC'].includes(c.id) ? 48 : 38;
              const isLast = i === dtCols.length - 1;
              bd += `<td class="sticky-col" style="left:${pos}px;min-width:${w}px;font-size:9px;color:var(--accent-btc)${isLast?';border-right:2px solid rgba(100,149,237,0.3)':''}";>${display}</td>`;
              pos += w;
            });
          }

          realHours.forEach((h, hi) => {
            cols.forEach((col, ci) => {
              const vals = hourColVals[h][col.id];
              const pVal = calcPercentile(vals, p);
              const display = pVal != null ? (Number.isInteger(pVal) ? pVal : pVal.toFixed(1)) : '';
              bd += `<td class="data-cell${ci===0?' hour-border-left':''}" style="font-size:9px;color:var(--accent-btc)">${display}</td>`;
            });
          });
          bd += '</tr>';
        });
      }
      
      document.getElementById('table-body').innerHTML = bd;
    }
    
    // ==================== DAY VIEW ====================
    function populateDayViewSelect() {
      const sel = document.getElementById('day-view-date');
      const sel2 = document.getElementById('day-view-date2');
      const opts = allETDates.map(d => `<option value="${d}">${d} (${DAYS_SHORT[etDays[d].dow]})</option>`).join('');
      sel.innerHTML = opts;
      sel2.innerHTML = opts;
      // Set second date to previous day if available
      if (allETDates.length > 1) sel2.value = allETDates[1];
    }
    
    function renderDayView() {
      const date = document.getElementById('day-view-date').value;
      if (!date || !barsByET[date]) return;

      const lvl = parseInt(document.getElementById('day-level-size').value) || 250;
      const hlFrom = parseInt(document.getElementById('day-hl-from').value);
      const hlTo = parseInt(document.getElementById('day-hl-to').value);
      const day = etDays[date];
      const bars = barsByET[date];

      const date2 = compareMode ? document.getElementById('day-view-date2').value : null;
      let titleText = `${date} (${DAYS_SHORT[day.dow]})`;
      if (compareMode && date2 && etDays[date2]) {
        titleText += ` vs ${date2} (${DAYS_SHORT[etDays[date2].dow]})`;
      }
      document.getElementById('day-view-title').textContent = titleText;

      document.getElementById('day-stats-grid').innerHTML = `
        <div class="day-stat-box"><div class="day-stat-val">${day.dRng?.toLocaleString() ?? ''}</div><div class="day-stat-lbl">Day Range</div></div>
        <div class="day-stat-box"><div class="day-stat-val">${day.dUR?.toLocaleString() ?? ''}</div><div class="day-stat-lbl">Day UR</div></div>
        <div class="day-stat-box"><div class="day-stat-val">${day.dLR?.toLocaleString() ?? ''}</div><div class="day-stat-lbl">Day LR</div></div>
        <div class="day-stat-box"><div class="day-stat-val ${day.dOC >= 0 ? 'positive' : 'negative'}">${day.dOC != null ? ((day.dOC>=0?'+':'')+day.dOC.toLocaleString()) : ''}</div><div class="day-stat-lbl">Day O-C</div></div>
        <div class="day-stat-box"><div class="day-stat-val">${day.dHiHr != null ? formatHourHeader(day.dHiHr) : ''}</div><div class="day-stat-lbl">High Hour</div></div>
        <div class="day-stat-box"><div class="day-stat-val">${day.dLoHr != null ? formatHourHeader(day.dLoHr) : ''}</div><div class="day-stat-lbl">Low Hour</div></div>
        <div class="day-stat-box"><div class="day-stat-val">${day.dDD?.toLocaleString() ?? ''}</div><div class="day-stat-lbl">Drawdown</div></div>
        <div class="day-stat-box"><div class="day-stat-val">${day.dRev?.toLocaleString() ?? ''}</div><div class="day-stat-lbl">Reversal</div></div>
      `;

      const hourBars = {};
      bars.forEach(b => {
        if (!hourBars[b.etHour]) hourBars[b.etHour] = {};
        hourBars[b.etHour][String(b.etMin).padStart(2, '0')] = b;
      });

      // Get hours specific to this day
      const dayHours = Object.keys(day.hrs).map(Number).sort((a, b) => a - b);

      // Pre-calculate which minutes made new highs/lows for each hour
      const hourHighLowMins = {};
      dayHours.forEach(h => {
        hourHighLowMins[h] = { highMins: new Set(), lowMins: new Set() };
        let runningHigh = -Infinity;
        let runningLow = Infinity;
      
        MINS.forEach(m => {
          const bar = hourBars[h]?.[m];
          if (!bar) return;
      
          if (bar.high > runningHigh) {
            runningHigh = bar.high;
            hourHighLowMins[h].highMins.add(m);
          }
          if (bar.low < runningLow) {
            runningLow = bar.low;
            hourHighLowMins[h].lowMins.add(m);
          }
        });
      
        if (hourHighLowMins[h].highMins.size > 1) hourHighLowMins[h].highMins.delete('00');
        if (hourHighLowMins[h].lowMins.size > 1) hourHighLowMins[h].lowMins.delete('00');
      });
      
      // Pre-calculate which bars made new DAY high/low
      const dayHighLowBars = { highBars: new Set(), lowBars: new Set() };
      let dayRunningHigh = -Infinity;
      let dayRunningLow = Infinity;
      dayHours.forEach(h => {
        MINS.forEach(m => {
          const bar = hourBars[h]?.[m];
          if (!bar) return;
      
          if (bar.high > dayRunningHigh) {
            dayRunningHigh = bar.high;
            dayHighLowBars.highBars.add(`${h}-${m}`);
          }
          if (bar.low < dayRunningLow) {
            dayRunningLow = bar.low;
            dayHighLowBars.lowBars.add(`${h}-${m}`);
          }
        });
      });
      // Remove first bar if others made new high/low
      const firstBarKey = HOURS.find(h => hourBars[h]) !== undefined ? 
        `${HOURS.find(h => hourBars[h])}-00` : null;
      if (firstBarKey && dayHighLowBars.highBars.size > 1 && dayHighLowBars.highBars.has(firstBarKey)) {
        dayHighLowBars.highBars.delete(firstBarKey);
      }
      if (firstBarKey && dayHighLowBars.lowBars.size > 1 && dayHighLowBars.lowBars.has(firstBarKey)) {
        dayHighLowBars.lowBars.delete(firstBarKey);
      }
      
      // Calculate hourly drawdown and reversal for each hour
      const hourlyDDRev = {};
      Object.keys(hourBars).map(Number).sort((a,b)=>a-b).forEach(h => {
        const hd = day.hrs[h];
        if (!hd) return;
      
        // Hourly high drawdown: drop from hour high to lowest point after
        let postHiLow = Infinity;
        let foundHi = false;
        MINS.forEach(m => {
          const bar = hourBars[h]?.[m];
          if (!bar) return;
          if (bar.high >= hd.h - 0.01) foundHi = true;
          if (foundHi) postHiLow = Math.min(postHiLow, bar.low);
        });
        const hDD = foundHi && postHiLow < Infinity
          ? Math.round(hd.h - postHiLow)
          : null;
      
        // Hourly low reversal: rise from hour low to highest point after
        let postLoHigh = -Infinity;
        let foundLo = false;
        MINS.forEach(m => {
          const bar = hourBars[h]?.[m];
          if (!bar) return;
          if (bar.low <= hd.l + 0.01) foundLo = true;
          if (foundLo) postLoHigh = Math.max(postLoHigh, bar.high);
        });
        const hRev = foundLo && postLoHigh > -Infinity
          ? Math.round(postLoHigh - hd.l)
          : null;
      
        hourlyDDRev[h] = { hDD, hRev };
      });
      
      // Calculate cumulative max drawdown and max reversal (resets on new extremes)
      const cumDDRev = {};
      let currentHigh = -Infinity;
      let currentLow = Infinity;
      let currentDD = 0;
      let currentRev = 0;
      let prevDD = null, prevRev = null;
      
      dayHours.forEach(h => {
        const hd = day.hrs[h];
        if (!hd) return;
      
        const hourHigh = hd.h;
        const hourLow = hd.l;
      
        let madeNewHigh = false;
        if (hourHigh > currentHigh) {
          currentHigh = hourHigh;
          currentDD = 0;
          madeNewHigh = true;
        }
      
        let madeNewLow = false;
        if (hourLow < currentLow) {
          currentLow = hourLow;
          currentRev = 0;
          madeNewLow = true;
        }
      
        if (!madeNewHigh) {
          const ddFromHigh = Math.round(currentHigh - hourLow);
          currentDD = Math.max(currentDD, ddFromHigh);
        }
      
        if (!madeNewLow) {
          const revFromLow = Math.round(hourHigh - currentLow);
          currentRev = Math.max(currentRev, revFromLow);
        }
      
        cumDDRev[h] = {
          mxDD: (currentDD !== prevDD || madeNewHigh) ? currentDD : null,
          mxRev: (currentRev !== prevRev || madeNewLow) ? currentRev : null,
          mxDDActual: currentDD,
          mxRevActual: currentRev,
          madeNewHigh,
          madeNewLow,
        };
      
        prevDD = currentDD;
        prevRev = currentRev;
      });
      
      let hd = '<tr>';
      hd += '<th rowspan="2" class="hour-cell" style="min-width:45px;background:#1a1a24">Hour</th>';
      hd += '<th colspan="11" class="group-header">Range &amp; Levels</th>';
      if (showDayOHLC) hd += '<th colspan="4" class="group-header ohlc-header">OHLC</th>';
      hd += '<th colspan="7" class="group-header cum-header">Cumulative</th>';
      hd += `<th colspan="${MINS.length}" class="group-header section-header">5-Min Bars</th>`;
      hd += '</tr><tr>';
      hd += '<th class="group-border">Rng</th><th>UR</th><th>LR</th><th>#Up</th><th>#Dn</th><th>#Cl</th><th>HMin</th><th>LMin</th><th>O-C</th><th>HDD</th><th>HRev</th>';
      if (showDayOHLC) hd += '<th class="group-border">Open</th><th>High</th><th>Low</th><th>Close</th>';
      hd += '<th class="group-border">CDR</th><th>CURng</th><th>CDUp</th><th>CDDn</th><th>MxDD</th><th>MxRev</th><th>#Grn</th>';
      MINS.forEach((m, i) => { hd += `<th class="${i === 0 ? 'group-border section-header' : 'section-header'}">:${m}</th>`; });
      hd += '</tr>';
      document.getElementById('day-table-head').innerHTML = hd;
      
      const hourStats = { rng: [], urlr: [], oc: [], cdr: [], ddrev: [] };
      const minStats = { ur: [], lr: [], oc: [], hrOC: [] };

      dayHours.forEach(h => {
        const hd = day.hrs[h];
        if (hd?.m) {
          hourStats.rng.push(hd.m.rng);
          hourStats.urlr.push(hd.m.ur, hd.m.lr);
          hourStats.oc.push(hd.m.oc);
          hourStats.cdr.push(hd.m.cdr);
        }
        if (hourlyDDRev[h]) {
          if (hourlyDDRev[h].hDD != null) hourStats.ddrev.push(hourlyDDRev[h].hDD);
          if (hourlyDDRev[h].hRev != null) hourStats.ddrev.push(hourlyDDRev[h].hRev);
        }
      });
      dayHours.forEach(h => {
        if (!day.hrs[h]) return;
        MINS.forEach(m => {
          const bar = hourBars[h]?.[m];
          if (!bar) return;
          minStats.ur.push(Math.round(bar.high - bar.open));
          minStats.lr.push(Math.round(bar.open - bar.low));
          minStats.oc.push(Math.round(bar.close - bar.open));
          minStats.hrOC.push(Math.round(bar.close - day.hrs[h].o));
        });
      });
      
      const hStats = {
        rng: { min: Math.min(...hourStats.rng), max: Math.max(...hourStats.rng) },
        urlr: { min: Math.min(...hourStats.urlr), max: Math.max(...hourStats.urlr) },
        oc: { min: Math.min(...hourStats.oc), max: Math.max(...hourStats.oc) },
        cdr: { min: Math.min(...hourStats.cdr), max: Math.max(...hourStats.cdr) },
        ddrev: hourStats.ddrev.length ? { min: Math.min(...hourStats.ddrev), max: Math.max(...hourStats.ddrev) } : { min: 0, max: 100 },
      };
      const mStats = {
        urlr: { min: Math.min(...minStats.ur, ...minStats.lr), max: Math.max(...minStats.ur, ...minStats.lr) },
        oc: { min: Math.min(...minStats.oc), max: Math.max(...minStats.oc) },
        hrOC: minStats.hrOC.length ? { min: Math.min(...minStats.hrOC), max: Math.max(...minStats.hrOC) } : { min: -100, max: 100 },
      };

      // Calculate after high/low stats for gradients (excluding :55 bars)
      const afterHLStats = { hh: [], hl: [], hhc: [], cll: [] };
      if (showAfterHL !== 'off') {
        dayHours.forEach(h => {
          const hourData = day.hrs[h];
          if (!hourData) return;
          const hourHigh = hourData.h;
          const hourLow = hourData.l;

          MINS.forEach(m => {
            if (m === '55') return; // Exclude :55 bars
            const bar = hourBars[h]?.[m];
            if (!bar) return;

            if (showAfterHL === 'afterhl') {
              if (bar.hhAfterClose != null) afterHLStats.hh.push(bar.hhAfterClose);
              if (bar.hlAfterClose != null) afterHLStats.hl.push(bar.hlAfterClose);
            } else if (showAfterHL === 'hhcll') {
              // Calculate hour high - bar close and bar close - hour low
              const hhc = Math.round(hourHigh - bar.close);
              const cll = Math.round(bar.close - hourLow);
              if (hhc != null) afterHLStats.hhc.push(Math.abs(hhc));
              if (cll != null) afterHLStats.cll.push(Math.abs(cll));
            }
          });
        });
      }
      const afterHLRange = (showAfterHL === 'afterhl' && afterHLStats.hh.length && afterHLStats.hl.length) ? {
        min: Math.min(...afterHLStats.hh, ...afterHLStats.hl),
        max: Math.max(...afterHLStats.hh, ...afterHLStats.hl)
      } : (showAfterHL === 'hhcll' && afterHLStats.hhc.length && afterHLStats.cll.length) ? {
        min: Math.min(...afterHLStats.hhc, ...afterHLStats.cll),
        max: Math.max(...afterHLStats.hhc, ...afterHLStats.cll)
      } : { min: 0, max: 100 };

      let bd = '';
      dayHours.forEach(h => {
        const hd = day.hrs[h];
        const hm = hd?.m;
        const isHL = h >= hlFrom && h <= hlTo;
        const rowCls = isHL ? ' class="hour-row-highlighted"' : '';
        const hourCls = isHL ? 'hour-cell highlighted' : 'hour-cell';
        const ddrev = hourlyDDRev[h] || {};
        const cumDD = cumDDRev[h] || {};
        
        bd += `<tr${rowCls}><td class="${hourCls}">${formatHourHeader(h)}</td>`;
        
        if (hm) {
          bd += `<td class="group-border" style="background:${getOrangeGradient(hm.rng, hStats.rng.min, hStats.rng.max)}">${hm.rng}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.ur, hStats.urlr.min, hStats.urlr.max)}">${hm.ur}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.lr, hStats.urlr.min, hStats.urlr.max)}">${hm.lr}</td>`;
          bd += `<td style="color:${hm.up > 0 ? '#a7f3d0' : ''}">${hm.up}</td>`;
          bd += `<td style="color:${hm.dn > 0 ? '#fecaca' : ''}">${hm.dn}</td>`;
          bd += `<td style="color:${hm.cl > 0 ? '#a7f3d0' : hm.cl < 0 ? '#fecaca' : ''}">${hm.cl > 0 ? '+' + hm.cl : hm.cl}</td>`;
          bd += `<td>:${String(hm.hm).padStart(2,'0')}</td>`;
          bd += `<td>:${String(hm.lm).padStart(2,'0')}</td>`;
          bd += `<td class="${hm.oc >= 0 ? 'up' : 'down'}" style="background:${getRGGradient(hm.oc, hStats.oc.min, hStats.oc.max)}">${hm.oc >= 0 ? '+' : ''}${hm.oc}</td>`;
          bd += `<td style="background:${ddrev.hDD != null ? getOrangeGradient(ddrev.hDD, hStats.ddrev.min, hStats.ddrev.max) : ''}">${ddrev.hDD ?? ''}</td>`;
          bd += `<td style="background:${ddrev.hRev != null ? getOrangeGradient(ddrev.hRev, hStats.ddrev.min, hStats.ddrev.max) : ''}">${ddrev.hRev ?? ''}</td>`;
          if (showDayOHLC) {
            const highBorder = cumDD.madeNewHigh ? 'border:2px solid #4ade80;' : '';
            const lowBorder = cumDD.madeNewLow ? 'border:2px solid #f87171;' : '';
            bd += `<td class="group-border">${hm.o.toLocaleString()}</td>`;
            bd += `<td style="${highBorder}">${hm.hi.toLocaleString()}</td>`;
            bd += `<td style="${lowBorder}">${hm.lo.toLocaleString()}</td>`;
            bd += `<td>${hm.c.toLocaleString()}</td>`;
          }
          bd += `<td class="group-border ${hm.cdr >= 0 ? 'up' : 'down'}" style="background:${getRGGradient(hm.cdr, hStats.cdr.min, hStats.cdr.max)}">${hm.cdr >= 0 ? '+' : ''}${hm.cdr}</td>`;
          bd += `<td style="background:${hm.mxcd != null ? getOrangeGradient(hm.mxcdActual, 0, hStats.urlr.max) : ''}">${hm.mxcd != null ? hm.mxcd : ''}</td>`;
          bd += `<td style="background:${hm.cdrU != null ? getOrangeGradient(hm.cdrUActual, 0, hStats.urlr.max) : ''}">${hm.cdrU != null ? hm.cdrU : ''}</td>`;
          bd += `<td style="background:${hm.cdrD != null ? getOrangeGradient(hm.cdrDActual, 0, hStats.urlr.max) : ''}">${hm.cdrD != null ? hm.cdrD : ''}</td>`;
          const ddBorder = cumDD.madeNewHigh ? 'border:2px solid #4ade80;' : '';
          const revBorder = cumDD.madeNewLow ? 'border:2px solid #f87171;' : '';
          bd += `<td style="background:${cumDD.mxDD != null ? getOrangeGradient(cumDD.mxDDActual, 0, hStats.urlr.max) : ''};${ddBorder}">${cumDD.mxDD != null ? cumDD.mxDD : ''}</td>`;
          bd += `<td style="background:${cumDD.mxRev != null ? getOrangeGradient(cumDD.mxRevActual, 0, hStats.urlr.max) : ''};${revBorder}">${cumDD.mxRev != null ? cumDD.mxRev : ''}</td>`;
          bd += `<td style="background:${getGreenBarGradient(hm.greenBars)}">${hm.greenBars}</td>`;
        } else {
          bd += `<td colspan="${11 + (showDayOHLC ? 4 : 0) + 7}" class="group-border" style="color:var(--text-muted)">No data</td>`;
        }
        
        const hlMins = hourHighLowMins[h] || { highMins: new Set(), lowMins: new Set() };
        
        MINS.forEach((m, mi) => {
          const bar = hourBars[h]?.[m];
          const borderCls = mi === 0 ? ' group-border' : '';
          if (bar && hd) {
            const ur = Math.round(bar.high - bar.open);
            const lr = Math.round(bar.open - bar.low);
            const oc = Math.round(bar.close - bar.open);
            const lvlUp = Math.max(0, Math.floor(bar.high / lvl) - Math.floor(bar.open / lvl));
            const lvlDn = Math.max(0, Math.floor(bar.open / lvl) - Math.floor(bar.low / lvl));
            const lvlCl = Math.floor(bar.close / lvl) - Math.floor(bar.open / lvl);
            const hrOC = Math.round(bar.close - hd.o);
            const hrLvl = Math.floor(bar.close / lvl) - Math.floor(hd.o / lvl);
            
            // Check if this minute made a new high or low for the hour
            const madeNewHourHigh = hlMins.highMins.has(m);
            const madeNewHourLow = hlMins.lowMins.has(m);
            const urBorder = madeNewHourHigh ? 'border:2px solid #4ade80;' : '';
            const lrBorder = madeNewHourLow ? 'border:2px solid #f87171;' : '';
            
            // Check if this minute made a new high or low for the DAY
            const barKey = `${h}-${m}`;
            const madeNewDayHigh = dayHighLowBars.highBars.has(barKey);
            const madeNewDayLow = dayHighLowBars.lowBars.has(barKey);
            let ocBorder = '';
            if (madeNewDayHigh && madeNewDayLow) ocBorder = 'border:2px solid #fbbf24;'; // Yellow for both
            else if (madeNewDayHigh) ocBorder = 'border:2px solid #4ade80;';
            else if (madeNewDayLow) ocBorder = 'border:2px solid #f87171;';
            
            const barRsi = bar.rsi != null ? Math.round(bar.rsi) : null;
            const rsiDisplay = barRsi != null ? barRsi : '';
            const rsiBg = getRSIGradient(barRsi);
            // RSI OB/OS border - now on entire row4, purple for OB, orange for OS
            let row4BorderCls = '';
            if (barRsi != null && barRsi >= obLevel) row4BorderCls = ' rsi-ob-border';
            else if (barRsi != null && barRsi <= osLevel) row4BorderCls = ' rsi-os-border';
            
            // Gradient for row4 based on hrOC value
            const hrOCGradient = getRGGradient(hrOC, mStats.hrOC.min, mStats.hrOC.max);

            // Check for high relative volume
            const rVolHighlight = bar.rVol != null && bar.rVol >= rVolThreshold ? 'box-shadow: inset 0 0 0 4px rgba(255, 255, 255, 0.9); z-index: 10; position: relative;' : '';

            // Build tooltip info
            const barRng = Math.round(bar.high - bar.low);
            const barMaxUR = ur;
            const barMaxLR = lr;
            const tooltipText = `O: ${Math.round(bar.open).toLocaleString()}\\nH: ${Math.round(bar.high).toLocaleString()}\\nL: ${Math.round(bar.low).toLocaleString()}\\nC: ${Math.round(bar.close).toLocaleString()}\\nRng: ${barRng}\\nUR: ${barMaxUR} / LR: ${barMaxLR}`;

            // After High/Low with 2-column grid and gradient coloring
            let afterHLRow = '';
            if (showAfterHL !== 'off') {
              if (m === '55') {
                // Show blank for :55 bars (no bar after them)
                afterHLRow = '<div class="after-metrics-grid"><div class="after-high"></div><div class="after-low"></div></div>';
              } else if (showAfterHL === 'afterhl') {
                const hhGradient = bar.hhAfterClose != null ? getOrangeGradient(bar.hhAfterClose, afterHLRange.min, afterHLRange.max) : 'transparent';
                const hlGradient = bar.hlAfterClose != null ? getOrangeGradient(bar.hlAfterClose, afterHLRange.min, afterHLRange.max) : 'transparent';
                afterHLRow = `<div class="after-metrics-grid"><div class="after-high" style="background:${hhGradient}">+${bar.hhAfterClose ?? 0}</div><div class="after-low" style="background:${hlGradient}">${bar.hlAfterClose >= 0 ? '+' : ''}${bar.hlAfterClose ?? 0}</div></div>`;
              } else if (showAfterHL === 'hhcll') {
                const hourData = day.hrs[h];
                const hhc = Math.round(hourData.h - bar.close);
                const cll = Math.round(bar.close - hourData.l);
                const hhcGradient = getOrangeGradient(Math.abs(hhc), afterHLRange.min, afterHLRange.max);
                const cllGradient = getOrangeGradient(Math.abs(cll), afterHLRange.min, afterHLRange.max);
                afterHLRow = `<div class="after-metrics-grid"><div class="after-high" style="background:${hhcGradient}">${hhc >= 0 ? '+' : ''}${hhc}</div><div class="after-low" style="background:${cllGradient}">${cll >= 0 ? '+' : ''}${cll}</div></div>`;
              }
            }
            bd += `<td class="min-cell${borderCls}" style="min-height:56px;${rVolHighlight}">
              <div class="min-grid" style="grid-template-rows:1fr 1fr 1fr 1fr${showAfterHL !== 'off' ? ' auto' : ''};">
                <div class="min-grid-top left" style="background:${getOrangeGradient(ur, mStats.urlr.min, mStats.urlr.max)};${urBorder}">${ur}<span class="min-lvl">(${lvlUp})</span></div>
                <div class="min-grid-top" style="background:${getOrangeGradient(lr, mStats.urlr.min, mStats.urlr.max)};${lrBorder}">${lr}<span class="min-lvl">(${lvlDn})</span></div>
                <div class="min-grid-bottom ${oc >= 0 ? 'up' : 'down'}" style="background:${getRGGradient(oc, mStats.oc.min, mStats.oc.max)};border-bottom:1px solid var(--border-medium);${ocBorder}">${oc >= 0 ? '+' : ''}${oc}<span class="min-lvl">(${lvlCl >= 0 ? '+' : ''}${lvlCl})</span><span class="info-btn" data-date="${date}" data-hour="${h}" data-minute="${m}"></span></div>
                <div class="min-grid-row4${row4BorderCls}" style="grid-column:1/3;background:${hrOCGradient};">
                  <span class="hr-oc ${hrOC >= 0 ? 'up' : 'down'}">${hrOC >= 0 ? '+' : ''}${hrOC}<span class="min-lvl">(${hrLvl >= 0 ? '+' : ''}${hrLvl})</span></span>
                  <span class="bar-rsi" style="background:${rsiBg}">${rsiDisplay}</span>
                </div>
                ${afterHLRow}
              </div>
            </td>`;
          } else {
            bd += `<td class="min-cell${borderCls}" style="color:var(--text-muted)"></td>`;
          }
        });
        
        bd += '</tr>';
      });
      
      document.getElementById('day-table-body').innerHTML = bd;
      
      // Render second panel if in compare mode
      if (compareMode) {
        const date2 = document.getElementById('day-view-date2').value;
        if (date2 && barsByET[date2]) {
          renderDayViewPanel2(date2, lvl, hlFrom, hlTo);
        }
      }
    }
    
    function renderDayViewPanel2(date, lvl, hlFrom, hlTo) {
      const day = etDays[date];
      const bars = barsByET[date];
      if (!day || !bars) return;
      
      const hourBars = {};
      bars.forEach(b => {
        if (!hourBars[b.etHour]) hourBars[b.etHour] = {};
        hourBars[b.etHour][String(b.etMin).padStart(2, '0')] = b;
      });
      
      // Collect stats for gradients
      const hStats = { rng: [], urlr: [], oc: [], cdr: [] };
      const mStats = { urlr: [], oc: [] };
      
      realHours.forEach(h => {
        const hd = day.hrs[h];
        if (hd?.m) {
          hStats.rng.push(hd.m.rng);
          hStats.urlr.push(hd.m.ur, hd.m.lr);
          hStats.oc.push(hd.m.oc);
          hStats.cdr.push(hd.m.cdr);
        }
        MINS.forEach(m => {
          const bar = hourBars[h]?.[m];
          if (bar) {
            mStats.urlr.push(Math.round(bar.high - bar.open), Math.round(bar.open - bar.low));
            mStats.oc.push(Math.round(bar.close - bar.open));
          }
        });
      });
      
      const calcStats = arr => arr.length ? { min: Math.min(...arr), max: Math.max(...arr) } : { min: 0, max: 0 };
      Object.keys(hStats).forEach(k => hStats[k] = calcStats(hStats[k]));
      Object.keys(mStats).forEach(k => mStats[k] = calcStats(mStats[k]));
      
      let hd = `<tr><th rowspan="2" class="hour-cell">Hour</th><th colspan="7" class="group-header">Range</th><th colspan="${MINS.length}" class="group-header">5-Min Bars</th></tr>`;
      hd += '<tr><th class="group-border">Rng</th><th>UR</th><th>LR</th><th>#Up</th><th>#Dn</th><th>#Cl</th><th>O-C</th>';
      MINS.forEach((m, i) => { hd += `<th class="${i === 0 ? 'group-border' : ''}">:${m}</th>`; });
      hd += '</tr>';
      document.getElementById('day-table-head-2').innerHTML = hd;
      
      let bd = '';
      realHours.forEach(h => {
        const hdata = day.hrs[h];
        const hm = hdata?.m;
        const isHL = h >= hlFrom && h <= hlTo;
        bd += `<tr class="${isHL ? 'highlight-row' : ''}">`;
        bd += `<td class="hour-cell">${formatHourHeader(h)}</td>`;
        
        if (hm) {
          bd += `<td class="group-border" style="background:${getOrangeGradient(hm.rng, hStats.rng.min, hStats.rng.max)}">${hm.rng}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.ur, hStats.urlr.min, hStats.urlr.max)}">${hm.ur}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.lr, hStats.urlr.min, hStats.urlr.max)}">${hm.lr}</td>`;
          bd += `<td style="color:${hm.up > 0 ? '#a7f3d0' : ''}">${hm.up}</td>`;
          bd += `<td style="color:${hm.dn > 0 ? '#fecaca' : ''}">${hm.dn}</td>`;
          bd += `<td style="color:${hm.cl > 0 ? '#a7f3d0' : hm.cl < 0 ? '#fecaca' : ''}">${hm.cl > 0 ? '+' + hm.cl : hm.cl}</td>`;
          bd += `<td class="${hm.oc >= 0 ? 'up' : 'down'}" style="background:${getRGGradient(hm.oc, hStats.oc.min, hStats.oc.max)}">${hm.oc >= 0 ? '+' : ''}${hm.oc}</td>`;
        } else {
          bd += `<td colspan="7" class="group-border" style="color:var(--text-muted)">No data</td>`;
        }
        
        MINS.forEach((m, mi) => {
          const bar = hourBars[h]?.[m];
          const borderCls = mi === 0 ? ' group-border' : '';
          if (bar && hdata) {
            const ur = Math.round(bar.high - bar.open);
            const lr = Math.round(bar.open - bar.low);
            const oc = Math.round(bar.close - bar.open);
            const lvlUp = Math.max(0, Math.floor(bar.high / lvl) - Math.floor(bar.open / lvl));
            const lvlDn = Math.max(0, Math.floor(bar.open / lvl) - Math.floor(bar.low / lvl));
            const lvlCl = Math.floor(bar.close / lvl) - Math.floor(bar.open / lvl);
            const hrOC = Math.round(bar.close - hdata.o);
            const hrLvl = Math.floor(bar.close / lvl) - Math.floor(hdata.o / lvl);
            const barRsi = bar.rsi != null ? Math.round(bar.rsi) : null;
            
            bd += `<td class="min-cell${borderCls}" style="min-height:60px;">
              <div class="min-grid" style="grid-template-rows:1fr 1fr 1fr 1fr;">
                <div class="min-grid-top left" style="background:${getOrangeGradient(ur, mStats.urlr.min, mStats.urlr.max)}">${ur}<span class="min-lvl">(${lvlUp})</span></div>
                <div class="min-grid-top" style="background:${getOrangeGradient(lr, mStats.urlr.min, mStats.urlr.max)}">${lr}<span class="min-lvl">(${lvlDn})</span></div>
                <div class="min-grid-bottom ${oc >= 0 ? 'up' : 'down'}" style="background:${getRGGradient(oc, mStats.oc.min, mStats.oc.max)};border-bottom:1px solid var(--border-medium);">${oc >= 0 ? '+' : ''}${oc}<span class="min-lvl">(${lvlCl >= 0 ? '+' : ''}${lvlCl})</span></div>
                <div class="min-grid-row4" style="grid-column:1/3;">
                  <span class="hr-oc ${hrOC >= 0 ? 'up' : 'down'}">${hrOC >= 0 ? '+' : ''}${hrOC}<span class="min-lvl">(${hrLvl >= 0 ? '+' : ''}${hrLvl})</span></span>
                  <span class="bar-rsi" style="background:${getRSIGradient(barRsi)}">${barRsi ?? ''}</span>
                </div>
              </div>
            </td>`;
          } else {
            bd += `<td class="min-cell${borderCls}" style="color:var(--text-muted)"></td>`;
          }
        });
        bd += '</tr>';
      });
      
      document.getElementById('day-table-body-2').innerHTML = bd;
    }
    
    // ==================== CALENDAR VIEW ====================
    function populateCalendarYearSelect() {
      calSelectedYears = new Set(availableYears);
      const container = document.getElementById('calendar-year-btns');
      container.innerHTML = availableYears.map(y => 
        `<button class="f-btn active" data-cal-year="${y}" onclick="toggleCalYear('${y}')">${y}</button>`
      ).join('');
    }
    
    function toggleCalYear(y) {
      calSelectedYears.has(y) ? calSelectedYears.delete(y) : calSelectedYears.add(y);
      document.querySelector(`[data-cal-year="${y}"]`).classList.toggle('active');
      renderCalendar();
    }
    
    function populateHourViewSelect() {
      const sel = document.getElementById('hour-view-hour');
      sel.innerHTML = HOURS.map(h => {
        const ampm = h >= 12 ? 'PM' : 'AM';
        const disp = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return `<option value="${h}" ${h === 9 ? 'selected' : ''}>${disp}${ampm}</option>`;
      }).join('');
    }
    
    function toggleHVDay(d) {
      hvSelectedDays.has(d) ? hvSelectedDays.delete(d) : hvSelectedDays.add(d);
      document.querySelector(`[data-hv-day="${d}"]`).classList.toggle('active');
      // Clear synced dates when manually changing filters
      window.hvUseSyncedDates = false;
      renderHourView();
    }
    
    function setHVWeekdays() {
      hvSelectedDays = new Set([1,2,3,4,5]);
      document.querySelectorAll('[data-hv-day]').forEach(b => b.classList.toggle('active', hvSelectedDays.has(+b.dataset.hvDay)));
      // Clear synced dates when manually changing filters
      window.hvUseSyncedDates = false;
      renderHourView();
    }
    
    function syncHVFromOverview() {
      // Sync the day of week filter
      hvSelectedDays = new Set(selectedDays);
      document.querySelectorAll('[data-hv-day]').forEach(b => b.classList.toggle('active', hvSelectedDays.has(+b.dataset.hvDay)));
      
      // Also store the actual filtered dates from overview to use in hour view filtering
      // This handles complex filters like specific dates, months, occurrences, column filters, etc.
      const overviewData = getFilteredData();
      window.hvSyncedDates = new Set(overviewData.map(d => d.date));
      window.hvUseSyncedDates = true;
      
      renderHourView();
    }
    
    function renderHourView() {
      const hour = parseInt(document.getElementById('hour-view-hour').value);
      const lvl = parseInt(document.getElementById('hour-level-size').value) || 250;
      hvSelectedHour = hour;
      
      document.getElementById('hour-view-title').textContent = `${formatHourHeader(hour)} Hour Analysis`;
      
      // Get filtered days that have this hour
      const filteredDays = Object.values(etDays).filter(d => {
        // If using synced dates from overview, use those exact dates
        if (window.hvUseSyncedDates && window.hvSyncedDates) {
          return window.hvSyncedDates.has(d.date) && d.hrs[hour] != null;
        }
        // Otherwise use the day-of-week filter along with year/month filters
        if (!hvSelectedDays.has(d.dow)) return false;
        if (!selectedYears.has(d.date.slice(0,4))) return false;
        if (!selectedMonths.has(d.month)) return false;
        return d.hrs[hour] != null;
      }).sort((a, b) => b.date.localeCompare(a.date));
      
      // Calculate stats
      const hourStats = { rng: [], urlr: [], oc: [], cdr: [], ddrev: [] };
      const minStats = { ur: [], lr: [], oc: [] };
      
      // Pre-calculate hourly DD/Rev for each day
      const dayHourlyDDRev = {};
      
      filteredDays.forEach(day => {
        const hd = day.hrs[hour];
        if (hd?.m) {
          hourStats.rng.push(hd.m.rng);
          hourStats.urlr.push(hd.m.ur, hd.m.lr);
          hourStats.oc.push(hd.m.oc);
          hourStats.cdr.push(hd.m.cdr);
        }
        const bars = barsByET[day.date];
        const hourBars = {};
        if (bars) {
          bars.filter(b => b.etHour === hour).forEach(bar => {
            hourBars[String(bar.etMin).padStart(2, '0')] = bar;
            minStats.ur.push(Math.round(bar.high - bar.open));
            minStats.lr.push(Math.round(bar.open - bar.low));
            minStats.oc.push(Math.round(bar.close - bar.open));
          });
        }
        
        // Calculate hourly drawdown and reversal for this day's hour
        if (hd) {
          let postHiLow = Infinity;
          let foundHi = false;
          MINS.forEach(m => {
            const bar = hourBars[m];
            if (bar) {
              if (bar.high >= hd.h - 0.01) foundHi = true;
              if (foundHi) postHiLow = Math.min(postHiLow, bar.low);
            }
          });
          const hDD = foundHi && postHiLow < Infinity ? Math.round(hd.h - postHiLow) : null;
          
          let postLoHigh = -Infinity;
          let foundLo = false;
          MINS.forEach(m => {
            const bar = hourBars[m];
            if (bar) {
              if (bar.low <= hd.l + 0.01) foundLo = true;
              if (foundLo) postLoHigh = Math.max(postLoHigh, bar.high);
            }
          });
          const hRev = foundLo && postLoHigh > -Infinity ? Math.round(postLoHigh - hd.l) : null;
          
          dayHourlyDDRev[day.date] = { hDD, hRev };
          if (hDD != null) hourStats.ddrev.push(hDD);
          if (hRev != null) hourStats.ddrev.push(hRev);
        }
      });
      
      const hStats = {
        rng: hourStats.rng.length ? { min: Math.min(...hourStats.rng), max: Math.max(...hourStats.rng) } : { min: 0, max: 100 },
        urlr: hourStats.urlr.length ? { min: Math.min(...hourStats.urlr), max: Math.max(...hourStats.urlr) } : { min: 0, max: 100 },
        oc: hourStats.oc.length ? { min: Math.min(...hourStats.oc), max: Math.max(...hourStats.oc) } : { min: 0, max: 100 },
        cdr: hourStats.cdr.length ? { min: Math.min(...hourStats.cdr), max: Math.max(...hourStats.cdr) } : { min: 0, max: 100 },
        ddrev: hourStats.ddrev.length ? { min: Math.min(...hourStats.ddrev), max: Math.max(...hourStats.ddrev) } : { min: 0, max: 100 },
      };
      const mStats = {
        urlr: minStats.ur.length ? { min: Math.min(...minStats.ur, ...minStats.lr), max: Math.max(...minStats.ur, ...minStats.lr) } : { min: 0, max: 100 },
        oc: minStats.oc.length ? { min: Math.min(...minStats.oc), max: Math.max(...minStats.oc) } : { min: 0, max: 100 },
      };

      // Calculate after high/low stats for gradients (excluding :55 bars) - Hour View
      const afterHLStats = { hh: [], hl: [] };
      if (showAfterHL) {
        filteredDays.forEach(day => {
          const bars = barsByET[day.date];
          if (!bars) return;
          bars.filter(b => b.etHour === hour).forEach(bar => {
            const m = String(bar.etMin).padStart(2, '0');
            if (m === '55') return; // Exclude :55 bars
            if (bar.hhAfterClose != null) afterHLStats.hh.push(bar.hhAfterClose);
            if (bar.hlAfterClose != null) afterHLStats.hl.push(bar.hlAfterClose);
          });
        });
      }
      const afterHLRange = afterHLStats.hh.length && afterHLStats.hl.length ? {
        min: Math.min(...afterHLStats.hh, ...afterHLStats.hl),
        max: Math.max(...afterHLStats.hh, ...afterHLStats.hl)
      } : { min: 0, max: 100 };

      // Stats summary
      const avgRng = hourStats.rng.length ? Math.round(hourStats.rng.reduce((a,b) => a+b, 0) / hourStats.rng.length) : 0;
      const avgOC = hourStats.oc.length ? Math.round(hourStats.oc.reduce((a,b) => a+b, 0) / hourStats.oc.length) : 0;
      
      document.getElementById('hour-stats-grid').innerHTML = `
        <div class="day-stat-box"><div class="day-stat-val">${filteredDays.length}</div><div class="day-stat-lbl">Days</div></div>
        <div class="day-stat-box"><div class="day-stat-val">${avgRng.toLocaleString()}</div><div class="day-stat-lbl">Avg Range</div></div>
        <div class="day-stat-box"><div class="day-stat-val ${avgOC >= 0 ? 'positive' : 'negative'}">${avgOC >= 0 ? '+' : ''}${avgOC.toLocaleString()}</div><div class="day-stat-lbl">Avg O-C</div></div>
        <div class="day-stat-box"><div class="day-stat-val">${hStats.rng.max.toLocaleString()}</div><div class="day-stat-lbl">Max Range</div></div>
      `;
      
      // Build header
      let headerHTML = '<tr>';
      headerHTML += '<th rowspan="2" class="hour-cell" style="min-width:70px;background:#1a1a24 !important">Date</th>';
      headerHTML += '<th rowspan="2" class="hour-cell" style="min-width:35px;background:#1a1a24 !important">Day</th>';
      headerHTML += '<th colspan="11" class="group-header">Range &amp; Levels</th>';
      headerHTML += '<th colspan="4" class="group-header ohlc-header">OHLC</th>';
      headerHTML += '<th colspan="5" class="group-header cum-header">Cumulative</th>';
      headerHTML += `<th colspan="${MINS.length}" class="group-header section-header">5-Min Bars</th>`;
      headerHTML += '</tr><tr>';
      headerHTML += '<th class="group-border">Rng</th><th>UR</th><th>LR</th><th>#Up</th><th>#Dn</th><th>#Cl</th><th>HMin</th><th>LMin</th><th>O-C</th><th>HDD</th><th>HRev</th>';
      headerHTML += '<th class="group-border">Open</th><th>High</th><th>Low</th><th>Close</th>';
      headerHTML += '<th class="group-border">CDR</th><th>CURng</th><th>CDUp</th><th>CDDn</th><th>#Grn</th>';
      MINS.forEach((m, i) => { headerHTML += `<th class="${i === 0 ? 'group-border section-header' : 'section-header'}">:${m}</th>`; });
      headerHTML += '</tr>';
      document.getElementById('hour-table-head').innerHTML = headerHTML;
      
      // Build body
      let bd = '';
      filteredDays.forEach(day => {
        const hourData = day.hrs[hour];
        const hm = hourData?.m;
        const bars = barsByET[day.date];
        const hourBars = {};
        if (bars) bars.filter(b => b.etHour === hour).forEach(b => hourBars[String(b.etMin).padStart(2, '0')] = b);
        const ddrev = dayHourlyDDRev[day.date] || {};
        
        // Check if this hour made a new day high/low
        let madeNewDayHigh = false, madeNewDayLow = false;
        if (hourData) {
          let runH = -Infinity, runL = Infinity;
          for (let h = 0; h < hour; h++) {
            if (day.hrs[h]) {
              runH = Math.max(runH, day.hrs[h].h);
              runL = Math.min(runL, day.hrs[h].l);
            }
          }
          madeNewDayHigh = hourData.h > runH;
          madeNewDayLow = hourData.l < runL;
        }
        
        bd += `<tr>`;
        bd += `<td class="hour-cell" style="text-align:left">${day.date}</td>`;
        bd += `<td class="hour-cell">${DAYS_SHORT[day.dow]}</td>`;
        
        if (hm) {
          bd += `<td class="group-border" style="background:${getOrangeGradient(hm.rng, hStats.rng.min, hStats.rng.max)}">${hm.rng}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.ur, hStats.urlr.min, hStats.urlr.max)}">${hm.ur}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.lr, hStats.urlr.min, hStats.urlr.max)}">${hm.lr}</td>`;
          bd += `<td style="color:${hm.up > 0 ? '#a7f3d0' : ''}">${hm.up}</td>`;
          bd += `<td style="color:${hm.dn > 0 ? '#fecaca' : ''}">${hm.dn}</td>`;
          bd += `<td style="color:${hm.cl > 0 ? '#a7f3d0' : hm.cl < 0 ? '#fecaca' : ''}">${hm.cl > 0 ? '+' + hm.cl : hm.cl}</td>`;
          bd += `<td>:${String(hm.hm).padStart(2,'0')}</td>`;
          bd += `<td>:${String(hm.lm).padStart(2,'0')}</td>`;
          bd += `<td class="${hm.oc >= 0 ? 'up' : 'down'}" style="background:${getRGGradient(hm.oc, hStats.oc.min, hStats.oc.max)}">${hm.oc >= 0 ? '+' : ''}${hm.oc}</td>`;
          bd += `<td style="background:${ddrev.hDD != null ? getOrangeGradient(ddrev.hDD, hStats.ddrev.min, hStats.ddrev.max) : ''}">${ddrev.hDD ?? ''}</td>`;
          bd += `<td style="background:${ddrev.hRev != null ? getOrangeGradient(ddrev.hRev, hStats.ddrev.min, hStats.ddrev.max) : ''}">${ddrev.hRev ?? ''}</td>`;
          // OHLC with green/red borders for new day high/low
          const highBorder = madeNewDayHigh ? 'border:2px solid #4ade80;' : '';
          const lowBorder = madeNewDayLow ? 'border:2px solid #f87171;' : '';
          bd += `<td class="group-border">${hm.o.toLocaleString()}</td>`;
          bd += `<td style="${highBorder}">${hm.hi.toLocaleString()}</td>`;
          bd += `<td style="${lowBorder}">${hm.lo.toLocaleString()}</td>`;
          bd += `<td>${hm.c.toLocaleString()}</td>`;
          bd += `<td class="group-border ${hm.cdr >= 0 ? 'up' : 'down'}" style="background:${getRGGradient(hm.cdr, hStats.cdr.min, hStats.cdr.max)}">${hm.cdr >= 0 ? '+' : ''}${hm.cdr}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.mxcdActual, 0, hStats.urlr.max)}">${hm.mxcdActual ?? ''}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.cdrUActual, 0, hStats.urlr.max)}">${hm.cdrUActual ?? ''}</td>`;
          bd += `<td style="background:${getOrangeGradient(hm.cdrDActual, 0, hStats.urlr.max)}">${hm.cdrDActual ?? ''}</td>`;
          bd += `<td style="background:${getGreenBarGradient(hm.greenBars)}">${hm.greenBars}</td>`;
        } else {
          bd += `<td colspan="20" class="group-border" style="color:var(--text-muted)">No data</td>`;
        }
        
        // Calculate running O-C for each minute
        let runningOC = 0;
        const minOCs = {};
        MINS.forEach(m => {
          const bar = hourBars[m];
          if (bar && hourData) {
            runningOC = Math.round(bar.close - hourData.o);
            minOCs[m] = { oc: runningOC, lvl: Math.floor(bar.close / lvl) - Math.floor(hourData.o / lvl) };
          }
        });
        
        // Calculate which minutes made new highs/lows for this hour
        const hlMins = { highMins: new Set(), lowMins: new Set() };
        let runningHigh = -Infinity;
        let runningLow = Infinity;
        MINS.forEach(m => {
          const bar = hourBars[m];
          if (bar) {
            if (bar.high > runningHigh) {
              runningHigh = bar.high;
              hlMins.highMins.add(m);
            }
            if (bar.low < runningLow) {
              runningLow = bar.low;
              hlMins.lowMins.add(m);
            }
          }
        });
        // Remove :00 if later bars also made new high/low
        if (hlMins.highMins.size > 1 && hlMins.highMins.has('00')) hlMins.highMins.delete('00');
        if (hlMins.lowMins.size > 1 && hlMins.lowMins.has('00')) hlMins.lowMins.delete('00');
        
        MINS.forEach((m, mi) => {
          const bar = hourBars[m];
          const borderCls = mi === 0 ? ' group-border' : '';
          if (bar && hourData) {
            const ur = Math.round(bar.high - bar.open);
            const lr = Math.round(bar.open - bar.low);
            const oc = Math.round(bar.close - bar.open);
            const lvlUp = Math.max(0, Math.floor(bar.high / lvl) - Math.floor(bar.open / lvl));
            const lvlDn = Math.max(0, Math.floor(bar.open / lvl) - Math.floor(bar.low / lvl));
            const lvlCl = Math.floor(bar.close / lvl) - Math.floor(bar.open / lvl);
            const hrOC = minOCs[m] || { oc: 0, lvl: 0 };
            
            // Check if this minute made a new high or low for the hour
            const madeNewHigh = hlMins.highMins.has(m);
            const madeNewLow = hlMins.lowMins.has(m);
            const urBorder = madeNewHigh ? 'border:2px solid #4ade80;' : '';
            const lrBorder = madeNewLow ? 'border:2px solid #f87171;' : '';
            
            const barRsi = bar.rsi != null ? Math.round(bar.rsi) : null;
            const rsiDisplay = barRsi != null ? barRsi : '';
            const rsiBg = getRSIGradient(barRsi);
            
            // RSI OB/OS border - now on entire row4, purple for OB, orange for OS
            let row4BorderCls = '';
            if (barRsi != null && barRsi >= obLevel) row4BorderCls = ' rsi-ob-border';
            else if (barRsi != null && barRsi <= osLevel) row4BorderCls = ' rsi-os-border';
            
            // Gradient for row4 based on hrOC value
            const hrOCGradient = getRGGradient(hrOC.oc, hStats.oc.min, hStats.oc.max);

            // Check for high relative volume
            const rVolHighlight = bar.rVol != null && bar.rVol >= rVolThreshold ? 'box-shadow: inset 0 0 0 4px rgba(255, 255, 255, 0.9); z-index: 10; position: relative;' : '';

            // Build tooltip info
            const barRng = Math.round(bar.high - bar.low);
            const tooltipText = `O: ${Math.round(bar.open).toLocaleString()}\\nH: ${Math.round(bar.high).toLocaleString()}\\nL: ${Math.round(bar.low).toLocaleString()}\\nC: ${Math.round(bar.close).toLocaleString()}\\nRng: ${barRng}\\nUR: ${ur} / LR: ${lr}`;

            // After High/Low with 2-column grid and gradient coloring - Hour View
            let afterHLRow = '';
            if (showAfterHL !== 'off') {
              if (m === '55') {
                // Show blank for :55 bars (no bar after them)
                afterHLRow = '<div class="after-metrics-grid"><div class="after-high"></div><div class="after-low"></div></div>';
              } else if (showAfterHL === 'afterhl') {
                const hhGradient = bar.hhAfterClose != null ? getOrangeGradient(bar.hhAfterClose, afterHLRange.min, afterHLRange.max) : 'transparent';
                const hlGradient = bar.hlAfterClose != null ? getOrangeGradient(bar.hlAfterClose, afterHLRange.min, afterHLRange.max) : 'transparent';
                afterHLRow = `<div class="after-metrics-grid"><div class="after-high" style="background:${hhGradient}">+${bar.hhAfterClose ?? 0}</div><div class="after-low" style="background:${hlGradient}">${bar.hlAfterClose >= 0 ? '+' : ''}${bar.hlAfterClose ?? 0}</div></div>`;
              } else if (showAfterHL === 'hhcll') {
                const hourData = day.hrs[h];
                const hhc = Math.round(hourData.h - bar.close);
                const cll = Math.round(bar.close - hourData.l);
                const hhcGradient = getOrangeGradient(Math.abs(hhc), afterHLRange.min, afterHLRange.max);
                const cllGradient = getOrangeGradient(Math.abs(cll), afterHLRange.min, afterHLRange.max);
                afterHLRow = `<div class="after-metrics-grid"><div class="after-high" style="background:${hhcGradient}">${hhc >= 0 ? '+' : ''}${hhc}</div><div class="after-low" style="background:${cllGradient}">${cll >= 0 ? '+' : ''}${cll}</div></div>`;
              }
            }
            bd += `<td class="min-cell${borderCls}" style="min-height:56px;${rVolHighlight}">
              <div class="min-grid" style="grid-template-rows:1fr 1fr 1fr 1fr${showAfterHL !== 'off' ? ' auto' : ''};">
                <div class="min-grid-top left" style="background:${getOrangeGradient(ur, mStats.urlr.min, mStats.urlr.max)};${urBorder}">${ur}<span class="min-lvl">(${lvlUp})</span></div>
                <div class="min-grid-top" style="background:${getOrangeGradient(lr, mStats.urlr.min, mStats.urlr.max)};${lrBorder}">${lr}<span class="min-lvl">(${lvlDn})</span></div>
                <div class="min-grid-bottom ${oc >= 0 ? 'up' : 'down'}" style="background:${getRGGradient(oc, mStats.oc.min, mStats.oc.max)};border-bottom:1px solid var(--border-medium);">${oc >= 0 ? '+' : ''}${oc}<span class="min-lvl">(${lvlCl >= 0 ? '+' : ''}${lvlCl})</span><span class="info-btn" data-date="${day.date}" data-hour="${hour}" data-minute="${m}"></span></div>
                <div class="min-grid-row4${row4BorderCls}" style="grid-column:1/3;background:${hrOCGradient};">
                  <span class="hr-oc ${hrOC.oc >= 0 ? 'up' : 'down'}">${hrOC.oc >= 0 ? '+' : ''}${hrOC.oc}<span class="min-lvl">(${hrOC.lvl >= 0 ? '+' : ''}${hrOC.lvl})</span></span>
                  <span class="bar-rsi" style="background:${rsiBg}">${rsiDisplay}</span>
                </div>
                ${afterHLRow}
              </div>
            </td>`;
          } else {
            bd += `<td class="min-cell${borderCls}" style="color:var(--text-muted)"></td>`;
          }
        });
        
        bd += '</tr>';
      });
      
      document.getElementById('hour-table-body').innerHTML = bd;
    }
    
    function renderCalendar() {
      const colorBy = document.getElementById('calendar-color-by').value;
      const calCloseHour = parseInt(document.getElementById('calendar-close-hour').value) || 16;
      
      // Show/hide hour selector based on colorBy selection
      document.getElementById('cal-hour-group').style.display = colorBy === 'dMxToHr' ? 'flex' : 'none';
      
      // Helper to calculate max DUR/DLR to a specific hour
      function calcMaxToHour(dayData, toHour) {
        const dayOpen = dayData.dO;
        if (dayOpen == null) return null;
        
        let maxHigh = dayOpen;
        let minLow = dayOpen;
        
        for (let h = 0; h <= toHour; h++) {
          const hr = dayData.hrs[h];
          if (hr) {
            if (hr.h != null && hr.h > maxHigh) maxHigh = hr.h;
            if (hr.l != null && hr.l < minLow) minLow = hr.l;
          }
        }
        
        const dur = Math.round(maxHigh - dayOpen);
        const dlr = Math.round(dayOpen - minLow);
        return Math.max(dur, dlr);
      }
      
      const allVals = [];
      Object.values(etDays).forEach(d => {
        if (!calSelectedYears.has(d.date.slice(0,4))) return;
        if (!calColorDays.has(d.dow)) return;
        if (calColorDates && !calColorDates.has(d.date)) return;
        
        let v;
        if (colorBy === 'dMx') {
          v = d.dMx;
        } else if (colorBy === 'dMxToHr') {
          v = calcMaxToHour(d, calCloseHour);
        } else {
          v = d[colorBy];
        }
        if (v != null) allVals.push(v);
      });
      
      const stats = allVals.length ? { min: Math.min(...allVals), max: Math.max(...allVals) } : { min: 0, max: 0 };
      const years = availableYears.filter(y => calSelectedYears.has(y));
      
      // Get current date to filter out future months
      const today = new Date();
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth(); // 0-indexed
      
      let html = '';
      years.forEach(year => {
        html += `<div class="calendar-year"><div class="calendar-year-title">${year}</div><div class="calendar-months">`;
        
        for (let m = 0; m < 12; m++) {
          // Skip future months
          if (parseInt(year) > currentYear || (parseInt(year) === currentYear && m > currentMonth)) {
            continue;
          }
          
          // Check if this month has any data in the synced filter (if filter is set)
          if (calColorDates && calColorDates.size > 0) {
            const monthPrefix = `${year}-${String(m + 1).padStart(2, '0')}`;
            const hasDataInMonth = [...calColorDates].some(d => d.startsWith(monthPrefix));
            if (!hasDataInMonth) continue;
          }
          
          html += `<div class="calendar-month"><div class="calendar-month-title">${MONTHS_SHORT[m]}</div>`;
          html += '<div class="calendar-weekdays">';
          ['S','M','T','W','T','F','S'].forEach(d => html += `<div class="calendar-weekday">${d}</div>`);
          html += '</div><div class="calendar-days">';
          
          const firstDay = new Date(year, m, 1).getDay();
          const daysInMonth = new Date(year, m + 1, 0).getDate();
          
          for (let i = 0; i < firstDay; i++) html += '<div class="calendar-day empty"></div>';
          
          for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const dayData = etDays[dateStr];
            const dow = new Date(year, m, d).getDay();
            const isWeekend = dow === 0 || dow === 6;
            
            if (dayData) {
              let v;
              if (colorBy === 'dMx') {
                v = dayData.dMx;
              } else if (colorBy === 'dMxToHr') {
                v = calcMaxToHour(dayData, calCloseHour);
              } else {
                v = dayData[colorBy];
              }
              
              const shouldColor = calColorDays.has(dow) && (!calColorDates || calColorDates.has(dateStr));
              let bg = '#0d0d12';
              
              if (shouldColor && v != null) {
                bg = colorBy === 'dOC' ? getRGGradient(v, stats.min, stats.max) : getOrangeGradient(v, stats.min, stats.max);
              }
              
              const ocClass = dayData.dOC >= 0 ? 'positive' : 'negative';
              
              // Calculate max(DUR, DLR) to hour for display
              const maxToHr = calcMaxToHour(dayData, calCloseHour);
              const maxToHrDisplay = maxToHr != null ? maxToHr.toLocaleString() : '';
              
              const maxURLR = Math.max(dayData.dUR || 0, dayData.dLR || 0);
              
              // Weekly O-C
              const wocDisplay = dayData.wOC != null ? ((dayData.wOC >= 0 ? '+' : '') + dayData.wOC.toLocaleString()) : '';
              const wocClass = dayData.wOC >= 0 ? 'positive' : 'negative';
              
              html += `<div class="calendar-day${isWeekend ? ' weekend' : ''}${shouldColor ? '' : ' no-color'}" style="background:${bg}" onclick="goToDate('${dateStr}')">
                <div class="day-header"><span class="day-num">${d}</span><span class="day-close">${dayData.dC ? Math.round(dayData.dC).toLocaleString() : ''}</span></div>
                <div class="day-rng" style="color:var(--text-secondary)">Rng: ${dayData.dRng?.toLocaleString() ?? ''}</div>
                <div class="day-urlr"><span class="day-ur">${dayData.dUR?.toLocaleString() ?? ''}</span><span class="day-lr">${dayData.dLR?.toLocaleString() ?? ''}</span></div>
                <div class="day-mx" style="font-size:0.5rem;text-align:center;color:var(--accent-btc);">To${calCloseHour > 12 ? calCloseHour - 12 : calCloseHour}${calCloseHour >= 12 ? 'P' : 'A'}: ${maxToHrDisplay}</div>
                <div class="day-oc ${ocClass}">${dayData.dOC != null ? ((dayData.dOC >= 0 ? '+' : '') + dayData.dOC.toLocaleString()) : ''}</div>
                <div class="day-woc ${wocClass}" style="font-size:0.45rem;color:var(--accent-purple);">W: ${wocDisplay}</div>
              </div>`;
            } else {
              html += `<div class="calendar-day empty${isWeekend ? ' weekend' : ''}"><span class="day-num" style="color:var(--text-muted)">${d}</span></div>`;
            }
          }
          
          html += '</div></div>';
        }
        
        html += '</div></div>';
      });
      
      document.getElementById('calendar-container').innerHTML = html;
    }
    
    function toggleCalDay(d) {
      calColorDays.has(d) ? calColorDays.delete(d) : calColorDays.add(d);
      document.querySelector(`[data-cal-day="${d}"]`).classList.toggle('active');
      renderCalendar();
    }
    
    function resetCalDays() {
      calColorDays = new Set([0,1,2,3,4,5,6]);
      calColorDates = null;
      document.querySelectorAll('[data-cal-day]').forEach(b => b.classList.add('active'));
      renderCalendar();
    }
    
    function syncCalFromOverview() {
      calColorDays = new Set(selectedDays);
      document.querySelectorAll('[data-cal-day]').forEach(b => b.classList.toggle('active', calColorDays.has(+b.dataset.calDay)));
      
      if (useDateFilter && selectedDates.size > 0) {
        calColorDates = new Set(selectedDates);
      } else {
        calColorDates = new Set();
        Object.values(etDays).forEach(d => {
          if (selectedYears.has(d.date.slice(0,4)) && selectedMonths.has(d.month) && selectedDays.has(d.dow) && selectedOccs.has(d.occ)) {
            calColorDates.add(d.date);
          }
        });
      }
      
      renderCalendar();
    }
    
    function goToDate(dateStr) {
      document.getElementById('day-view-date').value = dateStr;
      switchTab('dayview');
    }
    
    // ==================== 5PM SESSION ====================
    function initPm5YearFilters() {
      pm5SelectedYears = new Set(availableYears);
      document.getElementById('pm5-year-filters').innerHTML = availableYears.map(y => 
        `<button class="f-btn active" data-pm5-year="${y}" onclick="togglePm5Year('${y}')">${y}</button>`
      ).join('');
    }
    
    function togglePm5Year(y) {
      pm5SelectedYears.has(y) ? pm5SelectedYears.delete(y) : pm5SelectedYears.add(y);
      document.querySelector(`[data-pm5-year="${y}"]`).classList.toggle('active');
      render5pmSession();
    }
    
    function togglePm5Day(d) {
      pm5SelectedDays.has(d) ? pm5SelectedDays.delete(d) : pm5SelectedDays.add(d);
      document.querySelector(`[data-pm5-day="${d}"]`).classList.toggle('active');
      render5pmSession();
    }
    
    function setPm5NoDays() {
      pm5SelectedDays.clear();
      document.querySelectorAll('[data-pm5-day]').forEach(b => b.classList.remove('active'));
      render5pmSession();
    }
    
    function setPm5Weekdays() {
      pm5SelectedDays = new Set([1,2,3,4,5]);
      document.querySelectorAll('[data-pm5-day]').forEach(b => b.classList.toggle('active', pm5SelectedDays.has(+b.dataset.pm5Day)));
      render5pmSession();
    }
    
    function togglePm5Filters() {
      document.getElementById('pm5-filters-panel').style.display =
        document.getElementById('pm5-filters-panel').style.display === 'none' ? 'flex' : 'none';
      document.getElementById('btn-pm5-filters').classList.toggle('active');
    }

    function togglePm5Columns() {
      document.getElementById('pm5-columns-panel').style.display =
        document.getElementById('pm5-columns-panel').style.display === 'none' ? 'block' : 'none';
      document.getElementById('btn-pm5-columns').classList.toggle('active');
    }

    function togglePm5Column(id) {
      pm5VisibleColumns.has(id) ? pm5VisibleColumns.delete(id) : pm5VisibleColumns.add(id);
      render5pmSession();
    }

    function setPm5DefaultCols() {
      pm5VisibleColumns = new Set(['rng', 'ur', 'lr', 'oc']);
      document.querySelectorAll('#pm5-col-grid input').forEach((cb, i) => {
        cb.checked = pm5VisibleColumns.has(ALL_COLUMNS[i].id);
      });
      render5pmSession();
    }

    function setPm5AllCols() {
      pm5VisibleColumns = new Set(ALL_COLUMNS.map(c => c.id));
      document.querySelectorAll('#pm5-col-grid input').forEach(cb => cb.checked = true);
      render5pmSession();
    }

    function setPm5RangeCols() {
      pm5VisibleColumns = new Set(['rng', 'ur', 'lr', 'mxr']);
      document.querySelectorAll('#pm5-col-grid input').forEach((cb, i) => {
        cb.checked = pm5VisibleColumns.has(ALL_COLUMNS[i].id);
      });
      render5pmSession();
    }

    function setPm5OHLCVCols() {
      pm5VisibleColumns = new Set(['o', 'hi', 'lo', 'c', 'v']);
      document.querySelectorAll('#pm5-col-grid input').forEach((cb, i) => {
        cb.checked = pm5VisibleColumns.has(ALL_COLUMNS[i].id);
      });
      render5pmSession();
    }

    function syncPm5FromOverview() {
      // Copy overview-selected filters to 5PM session view (years, days, months, occs, selectedDates)
      pm5SelectedYears = new Set(selectedYears);
      pm5SelectedDays = new Set(selectedDays);
      pm5SelectedMonths = new Set(selectedMonths);
      pm5SelectedOccs = new Set(selectedOccs);
      pm5UseDateFilter = !!useDateFilter;
      pm5SelectedDates = new Set(selectedDates);
      // Update UI active classes for elements that exist in PM5 tab
      document.querySelectorAll('[data-pm5-year]').forEach(b => {
        const isActive = pm5SelectedYears.has(b.dataset.pm5Year);
        b.classList.toggle('active', isActive);
      });
      document.querySelectorAll('[data-pm5-day]').forEach(b => {
        const isActive = pm5SelectedDays.has(+b.dataset.pm5Day);
        b.classList.toggle('active', isActive);
      });
      render5pmSession();
    }

    function syncOverviewFromPm5() {
      // Copy 5PM session filters back to overview
      selectedYears = new Set(pm5SelectedYears);
      selectedDays = new Set(pm5SelectedDays);
      selectedMonths = new Set(pm5SelectedMonths);
      selectedOccs = new Set(pm5SelectedOccs);
      useDateFilter = pm5UseDateFilter;
      selectedDates = new Set(pm5SelectedDates);
      // Update UI active classes in overview
      document.querySelectorAll('[data-year]').forEach(b => {
        const isActive = selectedYears.has(b.dataset.year);
        b.classList.toggle('active', isActive);
      });
      document.querySelectorAll('[data-day]').forEach(b => {
        const isActive = selectedDays.has(+b.dataset.day);
        b.classList.toggle('active', isActive);
      });
      document.querySelectorAll('[data-month]').forEach(b => {
        const isActive = selectedMonths.has(+b.dataset.month);
        b.classList.toggle('active', isActive);
      });
      document.querySelectorAll('[data-occ]').forEach(b => {
        const isActive = selectedOccs.has(+b.dataset.occ);
        b.classList.toggle('active', isActive);
      });
      updateDatePickerUI();
      renderTable();
    }
    
    function togglePm5Cumulative() {
      pm5ShowCumulative = !pm5ShowCumulative;
      document.getElementById('btn-pm5-cum').classList.toggle('active', pm5ShowCumulative);
      render5pmSession();
    }
    
    function getPm5FilteredData() {
      return Object.values(etDays).filter(d => {
        if (!pm5SelectedYears.has(d.date.slice(0,4))) return false;
        if (!pm5SelectedMonths.has(d.month)) return false;
        if (!pm5SelectedDays.has(d.dow)) return false;
        if (!pm5SelectedOccs.has(d.occ)) return false;
        if (pm5UseDateFilter && pm5SelectedDates.size > 0) {
          if (!pm5SelectedDates.has(d.date)) return false;
        }
        if (d.d5pmOpen == null) return false; // Must have 5PM session data
        return true;
      }).sort((a, b) => {
        if (pm5SortColumn === 'date') {
          return pm5SortDirection === 'asc' ? a.date.localeCompare(b.date) : b.date.localeCompare(a.date);
        }
        return 0;
      });
    }

    function render5pmSession() {
      const data = getPm5FilteredData();

      // Apply column filters
      const filteredData = applyColumnFilters(data);

      const lvl = parseInt(document.getElementById('pm5-level-size').value) || 250;
      const gMode = document.getElementById('pm5-gradient-mode').value;

      document.getElementById('pm5-stat-days').textContent = filteredData.length;

      // Hours in 5PM session order: 17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16
      const ALL_PM5_HOURS = [17,18,19,20,21,22,23,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16];

      // Apply hour filter (from overview tab)
      const PM5_HOURS = ALL_PM5_HOURS.filter(h => {
        // Convert to 0-23 range for comparison
        if (hourFrom <= hourTo) {
          return h >= hourFrom && h <= hourTo;
        } else {
          // Wrap-around case (e.g., from 22 to 2)
          return h >= hourFrom || h <= hourTo;
        }
      });

      document.getElementById('pm5-stat-hours').textContent = PM5_HOURS.length;
      
      // Calculate stats for gradients
      const stats5pm = { ur: [], lr: [], oc: [], rng: [], cum: [], cumRG: [] };
      filteredData.forEach(d => {
        if (d.d5pmUR != null) stats5pm.ur.push(d.d5pmUR);
        if (d.d5pmLR != null) stats5pm.lr.push(d.d5pmLR);
        if (d.d5pmOC != null) stats5pm.oc.push(d.d5pmOC);
        if (d.d5pmMx != null) stats5pm.rng.push(d.d5pmMx);
        // Add cumulative stats
        if (d.d5pmUR != null) stats5pm.cum.push(d.d5pmUR);
        if (d.d5pmLR != null) stats5pm.cum.push(d.d5pmLR);
        if (d.d5pmOC != null) stats5pm.cumRG.push(d.d5pmOC);
      });
      const pm5Stats = {
        urlr: stats5pm.ur.length ? { min: Math.min(...stats5pm.ur, ...stats5pm.lr), max: Math.max(...stats5pm.ur, ...stats5pm.lr) } : { min: 0, max: 1000 },
        oc: stats5pm.oc.length ? { min: Math.min(...stats5pm.oc), max: Math.max(...stats5pm.oc) } : { min: -500, max: 500 },
        rng: stats5pm.rng.length ? { min: Math.min(...stats5pm.rng), max: Math.max(...stats5pm.rng) } : { min: 0, max: 1000 },
        cum: stats5pm.cum.length ? { min: Math.min(...stats5pm.cum), max: Math.max(...stats5pm.cum) } : { min: 0, max: 2000 },
        cumRG: stats5pm.cumRG.length ? { min: Math.min(...stats5pm.cumRG), max: Math.max(...stats5pm.cumRG) } : { min: -1000, max: 1000 },
      };
      
      // Get active columns for PM5
      const pm5Cols = ALL_COLUMNS.filter(c => pm5VisibleColumns.has(c.id));
      const colsPerHour = pm5Cols.length + (pm5ShowCumulative ? 4 : 0);

      // Build header
      let hd = '<tr class="hour-row">';
      hd += `<th class="sticky-col sticky-header" style="left:0;min-width:65px" rowspan="2">Date</th>`;
      hd += `<th class="sticky-col sticky-header" style="left:65px;min-width:28px" rowspan="2">Day</th>`;
      hd += `<th class="sticky-col sticky-header day-totals-header" style="left:93px;background:rgba(139,92,246,0.15) !important" colspan="4">5PM Session Totals</th>`;
      PM5_HOURS.forEach((h, i) => {
        const isNextDay = h < 17;
        const style = isNextDay ? 'background:rgba(74,222,128,0.1);' : '';
        hd += `<th class="hour-header${i===0?' hour-border-left':''}" style="${style}" colspan="${colsPerHour}">${formatHourHeader(h)}${isNextDay ? '*' : ''}</th>`;
      });
      hd += '</tr><tr class="col-row">';
      // Day totals sub-headers
      hd += '<th class="sticky-col sticky-header-sub" style="left:93px;background:rgba(139,92,246,0.1) !important">5pUR</th>';
      hd += '<th class="sticky-col sticky-header-sub" style="left:131px;background:rgba(139,92,246,0.1) !important">5pLR</th>';
      hd += '<th class="sticky-col sticky-header-sub" style="left:169px;background:rgba(139,92,246,0.1) !important">5pMx</th>';
      hd += '<th class="sticky-col sticky-header-sub" style="left:207px;background:rgba(139,92,246,0.1) !important;border-right:2px solid rgba(139,92,246,0.3)">5pOC</th>';
      // Hour sub-headers (dynamic columns)
      PM5_HOURS.forEach((h, hi) => {
        pm5Cols.forEach((col, ci) => {
          hd += `<th class="col-header${ci===0 && hi===0?' hour-border-left':''}">${col.label}</th>`;
        });
        if (pm5ShowCumulative) {
          hd += '<th class="col-header" style="background:rgba(139,92,246,0.1)">5CU</th>';
          hd += '<th class="col-header" style="background:rgba(139,92,246,0.1)">5CD</th>';
          hd += '<th class="col-header" style="background:rgba(139,92,246,0.1)">5MxC</th>';
          hd += '<th class="col-header" style="background:rgba(139,92,246,0.1)">5CR</th>';
        }
      });
      hd += '</tr>';
      document.getElementById('pm5-table-head').innerHTML = hd;
      
      // Build body
      let bd = '';

      // Get current date/time for determining which hours are in the future
      const now = new Date();
      const currentDateStr = now.toISOString().split('T')[0];
      const currentHour = now.getHours();

      filteredData.forEach(day => {
        bd += '<tr>';

        // Determine what date to display for the 5PM session
        // If we're viewing the latest session and it's after 5PM, show tomorrow's date
        let displayDate = day.date;
        let displayDow = day.dow;
        if (day === filteredData[0] && day.date === currentDateStr && currentHour >= 17) {
          // After 5PM, this session represents tomorrow's trading day
          const tomorrow = new Date(now);
          tomorrow.setDate(tomorrow.getDate() + 1);
          displayDate = tomorrow.toISOString().split('T')[0];
          displayDow = tomorrow.getDay();
        }

        bd += `<td class="sticky-col date-cell" style="left:0;min-width:65px;cursor:pointer;" onclick="loadDateInDayView('${day.date}')" title="Click to view in Day View">${displayDate}</td>`;
        bd += `<td class="sticky-col day-cell" style="left:65px;min-width:28px">${DAYS_SHORT[displayDow]}</td>`;
        
        // 5PM session totals
        bd += `<td class="sticky-col day-total-cell" style="left:93px;background:${getOrangeGradient(day.d5pmUR, pm5Stats.urlr.min, pm5Stats.urlr.max)}">${day.d5pmUR?.toLocaleString() ?? ''}</td>`;
        bd += `<td class="sticky-col day-total-cell" style="left:131px;background:${getOrangeGradient(day.d5pmLR, pm5Stats.urlr.min, pm5Stats.urlr.max)}">${day.d5pmLR?.toLocaleString() ?? ''}</td>`;
        bd += `<td class="sticky-col day-total-cell" style="left:169px;background:${getOrangeGradient(day.d5pmMx, pm5Stats.rng.min, pm5Stats.rng.max)}">${day.d5pmMx?.toLocaleString() ?? ''}</td>`;
        const oc5cls = day.d5pmOC >= 0 ? 'up' : 'down';
        bd += `<td class="sticky-col day-total-cell ${oc5cls}" style="left:207px;background:${getRGGradient(day.d5pmOC, pm5Stats.oc.min, pm5Stats.oc.max)};border-right:2px solid rgba(139,92,246,0.3)">${day.d5pmOC != null ? ((day.d5pmOC >= 0 ? '+' : '') + day.d5pmOC.toLocaleString()) : ''}</td>`;
        
        // Get previous day for 5PM-11PM hours
        const prevDateIdx = allETDates.indexOf(day.date) + 1; // +1 because allETDates is reverse sorted
        const prevDate = prevDateIdx < allETDates.length ? allETDates[prevDateIdx] : null;
        const prevDay = prevDate ? etDays[prevDate] : null;

        // Determine if this is the most recent session and check for future hours
        const isLatestSession = day === filteredData[0];

        // Calculate cumulative metrics for each hour
        const pm5Open = day.d5pmOpen;
        let cumHigh = pm5Open, cumLow = pm5Open;

        // Hour data
        PM5_HOURS.forEach((h, hi) => {
          // Check if this hour is in the future (for the latest session only)
          let isFutureHour = false;
          if (isLatestSession && day.date === currentDateStr) {
            // If viewing today's session
            if (currentHour >= 17) {
              // Currently 5PM or later - we're IN this session
              // Hours 17 through currentHour have data, rest are future
              if (h >= 17) {
                isFutureHour = h > currentHour;
              } else {
                // Hours 0-16 are tomorrow and haven't happened yet
                isFutureHour = true;
              }
            } else {
              // Currently before 5PM - this session started yesterday at 5PM
              // Hours 0 through currentHour have data, rest are future
              if (h >= 17) {
                // These are from yesterday, they have data
                isFutureHour = false;
              } else {
                // These are today, check if they've happened
                isFutureHour = h > currentHour;
              }
            }
          }

          // For hours 17-23, use previous day's data
          // For hours 0-16, use current day's data
          const sourceDay = h >= 17 ? prevDay : day;
          const hourData = !isFutureHour ? sourceDay?.hrs[h] : null;
          const hm = hourData?.m;
          
          if (hm) {
            // Update cumulative high/low
            if (hourData) {
              cumHigh = Math.max(cumHigh, hourData.h);
              cumLow = Math.min(cumLow, hourData.l);
            }
            
            // Calculate cumulative values for this hour
            const cumUR = pm5Open ? Math.round(cumHigh - pm5Open) : null;
            const cumLR = pm5Open ? Math.round(pm5Open - cumLow) : null;
            const cumMx = cumUR != null && cumLR != null ? Math.max(cumUR, cumLR) : null;
            const cumRng = pm5Open && hourData ? Math.round(hourData.c - pm5Open) : null;

            // Render dynamic columns
            pm5Cols.forEach((col, ci) => {
              const v = hm[col.id];
              let bg = '#0d0d12';
              let cls = 'data-cell';
              if (ci === 0 && hi === 0) cls += ' hour-border-left';

              // Apply gradients based on column type
              if (col.gradient === 'orange' && pm5Stats.rng) bg = getOrangeGradient(v, pm5Stats.rng.min, pm5Stats.rng.max);
              else if (col.gradient === 'rg' && pm5Stats.oc) bg = getRGGradient(v, pm5Stats.oc.min, pm5Stats.oc.max);

              // Special styling for certain columns
              if (['oc','cdr'].includes(col.id)) cls += v > 0 ? ' up' : v < 0 ? ' down' : '';

              bd += `<td class="${cls}" style="background:${bg}">${fmt(v, col.id)}</td>`;
            });

            if (pm5ShowCumulative) {
              // Cumulative backgrounds
              const cumURBg = getOrangeGradient(cumUR, pm5Stats.cum.min, pm5Stats.cum.max);
              const cumLRBg = getOrangeGradient(cumLR, pm5Stats.cum.min, pm5Stats.cum.max);
              const cumMxBg = getOrangeGradient(cumMx, pm5Stats.cum.min, pm5Stats.cum.max);
              const cumRngBg = getRGGradient(cumRng, pm5Stats.cumRG.min, pm5Stats.cumRG.max);
              const cumRngCls = cumRng >= 0 ? 'up' : 'down';
              
              // Cumulative cells
              bd += `<td class="data-cell" style="background:${cumURBg}">${cumUR?.toLocaleString() ?? ''}</td>`;
              bd += `<td class="data-cell" style="background:${cumLRBg}">${cumLR?.toLocaleString() ?? ''}</td>`;
              bd += `<td class="data-cell" style="background:${cumMxBg}">${cumMx?.toLocaleString() ?? ''}</td>`;
              bd += `<td class="data-cell ${cumRngCls}" style="background:${cumRngBg}">${cumRng != null ? ((cumRng >= 0 ? '+' : '') + cumRng.toLocaleString()) : ''}</td>`;
            }
          } else {
            // No data for this hour - render empty cells
            pm5Cols.forEach((col, ci) => {
              const cls = ci === 0 && hi === 0 ? 'data-cell hour-border-left' : 'data-cell';
              bd += `<td class="${cls}" style="color:var(--text-muted)"></td>`;
            });
            if (pm5ShowCumulative) {
              bd += '<td class="data-cell" style="color:var(--text-muted)"></td>';
              bd += '<td class="data-cell" style="color:var(--text-muted)"></td>';
              bd += '<td class="data-cell" style="color:var(--text-muted)"></td>';
              bd += '<td class="data-cell" style="color:var(--text-muted)"></td>';
            }
          }
        });
        
        bd += '</tr>';
      });
      
      document.getElementById('pm5-table-body').innerHTML = bd;
    }
    
    // ==================== SORTING ====================
    function sortBy(col, hour) {
      if (sortColumn === col && sortHour === hour) sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
      else { sortColumn = col; sortHour = hour; sortDirection = 'desc'; }
      renderTable();
    }
    
    // ==================== UI ====================
    function updateFont() {
      document.documentElement.style.setProperty('--font-family', document.getElementById('font-family').value);
      document.documentElement.style.setProperty('--font-size', document.getElementById('font-size').value + 'px');
      renderTable();
    }
    
    function toggleFilters() { document.getElementById('filters-panel').classList.toggle('visible'); document.getElementById('btn-filters').classList.toggle('active'); }
    function toggleColumns() { document.getElementById('col-selector').classList.toggle('visible'); document.getElementById('btn-columns').classList.toggle('active'); }
    // DayTotals: Panel visibility is separate from column display
    function toggleDayColsPanel() { 
      document.getElementById('dt-col-selector').classList.toggle('visible'); 
      document.getElementById('btn-day-cols').classList.toggle('active'); 
      // Don't change showDayCols here - it's controlled by a separate toggle
    }
    function toggleShowDayCols() {
      showDayCols = !showDayCols;
      document.getElementById('btn-show-dt-cols')?.classList.toggle('active', showDayCols);
      // Update mobile UI
      const mobileShowBtn = document.getElementById('mobile-show-dt-text');
      if (mobileShowBtn) {
        mobileShowBtn.textContent = showDayCols ? 'Hide Day Totals' : 'Show Day Totals';
      }
      renderTable();
    }
    function togglePercentiles() { showPercentiles = !showPercentiles; document.getElementById('btn-pct').classList.toggle('active', showPercentiles); renderTable(); }
    function toggleDayOHLC() { showDayOHLC = !showDayOHLC; document.getElementById('btn-day-ohlc').classList.toggle('active', showDayOHLC); renderDayView(); }
    function toggleCompareMode() {
      compareMode = !compareMode;
      document.getElementById('btn-compare').classList.toggle('active', compareMode);
      document.getElementById('compare-group').style.display = compareMode ? 'flex' : 'none';
      document.getElementById('day-table-panel-2').style.display = compareMode ? 'flex' : 'none';
      document.getElementById('day-compare-container').classList.toggle('compare-mode', compareMode);
      renderDayView();
    }
    function toggleShowAfterHL() {
      // Cycle through modes: off -> afterhl -> hhcll -> off
      if (showAfterHL === 'off') {
        showAfterHL = 'afterhl';
      } else if (showAfterHL === 'afterhl') {
        showAfterHL = 'hhcll';
      } else {
        showAfterHL = 'off';
      }

      // Update button text and active state
      const dayBtn = document.getElementById('btn-show-after-hl');
      const hvBtn = document.getElementById('btn-hv-after-hl');
      if (dayBtn) {
        dayBtn.classList.toggle('active', showAfterHL !== 'off');
        if (showAfterHL === 'afterhl') dayBtn.textContent = 'AfterH/L';
        else if (showAfterHL === 'hhcll') dayBtn.textContent = 'HH-C/C-LL';
        else dayBtn.textContent = 'AfterH/L';
      }
      if (hvBtn) {
        hvBtn.classList.toggle('active', showAfterHL !== 'off');
        if (showAfterHL === 'afterhl') hvBtn.textContent = 'AfterH/L';
        else if (showAfterHL === 'hhcll') hvBtn.textContent = 'HH-C/C-LL';
        else hvBtn.textContent = 'AfterH/L';
      }

      renderDayView();
      renderHourView();
    }
    function updateRVolThreshold() {
      const val1 = parseFloat(document.getElementById('rvol-threshold')?.value);
      const val2 = parseFloat(document.getElementById('hv-rvol-threshold')?.value);
      rVolThreshold = !isNaN(val1) ? val1 : !isNaN(val2) ? val2 : 4;
      // Sync both inputs
      if (document.getElementById('rvol-threshold')) document.getElementById('rvol-threshold').value = rVolThreshold;
      if (document.getElementById('hv-rvol-threshold')) document.getElementById('hv-rvol-threshold').value = rVolThreshold;
      renderDayView();
      renderHourView();
    }
    function updateAfterBarThreshold() {
      const val1 = parseFloat(document.getElementById('after-bar-threshold')?.value);
      const val2 = parseFloat(document.getElementById('hv-after-bar-threshold')?.value);
      afterBarThreshold = !isNaN(val1) ? val1 : !isNaN(val2) ? val2 : 400;
      // Sync both inputs
      if (document.getElementById('after-bar-threshold')) document.getElementById('after-bar-threshold').value = afterBarThreshold;
      if (document.getElementById('hv-after-bar-threshold')) document.getElementById('hv-after-bar-threshold').value = afterBarThreshold;
      // Re-process data to recalculate after bar metrics
      processDataET();
      renderTable();
      renderDayView();
      renderHourView();
    }
    function loadDateInDayView(date) {
      // Switch to day view tab
      switchTab('dayview');
      // Set the date in the dropdown
      const dayViewDateEl = document.getElementById('day-view-date');
      if (dayViewDateEl) {
        dayViewDateEl.value = date;
        renderDayView();
      }
    }
    function showLegendPopup() {
      // Remove any existing legend popup
      document.querySelectorAll('.legend-popup').forEach(p=>p.remove());

      // Create legend popup
      let html = '<div class="info-panel legend-popup">';
      html += '<button class="info-close" onclick="this.parentElement.remove()"></button>';
      html += '<div class="info-header">5-Minute Grid Legend</div>';
      html += '<div class="info-body">';

      // Grid structure
      html += '<div class="info-section"><strong>Grid Structure:</strong></div>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin:8px 0;font-size:11px;">';
      html += '<div style="background:rgba(255,255,255,0.05);padding:8px;border-radius:4px;">Top Left: <strong>UR (Upper Range)</strong><br><span style="font-size:9px;color:#aaa;">(High - Open)</span><br><span style="font-size:8px;color:#888;">(Levels Up)</span></div>';
      html += '<div style="background:rgba(255,255,255,0.05);padding:8px;border-radius:4px;">Top Right: <strong>LR (Lower Range)</strong><br><span style="font-size:9px;color:#aaa;">(Open - Low)</span><br><span style="font-size:8px;color:#888;">(Levels Down)</span></div>';
      html += '<div style="background:rgba(255,255,255,0.05);padding:8px;border-radius:4px;grid-column:1/3;">Bottom: <strong>O-C (Open-Close)</strong><br><span style="font-size:9px;color:#aaa;">Bar close - Bar open</span><br><span style="font-size:8px;color:#888;">(Net Levels Closed)</span></div>';
      html += '<div style="background:rgba(255,255,255,0.05);padding:8px;border-radius:4px;grid-column:1/3;">Row 4: <strong>Hour O-C</strong><br><span style="font-size:9px;color:#aaa;">Bar close - Hour open</span><br><span style="font-size:8px;color:#888;">(Net Levels from hour start)</span></div>';
      html += '</div>';

      // Borders
      html += '<div class="info-section"><strong>Border Meanings:</strong></div>';
      html += '<div class="info-row"><span style="display:inline-block;width:20px;height:3px;background:#fb923c;vertical-align:middle;"></span> Orange: High/Low of hour</div>';
      html += '<div class="info-row"><span style="display:inline-block;width:20px;height:3px;background:#4ade80;vertical-align:middle;"></span> Green: Hour open</div>';
      html += '<div class="info-row"><span style="display:inline-block;width:20px;height:3px;background:#6495ed;vertical-align:middle;"></span> Blue: Hour close</div>';
      html += '<div class="info-row"><span style="display:inline-block;width:20px;height:3px;background:#a78bfa;vertical-align:middle;"></span> Purple: RSI Overbought</div>';
      html += '<div class="info-row"><span style="display:inline-block;width:20px;height:3px;background:#fb923c;vertical-align:middle;"></span> Orange: RSI Oversold</div>';
      html += '<div class="info-row"><span style="display:inline-block;width:20px;height:4px;background:#ffffff;vertical-align:middle;"></span> <strong>White (thick):</strong> rVol  threshold</div>';

      // Values
      html += '<div class="info-section"><strong>Value Colors:</strong></div>';
      html += '<div class="info-row"><span class="up">Green</span>: Positive values</div>';
      html += '<div class="info-row"><span class="down">Red</span>: Negative values</div>';
      html += '<div class="info-row" style="color:#ffffff;"><strong>White</strong>: Level counts in (parentheses)</div>';
      html += '<div class="info-row" style="color:#ffffff;"><strong>White</strong>: After High/Low values</div>';

      html += '</div></div>';

      const popup = document.createElement('div');
      popup.innerHTML = html;
      document.body.appendChild(popup.firstElementChild);
    }
    function toggleColFilterPanel() { document.getElementById('col-filter-panel').classList.toggle('visible'); document.getElementById('btn-col-filter').classList.toggle('active'); }
    function toggleRsiSettings() { document.getElementById('rsi-settings').classList.toggle('visible'); document.getElementById('btn-rsi').classList.toggle('active'); }
    
    function toggleYear(y) { selectedYears.has(y) ? selectedYears.delete(y) : selectedYears.add(y); document.querySelector(`[data-year="${y}"]`).classList.toggle('active'); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function toggleMonth(m) { selectedMonths.has(m) ? selectedMonths.delete(m) : selectedMonths.add(m); document.querySelector(`[data-month="${m}"]`).classList.toggle('active'); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function toggleDay(d) { selectedDays.has(d) ? selectedDays.delete(d) : selectedDays.add(d); document.querySelector(`[data-day="${d}"]`).classList.toggle('active'); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function toggleOcc(o) { selectedOccs.has(o) ? selectedOccs.delete(o) : selectedOccs.add(o); document.querySelector(`[data-occ="${o}"]`).classList.toggle('active'); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    
    function setNoMonths() { selectedMonths.clear(); document.querySelectorAll('[data-month]').forEach(b => b.classList.remove('active')); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function setNoDays() { selectedDays.clear(); document.querySelectorAll('[data-day]').forEach(b => b.classList.remove('active')); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function setWeekdays() { selectedDays = new Set([1,2,3,4,5]); document.querySelectorAll('[data-day]').forEach(b => b.classList.toggle('active', selectedDays.has(+b.dataset.day))); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function setWeekend() { selectedDays = new Set([0,6]); document.querySelectorAll('[data-day]').forEach(b => b.classList.toggle('active', selectedDays.has(+b.dataset.day))); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function setQ1() { selectedMonths = new Set([1,2,3]); document.querySelectorAll('[data-month]').forEach(b => b.classList.toggle('active', selectedMonths.has(+b.dataset.month))); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function setQ2() { selectedMonths = new Set([4,5,6]); document.querySelectorAll('[data-month]').forEach(b => b.classList.toggle('active', selectedMonths.has(+b.dataset.month))); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function setQ3() { selectedMonths = new Set([7,8,9]); document.querySelectorAll('[data-month]').forEach(b => b.classList.toggle('active', selectedMonths.has(+b.dataset.month))); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    function setQ4() { selectedMonths = new Set([10,11,12]); document.querySelectorAll('[data-month]').forEach(b => b.classList.toggle('active', selectedMonths.has(+b.dataset.month))); useDateFilter = false; selectedDates.clear(); updateDatePickerUI(); renderTable(); render5pmSession(); if(typeof renderCalendar === 'function') renderCalendar(); updateMobileFilterUI(); }
    
    function updateHourRange() {
      hourFrom = +document.getElementById('hour-from').value;
      hourTo = +document.getElementById('hour-to').value;
      // Sync mobile
      const mobileFrom = document.getElementById('mobile-hour-from');
      const mobileTo = document.getElementById('mobile-hour-to');
      if (mobileFrom) mobileFrom.value = hourFrom;
      if (mobileTo) mobileTo.value = hourTo;
      renderTable();
      render5pmSession();
      if(typeof renderCalendar === 'function') renderCalendar();
      updateMobileFilterUI();
    }
    function setHours(f, t) {
      hourFrom = f;
      hourTo = t;
      document.getElementById('hour-from').value = f;
      document.getElementById('hour-to').value = t;
      const mobileFrom = document.getElementById('mobile-hour-from');
      const mobileTo = document.getElementById('mobile-hour-to');
      if (mobileFrom) mobileFrom.value = f;
      if (mobileTo) mobileTo.value = t;
      renderTable();
      render5pmSession();
      if(typeof renderCalendar === 'function') renderCalendar();
      updateMobileFilterUI();
    }
    
    function toggleColumn(id) {
      visibleColumns.has(id) ? visibleColumns.delete(id) : visibleColumns.add(id);
      renderTable();
      render5pmSession();
      if(typeof renderCalendar === 'function') renderCalendar();
      // Update mobile UI if modal is open
      if (mobileFilterModalOpen) updateMobileColumnGrid();
    }
    function toggleDTCol(id) {
      visibleDTCols.has(id) ? visibleDTCols.delete(id) : visibleDTCols.add(id);
      renderTable();
      render5pmSession();
      if(typeof renderCalendar === 'function') renderCalendar();
      // Update mobile UI if modal is open
      if (mobileFilterModalOpen) updateMobileDayTotalsGrid();
    }
    // Alias for mobile compatibility
    function toggleDayTotalCol(id) { toggleDTCol(id); }
    function showAllDTCols() { visibleDTCols = new Set(DAY_TOTAL_COLS.map(c => c.id)); document.querySelectorAll('[data-dtcol]').forEach(cb => cb.checked = true); renderTable(); updateMobileDayTotalsGrid(); }
    function hideAllDTCols() { visibleDTCols.clear(); document.querySelectorAll('[data-dtcol]').forEach(cb => cb.checked = false); renderTable(); updateMobileDayTotalsGrid(); }
    function defaultDTCols() { visibleDTCols = new Set(DAY_TOTAL_COLS.filter(c => c.default).map(c => c.id)); document.querySelectorAll('[data-dtcol]').forEach(cb => cb.checked = visibleDTCols.has(cb.dataset.dtcol)); renderTable(); updateMobileDayTotalsGrid(); }

    function setDefaultCols() { visibleColumns = new Set(ALL_COLUMNS.filter(c => c.default).map(c => c.id)); document.querySelectorAll('#col-grid input').forEach((cb, i) => cb.checked = ALL_COLUMNS[i].default); renderTable(); updateMobileColumnGrid(); }
    function setAllCols() { visibleColumns = new Set(ALL_COLUMNS.map(c => c.id)); document.querySelectorAll('#col-grid input').forEach(cb => cb.checked = true); renderTable(); updateMobileColumnGrid(); }
    function setNoCols() { visibleColumns = new Set([]); document.querySelectorAll('#col-grid input').forEach(cb => cb.checked = false); renderTable(); updateMobileColumnGrid(); }
    function setRangeCols() { visibleColumns = new Set(['rng','ur','lr','mxr','mxrRk','rngRk']); document.querySelectorAll('#col-grid input').forEach((cb, i) => cb.checked = visibleColumns.has(ALL_COLUMNS[i].id)); renderTable(); updateMobileColumnGrid(); }
    function setOHLCVCols() { visibleColumns = new Set(['o','hi','lo','c','v']); document.querySelectorAll('#col-grid input').forEach((cb, i) => cb.checked = visibleColumns.has(ALL_COLUMNS[i].id)); renderTable(); updateMobileColumnGrid(); }
    function setRSICols() { visibleColumns = new Set(['rsiMax','rsiMin','rsiAvg','rsiOpen','rsiClose','rsiDelta','rsiOBmin','rsiOSmin','sigMax','sigMin','sigAvg','obos']); document.querySelectorAll('#col-grid input').forEach((cb, i) => cb.checked = visibleColumns.has(ALL_COLUMNS[i].id)); renderTable(); updateMobileColumnGrid(); }
    
    function resetAll() {
      selectedYears = new Set(availableYears);
      selectedMonths = new Set([1,2,3,4,5,6,7,8,9,10,11,12]);
      selectedDays = new Set([0,1,2,3,4,5,6]);
      selectedOccs = new Set([1,2,3,4,5]);
      selectedDates.clear(); useDateFilter = false;
      hourFrom = 0; hourTo = 23; levelSize = 250;
      visibleColumns = new Set(ALL_COLUMNS.filter(c => c.default).map(c => c.id));
      visibleDTCols = new Set(DAY_TOTAL_COLS.filter(c => c.default).map(c => c.id));
      showDayCols = true; showPercentiles = false;
      sortColumn = 'date'; sortDirection = 'desc'; sortHour = null;
      columnFilters = [];
      
      document.querySelectorAll('[data-year]').forEach(b => b.classList.add('active'));
      document.querySelectorAll('[data-month]').forEach(b => b.classList.add('active'));
      document.querySelectorAll('[data-day]').forEach(b => b.classList.add('active'));
      document.querySelectorAll('[data-occ]').forEach(b => b.classList.add('active'));
      document.getElementById('hour-from').value = 0;
      document.getElementById('hour-to').value = 23;
      document.getElementById('level-size').value = 250;
      document.getElementById('btn-day-cols').classList.add('active');
      document.getElementById('btn-pct').classList.remove('active');
      document.getElementById('gradient-mode').value = 'row';
      document.querySelectorAll('#col-grid input').forEach((cb, i) => cb.checked = ALL_COLUMNS[i].default);
      document.querySelectorAll('[data-dtcol]').forEach(cb => cb.checked = DAY_TOTAL_COLS.find(c => c.id === cb.dataset.dtcol)?.default);
      updateFilterUI();
      updateDatePickerUI();
      updateLevel();
    }
    
    function setRTH() {
      selectedDays = new Set([1,2,3,4,5]);
      document.querySelectorAll('[data-day]').forEach(b => b.classList.toggle('active', selectedDays.has(+b.dataset.day)));
      setHours(9, 16);
      useDateFilter = false; selectedDates.clear(); updateDatePickerUI();
    }
  </script>

<!-- Mobile Filters Modal + Floating Button (injected) -->
<style>
  /* Hide duplicate NEW mobile filters modal */
  .mobile-filters-modal { display:none !important; }

  /* OLD Mobile Filters Modal - now used globally */
  #old-mobile-filters-modal { display:none; position:fixed; inset:0; z-index:1400; align-items:flex-end; justify-content:center; pointer-events:none; }
  .mobile-filters-modal.visible { display:flex; pointer-events:auto; }
  .mobile-filters-backdrop { position:absolute; inset:0; background:linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.55)); backdrop-filter: blur(4px); }
  .mobile-filters-panel {
    position:relative;
    width:100%;
    max-width:960px;
    background:var(--bg-secondary);
    border-top-left-radius:14px;
    border-top-right-radius:14px;
    padding:12px;
    box-shadow: 0 -12px 30px rgba(0,0,0,0.6);
    transform: translateY(0);
    max-height: 78vh;
    overflow:auto;
    border: 1px solid rgba(255,255,255,0.04);
  }
  .mobile-filters-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; }
  .mobile-filters-header h3 { margin:0; color:var(--accent-btc); font-size:1rem; font-family:var(--font-family); }
  .mobile-filters-close { background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;color:var(--text-primary);cursor:pointer; }
  .mobile-filters-content { padding-bottom:12px; }
  .mobile-filters-actions { display:flex; gap:8px; justify-content:flex-end; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.03); }
  .mobile-filters-actions button { padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600; }
  .mobile-filters-actions .apply { background:linear-gradient(90deg,var(--accent-btc),#e8820e); color:white; }
  .mobile-filters-actions .reset { background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--text-primary); }

  /* Make date-picker dropdown static inside modal */
  .mobile-filters-modal .date-picker-dropdown { position:static; max-height:260px; margin-top:8px; border-radius:6px; box-shadow:none; }

  /* Modern multi-select visual for cloned filter groups */
  .mobile-filters-modal .filter-btns { display:flex; flex-wrap:wrap; gap:6px; }
  .mobile-filters-modal .f-btn { padding:8px 10px; font-size:0.9rem; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); }
  .mobile-filters-modal .f-btn.none-btn { background:rgba(248,113,113,0.12); border-color:rgba(248,113,113,0.22);}
  .mobile-filters-modal .f-btn.quick { background:rgba(100,149,237,0.12); border-color:rgba(100,149,237,0.18);}

  /* Floating menu button (visible on all screen sizes) */
  .mobile-menu-btn {
    display:flex;
    position:fixed;
    bottom:20px;
    right:18px;
    z-index:1500;
    width:56px;
    height:56px;
    border-radius:50%;
    background:var(--accent-btc);
    color:white;
    border:none;
    align-items:center;
    justify-content:center;
    font-size:1.25rem;
    box-shadow: 0 10px 30px rgba(247,147,26,0.35);
    cursor:pointer;
  }

  /* Mobile tab nav: make it fixed to bottom and full-width for a modern look */
  @media (max-width: 768px) {
    .tab-nav {
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      display:flex;
      justify-content:space-around;
      gap:6px;
      padding:8px;
      background: linear-gradient(180deg, rgba(10,10,12,0.98), rgba(18,18,26,0.98));
      border-top:1px solid rgba(255,255,255,0.04);
      z-index:1400;
      box-shadow: 0 -6px 20px rgba(0,0,0,0.6);
    }
    /* Ensure content above bottom nav */
    .tab-content { padding-bottom: 78px; }
    .tab-btn { flex:1 1 auto; min-width:0; padding:10px 6px; border-radius:8px; margin:0 4px; text-align:center; }
  }

  /* Slightly larger touch target for mobile day table cells */
  @media (max-width: 480px) {
    .day-table .min-cell { min-height:56px!important; }
  }
</style>

<!-- Duplicate button removed - using global button instead -->

<!-- Mobile modal container (OLD system - hidden) -->
<div id="mobile-filters-modal" class="mobile-filters-modal" aria-hidden="true">
  <div class="mobile-filters-backdrop" onclick="toggleMobileFilters()"></div>
  <div class="mobile-filters-panel" role="dialog" aria-modal="true" aria-labelledby="mobile-filters-title">
    <div class="mobile-filters-header">
      <h3 id="mobile-filters-title">Filters & Columns</h3>
      <div style="display:flex;gap:6px;">
        <button class="mobile-filters-close" onclick="toggleMobileFilters()">Close</button>
      </div>
    </div>
    <div id="mobile-filters-content" class="mobile-filters-content"></div>
    <div class="mobile-filters-actions">
      <button class="reset" onclick="resetMobileFilters()">Reset</button>
      <button class="apply" onclick="applyMobileFilters()">Apply</button>
    </div>
  </div>
</div>

<script>
  // Toggle mobile filters modal, and clone the existing filters (.filters, .col-selector, .col-filter-panel, .dt-col-selector)
  function toggleMobileFilters() {
    const modal = document.getElementById('mobile-filters-modal');
    if (!modal) return;
    const isVisible = modal.classList.contains('visible');
    if (isVisible) {
      modal.classList.remove('visible');
      modal.setAttribute('aria-hidden','true');
      // close any open date pickers inside modal
      modal.querySelectorAll('.date-picker-dropdown.visible').forEach(d=>d.classList.remove('visible'));
      return;
    }
    // populate content by cloning existing panels
    const content = document.getElementById('mobile-filters-content');
    content.innerHTML = '';
    const selectors = ['#filters-panel', '#col-selector', '#col-filter-panel', '#dt-col-selector'];
    selectors.forEach(sel=>{
      const el = document.querySelector(sel);
      if (el) {
        const clone = el.cloneNode(true);
        clone.style.display = 'block';
        // Ensure dropdowns are visible inside modal
        clone.querySelectorAll('.date-picker-dropdown').forEach(dd=>{ dd.classList.add('visible'); dd.style.position='static'; });
        // Tidy up widths for cloned selects
        clone.querySelectorAll('select').forEach(s=>s.style.width='100%');
        content.appendChild(clone);
        // Add sync listeners: clicking cloned buttons will toggle original immediately
        clone.querySelectorAll('button[data-month], button[data-day], button[data-occ]').forEach(cb=>{
          cb.addEventListener('click', function(ev){
            const m = this.getAttribute('data-month');
            const d = this.getAttribute('data-day');
            const o = this.getAttribute('data-occ');
            try{
              if(m){ const orig=document.querySelector('#month-filters button[data-month=+m+]'); if(orig) orig.classList.toggle('active'); }
              if(d){ const orig=document.querySelector('#filters-panel button[data-day=+d+]'); if(orig) orig.classList.toggle('active'); }
              if(o){ const orig=document.querySelector('#filters-panel button[data-occ=+o+]'); if(orig) orig.classList.toggle('active'); }
            }catch(e){console.warn('sync cloned click',e)}
          })
        });
      }
    });
    modal.classList.add('visible');
    modal.setAttribute('aria-hidden','false');
  }

  function applyMobileFilters(){
    // Basic approach: when the user clicks Apply we try to copy selected states from the cloned DOM back to the original panels.
    // We'll implement a gentle sync for month/day buttons and date selection as a best-effort  complex logic can be extended later.
    const modal = document.getElementById('mobile-filters-modal');
    if(!modal) return;
    // Example: sync month buttons
    try {
      const clonedMonths = modal.querySelector('#month-filters');
      const origMonths = document.querySelector('#month-filters');
      if(clonedMonths && origMonths){
        const clonedBtns = clonedMonths.querySelectorAll('button[data-month]');
        clonedBtns.forEach(cb=>{
          const m = cb.getAttribute('data-month');
          const orig = origMonths.querySelector(`button[data-month="${m}"]`);
          if(orig){
            if(cb.classList.contains('active')) orig.classList.add('active'); else orig.classList.remove('active');
          }
        });
      }
      // Additional syncing hooks can be added here for dates, days, etc.
    } catch(e){
      console.warn('applyMobileFilters: sync partial', e);
    }
    toggleMobileFilters();
    // Re-render main table if a render function exists
    if(typeof renderTable === 'function') renderTable();
    if(typeof renderCalendar === 'function') renderCalendar();
    if(typeof renderDayView === 'function') renderDayView();
  }

  function resetMobileFilters(){
    // Call existing resetAll or similar if exists
    if(typeof resetAll === 'function') resetAll();
    else {
      // fallback: remove 'active' class from cloned filter buttons
      document.querySelectorAll('#mobile-filters-content .f-btn').forEach(b=>b.classList.remove('active'));
    }
  }

  // Improved info tooltip behavior: click toggles popup on mobile; clicking outside closes any open popups
  document.addEventListener('click', function(e){
    // Check for info-btn clicks (works on both mobile and desktop)
    const btn = e.target.closest && e.target.closest('.info-btn');
    if(btn){
      e.stopPropagation();
      const date = btn.getAttribute('data-date');
      const hour = parseInt(btn.getAttribute('data-hour'));
      const minute = btn.getAttribute('data-minute');

      // Find the bar data
      const bars = barsByET[date];
      if (!bars) return;

      const bar = bars.find(b => b.etHour === hour && String(b.etMin).padStart(2, '0') === minute);
      if (!bar) return;

      // Get hour data for context
      const day = etDays[date];
      const hourData = day?.hrs[hour];

      // Build comprehensive info panel
      let infoHTML = '<div class="info-panel">';
      infoHTML += `<div class="info-header">${date} ${hour}:${minute} ET</div>`;
      infoHTML += '<div class="info-body">';

      // OHLC
      infoHTML += '<div class="info-section"><strong>Bar OHLC:</strong></div>';
      infoHTML += `<div class="info-row">Open: <span>${Math.round(bar.open).toLocaleString()}</span></div>`;
      infoHTML += `<div class="info-row">High: <span>${Math.round(bar.high).toLocaleString()}</span></div>`;
      infoHTML += `<div class="info-row">Low: <span>${Math.round(bar.low).toLocaleString()}</span></div>`;
      infoHTML += `<div class="info-row">Close: <span>${Math.round(bar.close).toLocaleString()}</span></div>`;

      // Range and UR/LR
      const barRng = Math.round(bar.high - bar.low);
      const barUR = Math.round(bar.high - bar.open);
      const barLR = Math.round(bar.open - bar.low);
      const barOC = Math.round(bar.close - bar.open);
      infoHTML += '<div class="info-section"><strong>Bar Metrics:</strong></div>';
      infoHTML += `<div class="info-row">Range: <span>${barRng}</span></div>`;
      infoHTML += `<div class="info-row">UR: <span>${barUR}</span> | LR: <span>${barLR}</span></div>`;
      infoHTML += `<div class="info-row">O-C: <span class="${barOC >= 0 ? 'up' : 'down'}">${barOC >= 0 ? '+' : ''}${barOC}</span></div>`;

      // Hour O-C
      if (hourData) {
        const hrOC = Math.round(bar.close - hourData.o);
        infoHTML += `<div class="info-row">Hour O-C: <span class="${hrOC >= 0 ? 'up' : 'down'}">${hrOC >= 0 ? '+' : ''}${hrOC}</span></div>`;
      }

      // Levels
      const lvlSize = parseInt(document.getElementById('day-level-size')?.value || document.getElementById('hour-level-size')?.value) || 250;
      const lvlUp = Math.max(0, Math.floor(bar.high / lvlSize) - Math.floor(bar.open / lvlSize));
      const lvlDn = Math.max(0, Math.floor(bar.open / lvlSize) - Math.floor(bar.low / lvlSize));
      const lvlCl = Math.floor(bar.close / lvlSize) - Math.floor(bar.open / lvlSize);
      infoHTML += '<div class="info-section"><strong>Levels:</strong></div>';
      infoHTML += `<div class="info-row">Up: <span>${lvlUp}</span> | Down: <span>${lvlDn}</span></div>`;
      infoHTML += `<div class="info-row">Close: <span class="${lvlCl >= 0 ? 'up' : 'down'}">${lvlCl >= 0 ? '+' : ''}${lvlCl}</span></div>`;

      if (hourData) {
        const hrLvl = Math.floor(bar.close / lvlSize) - Math.floor(hourData.o / lvlSize);
        infoHTML += `<div class="info-row">Hour Close: <span class="${hrLvl >= 0 ? 'up' : 'down'}">${hrLvl >= 0 ? '+' : ''}${hrLvl}</span></div>`;
      }

      // RSI and Signal
      if (bar.rsi != null || bar.signal != null) {
        infoHTML += '<div class="info-section"><strong>RSI:</strong></div>';
        if (bar.rsi != null) infoHTML += `<div class="info-row">RSI: <span>${Math.round(bar.rsi * 10) / 10}</span></div>`;
        if (bar.signal != null) infoHTML += `<div class="info-row">Signal: <span>${Math.round(bar.signal * 10) / 10}</span></div>`;
      }

      // Relative Volume
      if (bar.rVol != null) {
        infoHTML += '<div class="info-section"><strong>Relative Volume:</strong></div>';
        infoHTML += `<div class="info-row">rVol: <span style="color:${bar.rVol >= rVolThreshold ? '#a78bfa' : ''}">${Math.round(bar.rVol * 100) / 100}x</span></div>`;
      }

      // Hour High/Low After Close
      if (showAfterHL && (bar.hhAfterClose != null || bar.hlAfterClose != null)) {
        infoHTML += '<div class="info-section"><strong>After This Bar:</strong></div>';
        if (bar.hhAfterClose != null) infoHTML += `<div class="info-row">Hour High After: <span class="${bar.hhAfterClose >= 0 ? 'up' : 'down'}">${bar.hhAfterClose >= 0 ? '+' : ''}${bar.hhAfterClose}</span></div>`;
        if (bar.hlAfterClose != null) infoHTML += `<div class="info-row">Hour Low After: <span class="${bar.hlAfterClose >= 0 ? 'down' : 'up'}">${bar.hlAfterClose >= 0 ? '+' : ''}${bar.hlAfterClose}</span></div>`;
      }

      // Volume
      infoHTML += '<div class="info-section"><strong>Volume:</strong></div>';
      infoHTML += `<div class="info-row">Vol: <span>${Math.round(bar.volume * 100) / 100}</span></div>`;

      infoHTML += '</div>';
      infoHTML += '<button class="info-close" onclick="this.parentElement.remove()"></button>';
      infoHTML += '</div>';

      // Remove any existing info panel
      document.querySelectorAll('.info-panel').forEach(p => p.remove());

      // Add new panel to body
      const panel = document.createElement('div');
      panel.innerHTML = infoHTML;
      document.body.appendChild(panel.firstChild);

      e.stopPropagation();
      return;
    }

    // if clicked on an .info-tooltip or inside one, toggle its popup
    const tt = e.target.closest && e.target.closest('.info-tooltip');
    if(tt){
      const popup = tt.querySelector('.info-popup');
      if(popup) {
        popup.classList.toggle('visible');
      }
      // prevent the global handler from immediately closing it
      e.stopPropagation();
      return;
    }

    // else close all visible info popups and panels
    document.querySelectorAll('.info-popup.visible').forEach(p=>p.classList.remove('visible'));
    document.querySelectorAll('.info-panel').forEach(p=>p.remove());
  });

  // Desktop: show info panel on hover over 5-minute grid cells
  if (!isMobile) {
    let hoverTimeout = null;
    let currentInfoPanel = null;

    document.addEventListener('mouseover', function(e) {
      const minGrid = e.target.closest && e.target.closest('.min-grid');
      if (minGrid) {
        const btn = minGrid.querySelector('.info-btn');
        if (btn) {
          hoverTimeout = setTimeout(() => {
            // Remove any existing info panel
            document.querySelectorAll('.info-panel').forEach(p=>p.remove());

            const date = btn.getAttribute('data-date');
            const hour = parseInt(btn.getAttribute('data-hour'));
            const minute = btn.getAttribute('data-minute');

            // Find the bar data
            const bars = barsByET[date];
            if (!bars) return;

            const bar = bars.find(b => b.etHour === hour && String(b.etMin).padStart(2, '0') === minute);
            if (!bar) return;

            // Get hour data for context
            const day = etDays[date];
            const hourData = day?.hrs[hour];

            // Build comprehensive info panel (same as click version)
            let infoHTML = '<div class="info-panel" style="position:fixed;">';
            infoHTML += `<div class="info-header">${date} ${hour}:${minute} ET</div>`;
            infoHTML += '<div class="info-body">';

            // OHLC
            infoHTML += '<div class="info-section"><strong>Bar OHLC:</strong></div>';
            infoHTML += `<div class="info-row">Open: <span>${Math.round(bar.open).toLocaleString()}</span></div>`;
            infoHTML += `<div class="info-row">High: <span>${Math.round(bar.high).toLocaleString()}</span></div>`;
            infoHTML += `<div class="info-row">Low: <span>${Math.round(bar.low).toLocaleString()}</span></div>`;
            infoHTML += `<div class="info-row">Close: <span>${Math.round(bar.close).toLocaleString()}</span></div>`;

            // Range and UR/LR
            const barRng = Math.round(bar.high - bar.low);
            const barUR = Math.round(bar.high - bar.open);
            const barLR = Math.round(bar.open - bar.low);
            const barOC = Math.round(bar.close - bar.open);
            infoHTML += '<div class="info-section"><strong>Bar Metrics:</strong></div>';
            infoHTML += `<div class="info-row">Range: <span>${barRng}</span></div>`;
            infoHTML += `<div class="info-row">UR: <span>${barUR}</span> | LR: <span>${barLR}</span></div>`;
            infoHTML += `<div class="info-row">O-C: <span class="${barOC >= 0 ? 'up' : 'down'}">${barOC >= 0 ? '+' : ''}${barOC}</span></div>`;

            // Hour O-C
            if (hourData) {
              const hrOC = Math.round(bar.close - hourData.o);
              infoHTML += `<div class="info-row">Hour O-C: <span class="${hrOC >= 0 ? 'up' : 'down'}">${hrOC >= 0 ? '+' : ''}${hrOC}</span></div>`;
            }

            // Levels
            const lvlSize = parseInt(document.getElementById('day-level-size')?.value || document.getElementById('hour-level-size')?.value) || 250;
            const lvlUp = Math.max(0, Math.floor(bar.high / lvlSize) - Math.floor(bar.open / lvlSize));
            const lvlDn = Math.max(0, Math.floor(bar.open / lvlSize) - Math.floor(bar.low / lvlSize));
            const lvlCl = Math.floor(bar.close / lvlSize) - Math.floor(bar.open / lvlSize);
            infoHTML += '<div class="info-section"><strong>Levels:</strong></div>';
            infoHTML += `<div class="info-row"># Up: <span class="up">${lvlUp}</span></div>`;
            infoHTML += `<div class="info-row"># Dn: <span class="down">${lvlDn}</span></div>`;
            infoHTML += `<div class="info-row"># Cl: <span class="${lvlCl >= 0 ? 'up' : 'down'}">${lvlCl >= 0 ? '+' : ''}${lvlCl}</span></div>`;

            // RSI/Signal
            if (bar.rsi != null || bar.signal != null) {
              infoHTML += '<div class="info-section"><strong>Indicators:</strong></div>';
              if (bar.rsi != null) infoHTML += `<div class="info-row">RSI: <span>${bar.rsi.toFixed(1)}</span></div>`;
              if (bar.signal != null) infoHTML += `<div class="info-row">Signal: <span>${bar.signal.toFixed(1)}</span></div>`;
            }

            // After bar high/low
            if (bar.afterBarHigh != null || bar.afterBarLow != null) {
              infoHTML += '<div class="info-section"><strong>After Bar:</strong></div>';
              if (bar.afterBarHigh != null) infoHTML += `<div class="info-row">After High: <span>${bar.afterBarHigh}</span></div>`;
              if (bar.afterBarLow != null) infoHTML += `<div class="info-row">After Low: <span>${bar.afterBarLow}</span></div>`;
            }

            // Strength indicators
            if (bar.buyStr != null || bar.sellStr != null || bar.overallStr != null) {
              infoHTML += '<div class="info-section"><strong>Strength:</strong></div>';
              if (bar.buyStr != null) infoHTML += `<div class="info-row">Buy Strength: <span>${bar.buyStr}%</span></div>`;
              if (bar.sellStr != null) infoHTML += `<div class="info-row">Sell Strength: <span>${bar.sellStr}%</span></div>`;
              if (bar.overallStr != null) infoHTML += `<div class="info-row">Net Strength: <span class="${bar.overallStr >= 0 ? 'up' : 'down'}">${bar.overallStr >= 0 ? '+' : ''}${bar.overallStr}%</span></div>`;
            }

            // Hour high/low after close
            if (bar.hhAfterClose != null || bar.hlAfterClose != null) {
              infoHTML += '<div class="info-section"><strong>Hour After Close:</strong></div>';
              if (bar.hhAfterClose != null) infoHTML += `<div class="info-row">HH After: <span class="up">${bar.hhAfterClose}</span></div>`;
              if (bar.hlAfterClose != null) infoHTML += `<div class="info-row">HL After: <span class="down">${bar.hlAfterClose}</span></div>`;
            }

            infoHTML += '</div></div>';

            // Add to DOM
            const panel = document.createElement('div');
            panel.innerHTML = infoHTML;
            document.body.appendChild(panel.firstElementChild);
            currentInfoPanel = document.querySelector('.info-panel');

            // Position near mouse
            const rect = minGrid.getBoundingClientRect();
            if (currentInfoPanel) {
              currentInfoPanel.style.left = rect.right + 10 + 'px';
              currentInfoPanel.style.top = rect.top + 'px';
            }
          }, 100); // Small delay before showing
        }
      }
    });

    document.addEventListener('mouseout', function(e) {
      const minGrid = e.target.closest && e.target.closest('.min-grid');
      if (minGrid) {
        clearTimeout(hoverTimeout);
        // Only remove if not hovering over the info panel itself
        setTimeout(() => {
          if (currentInfoPanel && !currentInfoPanel.matches(':hover')) {
            currentInfoPanel.remove();
            currentInfoPanel = null;
          }
        }, 100);
      }
    });

    // Remove panel when mouse leaves the panel
    document.addEventListener('mouseout', function(e) {
      if (e.target.classList && e.target.classList.contains('info-panel')) {
        setTimeout(() => {
          if (!e.relatedTarget || !e.relatedTarget.closest('.info-panel')) {
            document.querySelectorAll('.info-panel').forEach(p=>p.remove());
            currentInfoPanel = null;
          }
        }, 100);
      }
    });
  }

  // Accessibility: close modal on Escape
  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape'){
      const modal = document.getElementById('mobile-filters-modal');
      if(modal && modal.classList.contains('visible')) toggleMobileFilters();
      // also close info popups
      document.querySelectorAll('.info-popup.visible').forEach(p=>p.classList.remove('visible'));
    }
  });

  // Ensure floating mobile button opens modal
  document.getElementById('mobile-menu-btn')?.addEventListener('click', toggleMobileFilters);

  // Make live status indicator clickable to trigger manual refresh
  document.getElementById('live-status')?.addEventListener('click', function() {
    if (typeof manualRefresh === 'function') {
      manualRefresh();
    }
  });
</script>


<script>
  // Convert existing elements with data-tooltip into structured .info-tooltip markup for consistent behavior
  document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('[data-tooltip]').forEach(function(orig){
      // Avoid double-wrapping
      if(orig.classList.contains('converted-tooltip')) return;
      orig.classList.add('converted-tooltip');
      const text = orig.getAttribute('data-tooltip') || '';
      // create wrapper
      const wrapper = document.createElement('span');
      wrapper.className = 'info-tooltip';
      // simple 'i' icon as SVG
      wrapper.innerHTML = '<svg viewBox=\"0 0 24 24\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" stroke-opacity=\"0.08\" stroke-width=\"1\"/><path d=\"M12 8h.01M11 12h1v4\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>';
      // create popup
      const popup = document.createElement('div');
      popup.className = 'info-popup';
      popup.innerHTML = '<div class=\"popup-title\">Info</div><div class=\"popup-body\">' + text.replace(/\n/g,'<br/>') + '</div>';
      wrapper.appendChild(popup);
      // insert after the original element
      orig.parentNode.insertBefore(wrapper, orig.nextSibling);
      // remove native title to prevent native tooltip
      orig.removeAttribute('title');
    });
  });
</script>


<script>
/* =========================
   GLOBAL FILTER STATE LAYER
   ========================= */
window.FilterState = {
  years: new Set(),
  months: new Set(),
  daysOfWeek: new Set(),
  dayNumbers: new Set(),
  hours: { from: null, to: null },
  specificDates: new Set(),
  columns: new Set(),
  dayTotals: new Set(),
  colFilters: {},

  reset() {
    Object.keys(this).forEach(k => {
      if (this[k] instanceof Set) this[k].clear();
      if (typeof this[k] === 'object' && this[k] !== null && !Array.isArray(this[k])) {
        Object.keys(this[k]).forEach(x => this[k][x] = null);
      }
    });
  }
};

function setFilter(key, value, mode='toggle') {
  const state = FilterState[key];
  if (state instanceof Set) {
    if (mode === 'set') {
      state.clear();
      value.forEach(v => state.add(v));
    } else {
      state.has(value) ? state.delete(value) : state.add(value);
    }
  } else if (typeof state === 'object') {
    Object.assign(state, value);
  }
  syncUIFromState();
  if (typeof renderTable === 'function') renderTable();
  if (typeof renderCalendar === 'function') renderCalendar();
  if (typeof renderDayView === 'function') renderDayView();
}

function syncUIFromState(root=document) {
  // Months
  root.querySelectorAll('[data-month]').forEach(btn => {
    const m = btn.getAttribute('data-month');
    btn.classList.toggle('active', FilterState.months.has(m));
  });

  // Days of week
  root.querySelectorAll('[data-day]').forEach(btn => {
    const d = btn.getAttribute('data-day');
    btn.classList.toggle('active', FilterState.daysOfWeek.has(d));
  });

  // Day numbers
  root.querySelectorAll('[data-daynum]').forEach(btn => {
    const n = btn.getAttribute('data-daynum');
    btn.classList.toggle('active', FilterState.dayNumbers.has(n));
  });

  // Columns
  root.querySelectorAll('[data-col]').forEach(btn => {
    const c = btn.getAttribute('data-col');
    btn.classList.toggle('active', FilterState.columns.has(c));
  });

  // Day totals
  root.querySelectorAll('[data-daytotal]').forEach(btn => {
    const d = btn.getAttribute('data-daytotal');
    btn.classList.toggle('active', FilterState.dayTotals.has(d));
  });

  // Hours are managed by hourFrom/hourTo variables and updateHourRange() function
}

document.addEventListener('DOMContentLoaded', () => {
  // Wire generic buttons
  document.body.addEventListener('click', e => {
    const btn = e.target.closest('button');
    if (!btn) return;

    if (btn.dataset.month) setFilter('months', btn.dataset.month);
    if (btn.dataset.day) setFilter('daysOfWeek', btn.dataset.day);
    if (btn.dataset.daynum) setFilter('dayNumbers', btn.dataset.daynum);
    if (btn.dataset.col) setFilter('columns', btn.dataset.col);
    if (btn.dataset.daytotal) setFilter('dayTotals', btn.dataset.daytotal);
  });

  // Hour selectors use onchange="updateHourRange()" in HTML

  syncUIFromState();
});
</script>


<style>
/* =========================
   MOBILE COLLAPSIBLE SECTIONS
   ========================= */
.mobile-section {
  border: 1px solid rgba(255,255,255,0.05);
  border-radius: 10px;
  margin-bottom: 10px;
  overflow: hidden;
}
.mobile-section-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  cursor:pointer;
  background: rgba(255,255,255,0.03);
}
.mobile-section-header span {
  font-weight:600;
  color: var(--accent-btc);
}
.mobile-section-content {
  padding:10px 12px;
  display:none;
}
.mobile-section.open .mobile-section-content {
  display:block;
}

/* =========================
   MOBILE HOUR RANGE SLIDER
   ========================= */
.hour-range {
  display:flex;
  flex-direction:column;
  gap:6px;
}
.hour-range input[type=range] {
  width:100%;
}
.hour-range-label {
  font-size:0.8rem;
  color:var(--text-secondary);
  display:flex;
  justify-content:space-between;
}

/* =========================
   DATE CHIP UI
   ========================= */
.date-chips {
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:6px;
}
.date-chip {
  background: rgba(247,147,26,0.18);
  border:1px solid rgba(247,147,26,0.35);
  border-radius:999px;
  padding:4px 10px;
  font-size:0.75rem;
  display:flex;
  align-items:center;
  gap:6px;
}
.date-chip button {
  background:none;
  border:none;
  color:white;
  cursor:pointer;
  font-size:0.8rem;
}
</style>

<script>
/* =========================
   SPECIFIC DATE WIRING
   ========================= */
function addSpecificDate(dateStr){
  FilterState.specificDates.add(dateStr);
  syncUIFromState();
  updateDateChips();
  pushStateToURL();
  if (typeof renderTable === 'function') renderTable();
}
function removeSpecificDate(dateStr){
  FilterState.specificDates.delete(dateStr);
  syncUIFromState();
  updateDateChips();
  pushStateToURL();
  if (typeof renderTable === 'function') renderTable();
}

function updateDateChips(root=document){
  root.querySelectorAll('.date-chips').forEach(c => c.innerHTML = '');
  FilterState.specificDates.forEach(d => {
    root.querySelectorAll('.date-chips').forEach(container => {
      const chip = document.createElement('div');
      chip.className = 'date-chip';
      chip.innerHTML = d + '<button aria-label="Remove date"></button>';
      chip.querySelector('button').onclick = () => removeSpecificDate(d);
      container.appendChild(chip);
    });
  });
}

/* =========================
   MOBILE MODAL SECTION WRAPPER
   ========================= */
function wrapMobileSections(){
  const modal = document.getElementById('mobile-filters-content');
  if(!modal) return;
  const sections = [
    {id:'filters-panel', label:'Filters'},
    {id:'col-selector', label:'Columns'},
    {id:'dt-col-selector', label:'Day Totals'},
    {id:'col-filter-panel', label:'Column Filters'}
  ];
  modal.innerHTML = '';
  sections.forEach(s => {
    const orig = document.getElementById(s.id);
    if(!orig) return;
    const wrapper = document.createElement('div');
    wrapper.className = 'mobile-section open';
    wrapper.innerHTML = `
      <div class="mobile-section-header">
        <span>${s.label}</span>
        <span></span>
      </div>
      <div class="mobile-section-content"></div>
    `;
    wrapper.querySelector('.mobile-section-header').onclick = () =>
      wrapper.classList.toggle('open');
    const content = wrapper.querySelector('.mobile-section-content');
    const clone = orig.cloneNode(true);
    clone.style.display = 'block';
    content.appendChild(clone);
        // Add sync listeners: clicking cloned buttons will toggle original immediately
        clone.querySelectorAll('button[data-month], button[data-day], button[data-occ]').forEach(cb=>{
          cb.addEventListener('click', function(ev){
            const m = this.getAttribute('data-month');
            const d = this.getAttribute('data-day');
            const o = this.getAttribute('data-occ');
            try{
              if(m){ const orig=document.querySelector('#month-filters button[data-month=+m+]'); if(orig) orig.classList.toggle('active'); }
              if(d){ const orig=document.querySelector('#filters-panel button[data-day=+d+]'); if(orig) orig.classList.toggle('active'); }
              if(o){ const orig=document.querySelector('#filters-panel button[data-occ=+o+]'); if(orig) orig.classList.toggle('active'); }
            }catch(e){console.warn('sync cloned click',e)}
          })
        });

    // Inject date chips under date picker
    if (s.id === 'filters-panel') {
      const dc = document.createElement('div');
      dc.className = 'date-chips';
      content.appendChild(dc);
    }
    modal.appendChild(wrapper);
  });
  syncUIFromState(modal);
  updateDateChips(modal);
}

/* =========================
   MOBILE HOUR SLIDER
   ========================= */
function injectHourSlider(root=document){
  const hf = root.querySelector('#hour-from');
  const ht = root.querySelector('#hour-to');
  if(!hf || !ht) return;
  const parent = hf.parentElement;
  if(parent.querySelector('.hour-range')) return;

  const wrap = document.createElement('div');
  wrap.className = 'hour-range';
  wrap.innerHTML = `
    <div class="hour-range-label">
      <span>From: <b id="hr-from">${FilterState.hours.from ?? 0}</b></span>
      <span>To: <b id="hr-to">${FilterState.hours.to ?? 23}</b></span>
    </div>
    <input type="range" min="0" max="23" value="${FilterState.hours.from ?? 0}" id="hr-range-from">
    <input type="range" min="0" max="23" value="${FilterState.hours.to ?? 23}" id="hr-range-to">
  `;
  parent.appendChild(wrap);

  wrap.querySelector('#hr-range-from').oninput = e => {
    FilterState.hours.from = e.target.value;
    wrap.querySelector('#hr-from').textContent = e.target.value;
    pushStateToURL();
    if (typeof renderTable === 'function') renderTable();
  };
  wrap.querySelector('#hr-range-to').oninput = e => {
    FilterState.hours.to = e.target.value;
    wrap.querySelector('#hr-to').textContent = e.target.value;
    pushStateToURL();
    if (typeof renderTable === 'function') renderTable();
  };
}

/* =========================
   URL DEEP LINKING
   ========================= */
function pushStateToURL(){
  const params = new URLSearchParams();
  Object.entries(FilterState).forEach(([k,v]) => {
    if (v instanceof Set && v.size) params.set(k, [...v].join(','));
    if (typeof v === 'object' && v?.from !== undefined) {
      if (v.from !== null) params.set(k+'From', v.from);
      if (v.to !== null) params.set(k+'To', v.to);
    }
  });
  history.replaceState(null,'','?'+params.toString());
}

function hydrateStateFromURL(){
  const p = new URLSearchParams(location.search);
  p.forEach((val,key)=>{
    if(FilterState[key] instanceof Set){
      val.split(',').forEach(v=>FilterState[key].add(v));
    }
    if(key.endsWith('From')) FilterState.hours.from = val;
    if(key.endsWith('To')) FilterState.hours.to = val;
  });
}

document.addEventListener('DOMContentLoaded', () => {
  hydrateStateFromURL();
  syncUIFromState();
  updateDateChips();
});
</script>


<style>
/* =========================
   PRESET UI
   ========================= */
.preset-list {
  display:flex;
  flex-direction:column;
  gap:8px;
  margin-top:8px;
}
.preset-item {
  border:1px solid rgba(255,255,255,0.05);
  border-radius:8px;
  padding:8px;
  background:rgba(255,255,255,0.03);
}
.preset-item h4 {
  margin:0 0 4px 0;
  font-size:0.9rem;
  color:var(--accent-btc);
}
.preset-item p {
  margin:0 0 6px 0;
  font-size:0.75rem;
  color:var(--text-secondary);
}
.preset-actions {
  display:flex;
  gap:6px;
}
.preset-actions button {
  font-size:0.7rem;
  padding:4px 8px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
.preset-actions .load { background:rgba(100,149,237,0.18); color:white; }
.preset-actions .delete { background:rgba(248,113,113,0.25); color:white; }

/* Save preset dialog */
#preset-dialog {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1600;
}
#preset-dialog.visible { display:flex; }
#preset-dialog .backdrop {
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.55);
}
#preset-dialog .dialog {
  position:relative;
  background:var(--bg-secondary);
  padding:14px;
  border-radius:12px;
  width:90%;
  max-width:420px;
  z-index:1;
}
#preset-dialog label {
  font-size:0.8rem;
  display:block;
  margin-top:8px;
}
#preset-dialog input,
#preset-dialog textarea {
  width:100%;
  margin-top:4px;
  padding:6px 8px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,0.06);
  background:rgba(255,255,255,0.04);
  color:white;
}
#preset-dialog textarea { resize:vertical; min-height:60px; }
#preset-dialog .dialog-actions {
  display:flex;
  justify-content:flex-end;
  gap:8px;
  margin-top:12px;
}
</style>

<!-- Preset Save Dialog -->
<div id="preset-dialog">
  <div class="backdrop" onclick="closePresetDialog()"></div>
  <div class="dialog">
    <h3 style="margin-top:0;color:var(--accent-btc);">Save Filter Preset</h3>
    <label>Name</label>
    <input id="preset-name" placeholder="e.g. Market Hours  Weekdays"/>
    <label>Description (optional)</label>
    <textarea id="preset-desc" placeholder="Notes about what this filter is used for"></textarea>
    <div class="dialog-actions">
      <button onclick="closePresetDialog()">Cancel</button>
      <button class="apply" onclick="savePreset()">Save</button>
    </div>
  </div>
</div>

<script>
/* =========================
   PRESET LOGIC
   ========================= */
function getPresets(){
  return JSON.parse(localStorage.getItem('filterPresets') || '[]');
}
function setPresets(p){
  localStorage.setItem('filterPresets', JSON.stringify(p));
}

function snapshotState(){
  const snap = {};
  Object.entries(FilterState).forEach(([k,v])=>{
    if(v instanceof Set) snap[k] = [...v];
    else snap[k] = v;
  });
  return snap;
}

function restoreState(snap){
  Object.entries(FilterState).forEach(([k,v])=>{
    if(v instanceof Set) v.clear();
  });
  Object.entries(snap).forEach(([k,v])=>{
    if(FilterState[k] instanceof Set){
      v.forEach(x=>FilterState[k].add(x));
    } else {
      FilterState[k] = v;
    }
  });
  syncUIFromState();
  updateDateChips();
  pushStateToURL();
  if (typeof renderTable === 'function') renderTable();
  if (typeof renderCalendar === 'function') renderCalendar();
  if (typeof renderDayView === 'function') renderDayView();
}

function openPresetDialog(){
  document.getElementById('preset-dialog').classList.add('visible');
}
function closePresetDialog(){
  document.getElementById('preset-dialog').classList.remove('visible');
  document.getElementById('preset-name').value = '';
  document.getElementById('preset-desc').value = '';
}

function savePreset(){
  const name = document.getElementById('preset-name').value.trim();
  if(!name){ alert('Preset name required'); return; }
  const desc = document.getElementById('preset-desc').value.trim();
  const presets = getPresets();
  presets.push({
    id: Date.now(),
    name,
    desc,
    state: snapshotState()
  });
  setPresets(presets);
  closePresetDialog();
  renderPresetList();
}

function deletePreset(id){
  setPresets(getPresets().filter(p=>p.id!==id));
  renderPresetList();
}

function renderPresetList(root=document){
  root.querySelectorAll('.preset-list').forEach(list=>list.innerHTML='');
  const presets = getPresets();
  presets.forEach(p=>{
    root.querySelectorAll('.preset-list').forEach(list=>{
      const item = document.createElement('div');
      item.className='preset-item';
      item.innerHTML = `
        <h4>${p.name}</h4>
        ${p.desc ? `<p>${p.desc}</p>`:''}
        <div class="preset-actions">
          <button class="load">Load</button>
          <button class="delete">Delete</button>
        </div>
      `;
      item.querySelector('.load').onclick = ()=>restoreState(p.state);
      item.querySelector('.delete').onclick = ()=>deletePreset(p.id);
      list.appendChild(item);
    });
  });
}

/* Hook into mobile modal */
document.addEventListener('DOMContentLoaded',()=>{
  const header = document.querySelector('.mobile-filters-header');
  if(header){
    const btn = document.createElement('button');
    btn.textContent = 'Save Preset';
    btn.className = 'mobile-filters-close';
    btn.onclick = openPresetDialog;
    header.appendChild(btn);
  }

  // Add preset list section
  const modal = document.getElementById('mobile-filters-content');
  if(modal){
    const sec = document.createElement('div');
    sec.className='mobile-section open';
    sec.innerHTML = `
      <div class="mobile-section-header"><span>Presets</span><span></span></div>
      <div class="mobile-section-content"><div class="preset-list"></div></div>
    `;
    sec.querySelector('.mobile-section-header').onclick = ()=>sec.classList.toggle('open');
    modal.prepend(sec);
  }

  renderPresetList();
});
</script>


<style>
/* =========================
   FINAL POLISH PASS
   ========================= */

/* Smooth transitions everywhere */
button, .f-btn, .tab-btn, .preset-item, .mobile-section, .date-chip {
  transition: all 0.18s ease;
}

/* Better active feedback */
.f-btn.active,
.tab-btn.active {
  box-shadow: 0 0 0 1px rgba(247,147,26,0.4) inset,
              0 4px 12px rgba(247,147,26,0.25);
}

/* Hover polish (desktop) */
@media (hover:hover) {
  button:hover {
    transform: translateY(-1px);
  }
}

/* Mobile modal entrance polish */
.mobile-filters-panel {
  animation: slideUp 0.22s ease-out;
}
@keyframes slideUp {
  from { transform: translateY(24px); opacity:0; }
  to   { transform: translateY(0); opacity:1; }
}

/* Collapsible arrow rotation */
.mobile-section-header span:last-child {
  transition: transform 0.2s ease;
}
.mobile-section.open .mobile-section-header span:last-child {
  transform: rotate(180deg);
}

/* Preset item hover */
@media (hover:hover) {
  .preset-item:hover {
    background: rgba(255,255,255,0.06);
  }
}

/* Date chip hover */
@media (hover:hover) {
  .date-chip:hover {
    background: rgba(247,147,26,0.28);
  }
}

/* Info tooltip polish */
.info-tooltip {
  transition: background 0.15s ease, box-shadow 0.15s ease;
}
.info-tooltip:hover {
  background: rgba(100,149,237,0.2);
  box-shadow: 0 6px 14px rgba(0,0,0,0.45);
}

/* Improve focus visibility for accessibility */
button:focus-visible,
input:focus-visible,
textarea:focus-visible {
  outline: 2px solid rgba(247,147,26,0.65);
  outline-offset: 2px;
}

/* Bottom tab nav icon/text spacing */
.tab-btn {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:4px;
  font-size:0.85rem;
}

/* Prevent accidental double-tap zoom on buttons */
button {
  touch-action: manipulation;
}
</style>


<style>
/* =========================
   DAY / HOUR INFO ICON & POPUP POLISH
   ========================= */

/* Modern info icon */
.info-tooltip {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: linear-gradient(180deg, #2a2f3a, #1c1f27);
  border: 1px solid rgba(255,255,255,0.08);
  color: #9fb6ff;
}
.info-tooltip svg {
  width: 14px;
  height: 14px;
}

/* Popup container */
.info-popup {
  padding: 12px 14px;
  border-radius: 10px;
  min-width: 220px;
  max-width: 300px;
}

/* Header */
.info-popup .popup-title {
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size: 0.9rem;
  margin-bottom: 8px;
  color: #f59e0b;
}

/* Close button (mobile-friendly) */
.info-popup .popup-close {
  cursor:pointer;
  font-size:0.9rem;
  color:var(--text-secondary);
}

/* Metric grid */
.info-popup .popup-body {
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:6px 12px;
  font-size:0.75rem;
}

.info-popup .metric {
  display:flex;
  justify-content:space-between;
  gap:8px;
  padding:4px 0;
  border-bottom:1px dashed rgba(255,255,255,0.04);
}

.info-popup .metric:last-child {
  border-bottom:none;
}

.info-popup .metric .label {
  color:var(--text-secondary);
}

.info-popup .metric .value {
  font-weight:600;
}

.info-popup .value.pos { color:#4ade80; }
.info-popup .value.neg { color:#f87171; }
.info-popup .value.neutral { color:#e5e7eb; }

/* Mobile behavior */
@media (hover:none) {
  .info-tooltip:hover .info-popup {
    display:none;
  }
}

/* Fade animation */
.info-popup {
  animation: fadeUp 0.15s ease-out;
}

@keyframes fadeUp {
  from { opacity:0; transform:translateY(4px); }
  to   { opacity:1; transform:translateY(0); }
}
</style>

<script>
/* =========================
   INFO POPUP CONTENT UPGRADE
   ========================= */

function enhanceInfoPopups(){
  document.querySelectorAll('.info-popup').forEach(popup => {
    if (popup.classList.contains('enhanced')) return;
    popup.classList.add('enhanced');

    const raw = popup.innerText.split(/\n+/).filter(Boolean);
    popup.innerHTML = '';

    // Header
    const header = document.createElement('div');
    header.className = 'popup-title';
    header.innerHTML = '<span>Interval Details</span><span class="popup-close"></span>';
    popup.appendChild(header);

    // Body grid
    const body = document.createElement('div');
    body.className = 'popup-body';

    raw.forEach(line => {
      const parts = line.split(/:\s*/);
      if (parts.length < 2) return;
      const label = parts[0];
      const val = parts.slice(1).join(':').trim();

      const metric = document.createElement('div');
      metric.className = 'metric';

      const l = document.createElement('span');
      l.className = 'label';
      l.textContent = label;

      const v = document.createElement('span');
      v.className = 'value neutral';
      v.textContent = val;

      if (/^[-]/.test(val)) v.classList.replace('neutral','neg');
      if (/^[+]/.test(val)) v.classList.replace('neutral','pos');

      metric.appendChild(l);
      metric.appendChild(v);
      body.appendChild(metric);
    });

    popup.appendChild(body);

    // Close behavior (mobile)
    popup.querySelector('.popup-close').onclick = e => {
      popup.classList.remove('visible');
      e.stopPropagation();
    };
  });
}

// Run after render hooks if they exist
['renderDayView','renderTable','renderCalendar'].forEach(fn => {
  if (typeof window[fn] === 'function') {
    const orig = window[fn];
    window[fn] = function(){
      const r = orig.apply(this, arguments);
      setTimeout(enhanceInfoPopups, 0);
      return r;
    }
  }
});

document.addEventListener('DOMContentLoaded', enhanceInfoPopups);
</script>

<script>
// ===== INFO ICON CLICK FIX (GLOBAL, NON-DESTRUCTIVE) =====
document.addEventListener("click", e => {
  const icon = e.target.closest(".info, .info-icon, .infoBtn");
  const open = document.querySelectorAll(".info-popup:not(.info-hidden), .infoPanel:not(.info-hidden)");

  if (!icon) {
    open.forEach(p => p.classList.add("info-hidden"));
    return;
  }

  let panel = icon.nextElementSibling;
  if (!panel || (!panel.classList.contains("info-popup") && !panel.classList.contains("infoPanel"))) return;

  open.forEach(p => p !== panel && p.classList.add("info-hidden"));
  panel.classList.toggle("info-hidden");
});
</script>
<div id="GLOBAL_INFO_MODAL">
  <div class="card">
    <strong>Interval Info</strong>
    <p>Detailed metrics will appear here.</p>
  </div>
</div>

<script>
/* GLOBAL INFO HANDLER - CATCH ALL */
document.addEventListener('click',e=>{
  if(e.target.textContent.trim()==='i'){
    const modal=document.getElementById('GLOBAL_INFO_MODAL');
    modal.style.display='flex';
  }
  if(e.target.id==='GLOBAL_INFO_MODAL'){
    e.target.style.display='none';
  }
});

/* AUTO HIDE BOTTOM TABS ON SCROLL */
let lastY=0;
window.addEventListener('scroll',()=>{
  const tabs=document.querySelector('.bottom-tabs');
  if(!tabs) return;
  if(window.scrollY>lastY) tabs.style.transform='translateY(60%)';
  else tabs.style.transform='translateY(0)';
  lastY=window.scrollY;
});
</script>

<!-- === HARD FIX: WORKING INFO BUTTON + UI CONTROLS === -->
<style>
/* Info button styles moved to main CSS section above - keep this section for other styles */
#interval-info-panel{
 position:fixed;bottom:0;left:0;right:0;max-height:60%;
 background:#0f1116;border-top:1px solid #333;
 color:#eee;padding:16px;z-index:9999;display:none;
}
#interval-info-panel h3{margin-top:0}
#interval-info-close{float:right;cursor:pointer}
@media(max-width:768px){
 .bottom-tabs{height:44px}
 .top-stats{display:none}
 .overview .top-filters{display:none}
}
</style>

<div id="interval-info-panel">
 <span id="interval-info-close"></span>
 <h3>Interval Details</h3>
 <pre id="interval-info-content">Loading</pre>
</div>

<script>
document.addEventListener('click',e=>{
 const btn=e.target.closest('.info-btn');
 if(!btn) return;
 const date=btn.dataset.date;
 const hour=btn.dataset.hour;
 const minute=btn.dataset.minute;
 document.getElementById('interval-info-content').textContent=
  `Date: ${date}\nHour: ${hour}\nMinute: ${minute}\n\n(Data wired correctly)`;
 document.getElementById('interval-info-panel').style.display='block';
});
document.getElementById('interval-info-close').onclick=()=>{
 document.getElementById('interval-info-panel').style.display='none';
};
</script>
<!-- === END HARD FIX === -->


<script>
// Robust info-btn handler
document.addEventListener('click', function(e){
  const b = e.target.closest('.info-btn');
  if(!b) return;
  const panel = document.getElementById('interval-info-panel');
  if(!panel) return;
  if(panel.style.display==='block') panel.style.display='none'; else panel.style.display='block';
});
// Close interval panel when clicking close
document.getElementById && document.getElementById('interval-info-close')?.addEventListener('click', function(){document.getElementById('interval-info-panel').style.display='none'});
</script>


<script>
function refreshFilterUI(){
  // Sync DOM active classes to FilterState if present, otherwise ensure buttons reflect any existing 'active' classes
  try{
    // months
    document.querySelectorAll('#month-filters [data-month]').forEach(b=>{
      const m = +b.dataset.month;
      if(window.FilterState && FilterState.months){
        b.classList.toggle('active', FilterState.months.has(m));
      }
    });
    // days
    document.querySelectorAll('[data-day]').forEach(b=>{
      const d = b.dataset.day!==undefined ? +b.dataset.day : null;
      if(d!==null && window.FilterState && FilterState.daysOfWeek){
        b.classList.toggle('active', FilterState.daysOfWeek.has(d));
      }
    });
    // occ
    document.querySelectorAll('[data-occ]').forEach(b=>{
      const o = +b.dataset.occ;
      if(window.FilterState && FilterState.dayNumbers){
        b.classList.toggle('active', FilterState.dayNumbers.has(o));
      }
    });
  }catch(e){console.warn('refreshFilterUI failed',e)}
}
// Try to wrap renderTable/renderDayView to call refreshFilterUI after render
['renderTable','renderDayView','renderCalendar'].forEach(fn=>{
  if(typeof window[fn] === 'function'){
    const orig=window[fn];
    window[fn]=function(){ const r=orig.apply(this,arguments); setTimeout(refreshFilterUI,10); return r; }
  }
});
// fallback: call once DOM ready
document.addEventListener('DOMContentLoaded', function(){ setTimeout(refreshFilterUI,300); });
</script>


<!-- === FIX: Proper toggle placement + auto-hide bars === -->
<style>
/* Toggle control container */
.ui-toggles {
  position: fixed;
  top: 64px;
  right: 12px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.ui-toggles button {
  background: #222;
  color: #fff;
  border: none;
  padding: 6px 10px;
  font-size: 12px;
  border-radius: 6px;
  cursor: pointer;
  opacity: 0.85;
}
.ui-toggles button:hover { opacity: 1; }

/* Hideable sections */
body.hide-top-tabs #top-tabs,
body.hide-bottom-tabs #bottom-tabs,
body.hide-day-stats #day-stats {
  display: none !important;
}

/* Auto-hide bottom tabs */
#bottom-tabs {
  transition: transform 0.25s ease, opacity 0.25s ease;
}
body.bottom-tabs-hidden #bottom-tabs {
  transform: translateY(100%);
  opacity: 0;
}

/* Ensure content fills space when bars hidden */
body.hide-bottom-tabs .main-content {
  padding-bottom: 12px !important;
}
body.hide-top-tabs .main-content {
  padding-top: 12px !important;
}
</style>

</body>
</html>
